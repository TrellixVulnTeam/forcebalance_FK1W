<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ForceBalance API: molecule.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance API
   &#160;<span id="projectnumber">1.3</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">molecule.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="molecule_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html">    1</a></span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> copy</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> imp</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> itertools</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">import</span> os</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">import</span> re</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">import</span> sys</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">import</span> sysconfig</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">import</span> json</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict, namedtuple, Counter</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">from</span> ctypes <span class="keyword">import</span> *</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">from</span> datetime <span class="keyword">import</span> date</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> warnings <span class="keyword">import</span> warn</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">from</span> numpy <span class="keyword">import</span> sin, cos, arccos</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> multi_dot</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">from</span> pkg_resources <span class="keyword">import</span> parse_version</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"># For Python 3 compatibility</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="keyword">from</span> itertools <span class="keyword">import</span> zip_longest <span class="keyword">as</span> zip_longest</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    <span class="keyword">from</span> itertools <span class="keyword">import</span> izip_longest <span class="keyword">as</span> zip_longest</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"># For Python 2 backwards-compatibility</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a24a2611c587c2e6cf9597e87bdeba703">   31</a></span>&#160;    input = raw_input</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keywordflow">except</span> NameError:</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="keywordflow">pass</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"># Special error which is thrown when TINKER .arc data is detected in a .xyz file</span></div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1ActuallyArcError.html">   36</a></span>&#160;<span class="keyword">class </span><a class="code" href="classsrc_1_1molecule_1_1ActuallyArcError.html">ActuallyArcError</a>(IOError):</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keywordflow">pass</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"># ======================================================================#</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"># |              Chemical file format conversion module                |#</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"># |                Lee-Ping Wang (leeping@ucdavis.edu)                 |#</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"># |                    Last updated March 31, 2019                     |#</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"># |   This code is part of ForceBalance and is covered under the       |#</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"># |   ForceBalance copyright notice and 3-clause BSD license.          |#</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"># |   Please see https://github.com/leeping/forcebalance for details.  |#</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"># |   Feedback and suggestions are encouraged.                         |#</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"># |   What this is for:                                                |#</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"># |   Converting a molecule between file formats                       |#</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"># |   Loading and processing of trajectories                           |#</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"># |   (list of geometries for the same set of atoms)                   |#</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"># |   Concatenating or slicing trajectories                            |#</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"># |   Combining molecule metadata (charge, Q-Chem rem variables)       |#</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment"># |   Supported file formats:                                          |#</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"># |   See the __init__ method in the Molecule class.                   |#</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"># |   Note to self / developers:                                       |#</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment"># |   Please make this file as standalone as possible                  |#</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"># |   (i.e. don&#39;t introduce dependencies).  If we load an external     |#</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"># |   library to parse a file, do so with &#39;try / except&#39; so that       |#</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"># |   the module is still usable even if certain parts are missing.    |#</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment"># |   It&#39;s better to be like a Millennium Falcon. :P                   |#</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"># |   At present, when I perform operations like adding two objects,   |#</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment"># |   the sum is created from deep copies of data members in the       |#</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"># |   originals. This is because copying by reference is confusing;    |#</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment"># |   suppose if I do B += A and modify something in B; it should not  |#</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment"># |   change in A.                                                     |#</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment"># |   A consequence of this is that data members should not be too     |#</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"># |   complicated; they should be things like lists or dicts, and NOT  |#</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"># |   contain references to themselves.                                |#</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"># |   To-do list: Handling of comments is still not very good.         |#</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment"># |   Comments from previous files should be &#39;passed on&#39; better.       |#</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment"># |              Contents of this file:                                |#</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"># |              0) Names of data variables                            |#</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment"># |              1) Imports                                            |#</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment"># |              2) Subroutines                                        |#</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment"># |              3) Molecule class                                     |#</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment"># |                a) Class customizations (add, getitem)              |#</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"># |                b) Instantiation                                    |#</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"># |                c) Core functionality (read, write)                 |#</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment"># |                d) Reading functions                                |#</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment"># |                e) Writing functions                                |#</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment"># |                f) Extra stuff                                      |#</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment"># |              4) &quot;main&quot; function (if executed)                      |#</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment"># |                   Required: Python 2.7 or 3.6                      |#</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"># |                             (2.6, 3.5 and earlier untested)        |#</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"># |                             NumPy 1.6                              |#</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment"># |                   Optional: Mol2, PDB, DCD readers                 |#</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"># |                    (can be found in ForceBalance)                  |#</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"># |                    NetworkX package (for topologies)               |#</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"># |             Thanks: Todd Dolinsky, Yong Huang,                     |#</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"># |                     Kyle Beauchamp (PDB)                           |#</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"># |                     John Stone (DCD Plugin)                        |#</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"># |                     Pierre Tuffery (Mol2 Plugin)                   |#</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"># |                     #python IRC chat on FreeNode                   |#</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"># |             Contributors: Leah Isseroff Bendavid                   |#</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"># |                           Yudong Qiu                               |#</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"># |             Instructions:                                          |#</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"># |               To import:                                           |#</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment"># |                 from molecule import Molecule                      |#</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment"># |               To create a Molecule object:                         |#</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment"># |                 MyMol = Molecule(fnm)                              |#</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment"># |               To convert to a new file format:                     |#</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment"># |                 MyMol.write(&#39;newfnm.format&#39;)                       |#</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment"># |               To concatenate geometries:                           |#</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"># |                 MyMol += MyMolB                                    |#</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment"># |                                                                    |#</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"># ======================================================================#</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment"># =========================================#</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"># |     DECLARE VARIABLE NAMES HERE       |#</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment"># |                                       |#</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment"># |  Any member variable in the Molecule  |#</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment"># | class must be declared here otherwise |#</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment"># | the Molecule class won&#39;t recognize it |#</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment"># =========================================#</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"># | Data attributes in FrameVariableNames |#</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment"># | must be a list along the frame axis,  |#</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment"># | and they must have the same length.   |#</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment"># =========================================#</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment"># xyzs       = List of arrays of atomic xyz coordinates</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment"># comms      = List of comment strings</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment"># boxes      = List of 3-element or 9-element arrays for periodic boxes</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment"># qm_grads   = List of arrays of gradients (i.e. negative of the atomistic forces) from QM calculations</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment"># qm_espxyzs = List of arrays of xyz coordinates for ESP evaluation</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"># qm_espvals = List of arrays of ESP values</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"># qm_zpe     = Zero point energy, kcal/mol (from a qchem freq calculation)</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"># qm_entropy = Entropy contribution at STP, cal/mol.K (from a qchem freq calculation)</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment"># qm_enthalpy= Enthalpic contribution at STP, excluding electronic energy and ZPE, kcal/mol (from a qchem freq calculation)</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a16f4e1ba169d954ce12d9217c121305f">  145</a></span>&#160;FrameVariableNames = {<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;comms&#39;</span>, <span class="stringliteral">&#39;boxes&#39;</span>, <span class="stringliteral">&#39;qm_hessians&#39;</span>, <span class="stringliteral">&#39;qm_grads&#39;</span>, <span class="stringliteral">&#39;qm_energies&#39;</span>, <span class="stringliteral">&#39;qm_interaction&#39;</span>,</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                      <span class="stringliteral">&#39;qm_espxyzs&#39;</span>, <span class="stringliteral">&#39;qm_espvals&#39;</span>, <span class="stringliteral">&#39;qm_extchgs&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>, <span class="stringliteral">&#39;qm_zpe&#39;</span>,</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                      <span class="stringliteral">&#39;qm_entropy&#39;</span>, <span class="stringliteral">&#39;qm_enthalpy&#39;</span>, <span class="stringliteral">&#39;qm_bondorder&#39;</span>}</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">#=========================================#</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">#| Data attributes in AtomVariableNames  |#</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">#| must be a list along the atom axis,   |#</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">#| and they must have the same length.   |#</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">#=========================================#</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"># elem       = List of elements</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"># partial_charge = List of atomic partial charges</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"># atomname   = List of atom names (can come from MM coordinate file)</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"># atomtype   = List of atom types (can come from MM force field)</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"># tinkersuf  = String that comes after the XYZ coordinates in TINKER .xyz or .arc files</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"># resid      = Residue IDs (can come from MM coordinate file)</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"># resname    = Residue names</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment"># terminal   = List of true/false denoting whether this atom is followed by a terminal group.</span></div><div class="line"><a name="l00161"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a3c3c0e8c5e0c2a020713e1d7beba5269">  161</a></span>&#160;AtomVariableNames = {<span class="stringliteral">&#39;elem&#39;</span>, <span class="stringliteral">&#39;partial_charge&#39;</span>, <span class="stringliteral">&#39;atomname&#39;</span>, <span class="stringliteral">&#39;atomtype&#39;</span>, <span class="stringliteral">&#39;tinkersuf&#39;</span>, <span class="stringliteral">&#39;resid&#39;</span>, <span class="stringliteral">&#39;resname&#39;</span>, <span class="stringliteral">&#39;qcsuf&#39;</span>,</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                     <span class="stringliteral">&#39;qm_ghost&#39;</span>, <span class="stringliteral">&#39;chain&#39;</span>, <span class="stringliteral">&#39;altloc&#39;</span>, <span class="stringliteral">&#39;icode&#39;</span>, <span class="stringliteral">&#39;terminal&#39;</span>}</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">#=========================================#</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">#| This can be any data attribute we     |#</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">#| want but it&#39;s usually some property   |#</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">#| of the molecule not along the frame   |#</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">#| atom axis.                            |#</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">#=========================================#</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment"># bonds      = A list of 2-tuples representing bonds.  Carefully pruned when atom subselection is done.</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment"># fnm        = The file name that the class was built from</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment"># qcrems     = The Q-Chem &#39;rem&#39; variables stored as a list of OrderedDicts</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment"># qctemplate = The Q-Chem template file, not including the coordinates or rem variables</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment"># charge     = The net charge of the molecule</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment"># mult       = The spin multiplicity of the molecule</span></div><div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a4c6798b828fd919cc79a5d8193e8928a">  175</a></span>&#160;MetaVariableNames = {<span class="stringliteral">&#39;fnm&#39;</span>, <span class="stringliteral">&#39;ftype&#39;</span>, <span class="stringliteral">&#39;qcrems&#39;</span>, <span class="stringliteral">&#39;qctemplate&#39;</span>, <span class="stringliteral">&#39;qcerr&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>, <span class="stringliteral">&#39;bonds&#39;</span>, <span class="stringliteral">&#39;topology&#39;</span>,</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                     <span class="stringliteral">&#39;molecules&#39;</span>}</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment"># Variable names relevant to quantum calculations explicitly</span></div><div class="line"><a name="l00178"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a63e784c5358f77bcf929f5f5a312b845">  178</a></span>&#160;QuantumVariableNames = {<span class="stringliteral">&#39;qcrems&#39;</span>, <span class="stringliteral">&#39;qctemplate&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>, <span class="stringliteral">&#39;qcsuf&#39;</span>, <span class="stringliteral">&#39;qm_ghost&#39;</span>, <span class="stringliteral">&#39;qm_bondorder&#39;</span>}</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment"># Superset of all variable names.</span></div><div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a9b73a8b86c4764462fb2c724062624a9">  180</a></span>&#160;AllVariableNames = QuantumVariableNames | AtomVariableNames | MetaVariableNames | FrameVariableNames</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">#================================#</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">#       Set up the logger        #</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">#================================#</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keywordflow">if</span> <span class="stringliteral">&quot;forcebalance&quot;</span> <span class="keywordflow">in</span> __name__:</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="comment"># If this module is part of ForceBalance, use the package level logger</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keyword">from</span> .output <span class="keyword">import</span> *</div><div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a9af903d1a1ea8401cdc4c872a088ce48">  189</a></span>&#160;    package = <span class="stringliteral">&quot;ForceBalance&quot;</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordflow">elif</span> <span class="stringliteral">&quot;geometric&quot;</span> <span class="keywordflow">in</span> __name__:</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="comment"># This ensures logging behavior is consistent with the rest of geomeTRIC</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">from</span> .nifty <span class="keyword">import</span> logger</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    package = <span class="stringliteral">&quot;geomeTRIC&quot;</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment"># Previous default behavior if FB package level loggers could not be imported</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keyword">from</span> logging <span class="keyword">import</span> *</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keyword">class </span><a class="code" href="classsrc_1_1molecule_1_1RawStreamHandler.html">RawStreamHandler</a>(StreamHandler):</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;Exactly like output.StreamHandler except it does no extra formatting</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="stringliteral">        before sending logging messages to the stream. This is more compatible with</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="stringliteral">        how output has been displayed in ForceBalance. Default stream has also been</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="stringliteral">        changed from stderr to stdout&quot;&quot;&quot;</span></div><div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1RawStreamHandler.html">  202</a></span>&#160;        <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1RawStreamHandler.html#a5f47165f46eee9c11ddea1826faaa55c">__init__</a>(self, stream = sys.stdout):</div><div class="line"><a name="l00203"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1RawStreamHandler.html#a5f47165f46eee9c11ddea1826faaa55c">  203</a></span>&#160;            super(RawStreamHandler, self).<a class="code" href="classsrc_1_1molecule_1_1RawStreamHandler.html#a5f47165f46eee9c11ddea1826faaa55c">__init__</a>(stream)</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1RawStreamHandler.html#a7994595f5f16fe262528c67505ad4a0e">emit</a>(self, record):</div><div class="line"><a name="l00206"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1RawStreamHandler.html#a7994595f5f16fe262528c67505ad4a0e">  206</a></span>&#160;            message = record.getMessage()</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            self.stream.write(message)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            self.flush()</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment"># logger=getLogger()</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment"># logger.handlers = [RawStreamHandler(sys.stdout)]</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment"># LPW: Daniel Smith suggested the below four lines to improve logger behavior</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    logger = getLogger(<span class="stringliteral">&quot;MoleculeLogger&quot;</span>)</div><div class="line"><a name="l00213"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a3d3f329e9dbef8c64d056e17c705fe32">  213</a></span>&#160;    logger.setLevel(INFO)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    handler = <a class="code" href="classsrc_1_1molecule_1_1RawStreamHandler.html">RawStreamHandler</a>()</div><div class="line"><a name="l00215"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#abab499318f0c74dd01f75494c609e720">  215</a></span>&#160;    logger.addHandler(handler)</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        package = <span class="stringliteral">&quot;LPW-molecule.py&quot;</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        package = __name__.split(<span class="stringliteral">&#39;.&#39;</span>)[0]</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;module_name = __name__.replace(<span class="stringliteral">&#39;.molecule&#39;</span>,<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l00222"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#ad5301fb2ee3b4c9aa0be3dba89f2d30e">  222</a></span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment"># Covalent radii from Cordero et al. &#39;Covalent radii revisited&#39; Dalton Transactions 2008, 2832-2838.</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;Radii = [0.31, 0.28, <span class="comment"># H and He</span></div><div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#ab6553bc53f79f232d164e967d5162157">  225</a></span>&#160;         1.28, 0.96, 0.84, 0.76, 0.71, 0.66, 0.57, 0.58, <span class="comment"># First row elements</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;         0.00, 1.41, 1.21, 1.11, 1.07, 1.05, 1.02, 1.06, <span class="comment"># Second row elements</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;         <span class="comment"># 1.66, 1.41, 1.21, 1.11, 1.07, 1.05, 1.02, 1.06, # Second row elements</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;         2.03, 1.76, 1.70, 1.60, 1.53, 1.39, 1.61, 1.52, 1.50,</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;         1.24, 1.32, 1.22, 1.22, 1.20, 1.19, 1.20, 1.20, 1.16, <span class="comment"># Third row elements, K through Kr</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;         2.20, 1.95, 1.90, 1.75, 1.64, 1.54, 1.47, 1.46, 1.42,</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;         1.39, 1.45, 1.44, 1.42, 1.39, 1.39, 1.38, 1.39, 1.40, <span class="comment"># Fourth row elements, Rb through Xe</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;         2.44, 2.15, 2.07, 2.04, 2.03, 2.01, 1.99, 1.98,</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;         1.98, 1.96, 1.94, 1.92, 1.92, 1.89, 1.90, 1.87, <span class="comment"># Fifth row elements, s and f blocks</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;         1.87, 1.75, 1.70, 1.62, 1.51, 1.44, 1.41, 1.36,</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;         1.36, 1.32, 1.45, 1.46, 1.48, 1.40, 1.50, 1.50, <span class="comment"># Fifth row elements, d and p blocks</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;         2.60, 2.21, 2.15, 2.06, 2.00, 1.96, 1.90, 1.87, 1.80, 1.69] <span class="comment"># Sixth row elements</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment"># A list that gives you the element if you give it the atomic number, hence the &#39;none&#39; at the front.</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;Elements = [<span class="stringliteral">&quot;None&quot;</span>,<span class="stringliteral">&#39;H&#39;</span>,<span class="stringliteral">&#39;He&#39;</span>,</div><div class="line"><a name="l00240"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a74a6a037671072655c4747c6d3c3173f">  240</a></span>&#160;            <span class="stringliteral">&#39;Li&#39;</span>,<span class="stringliteral">&#39;Be&#39;</span>,<span class="stringliteral">&#39;B&#39;</span>,<span class="stringliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;N&#39;</span>,<span class="stringliteral">&#39;O&#39;</span>,<span class="stringliteral">&#39;F&#39;</span>,<span class="stringliteral">&#39;Ne&#39;</span>,</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            <span class="stringliteral">&#39;Na&#39;</span>,<span class="stringliteral">&#39;Mg&#39;</span>,<span class="stringliteral">&#39;Al&#39;</span>,<span class="stringliteral">&#39;Si&#39;</span>,<span class="stringliteral">&#39;P&#39;</span>,<span class="stringliteral">&#39;S&#39;</span>,<span class="stringliteral">&#39;Cl&#39;</span>,<span class="stringliteral">&#39;Ar&#39;</span>,</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <span class="stringliteral">&#39;K&#39;</span>,<span class="stringliteral">&#39;Ca&#39;</span>,<span class="stringliteral">&#39;Sc&#39;</span>,<span class="stringliteral">&#39;Ti&#39;</span>,<span class="stringliteral">&#39;V&#39;</span>,<span class="stringliteral">&#39;Cr&#39;</span>,<span class="stringliteral">&#39;Mn&#39;</span>,<span class="stringliteral">&#39;Fe&#39;</span>,<span class="stringliteral">&#39;Co&#39;</span>,<span class="stringliteral">&#39;Ni&#39;</span>,<span class="stringliteral">&#39;Cu&#39;</span>,<span class="stringliteral">&#39;Zn&#39;</span>,<span class="stringliteral">&#39;Ga&#39;</span>,<span class="stringliteral">&#39;Ge&#39;</span>,<span class="stringliteral">&#39;As&#39;</span>,<span class="stringliteral">&#39;Se&#39;</span>,<span class="stringliteral">&#39;Br&#39;</span>,<span class="stringliteral">&#39;Kr&#39;</span>,</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <span class="stringliteral">&#39;Rb&#39;</span>,<span class="stringliteral">&#39;Sr&#39;</span>,<span class="stringliteral">&#39;Y&#39;</span>,<span class="stringliteral">&#39;Zr&#39;</span>,<span class="stringliteral">&#39;Nb&#39;</span>,<span class="stringliteral">&#39;Mo&#39;</span>,<span class="stringliteral">&#39;Tc&#39;</span>,<span class="stringliteral">&#39;Ru&#39;</span>,<span class="stringliteral">&#39;Rh&#39;</span>,<span class="stringliteral">&#39;Pd&#39;</span>,<span class="stringliteral">&#39;Ag&#39;</span>,<span class="stringliteral">&#39;Cd&#39;</span>,<span class="stringliteral">&#39;In&#39;</span>,<span class="stringliteral">&#39;Sn&#39;</span>,<span class="stringliteral">&#39;Sb&#39;</span>,<span class="stringliteral">&#39;Te&#39;</span>,<span class="stringliteral">&#39;I&#39;</span>,<span class="stringliteral">&#39;Xe&#39;</span>,</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="stringliteral">&#39;Cs&#39;</span>,<span class="stringliteral">&#39;Ba&#39;</span>,<span class="stringliteral">&#39;La&#39;</span>,<span class="stringliteral">&#39;Ce&#39;</span>,<span class="stringliteral">&#39;Pr&#39;</span>,<span class="stringliteral">&#39;Nd&#39;</span>,<span class="stringliteral">&#39;Pm&#39;</span>,<span class="stringliteral">&#39;Sm&#39;</span>,<span class="stringliteral">&#39;Eu&#39;</span>,<span class="stringliteral">&#39;Gd&#39;</span>,<span class="stringliteral">&#39;Tb&#39;</span>,<span class="stringliteral">&#39;Dy&#39;</span>,<span class="stringliteral">&#39;Ho&#39;</span>,<span class="stringliteral">&#39;Er&#39;</span>,<span class="stringliteral">&#39;Tm&#39;</span>,<span class="stringliteral">&#39;Yb&#39;</span>,</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            <span class="stringliteral">&#39;Lu&#39;</span>,<span class="stringliteral">&#39;Hf&#39;</span>,<span class="stringliteral">&#39;Ta&#39;</span>,<span class="stringliteral">&#39;W&#39;</span>,<span class="stringliteral">&#39;Re&#39;</span>,<span class="stringliteral">&#39;Os&#39;</span>,<span class="stringliteral">&#39;Ir&#39;</span>,<span class="stringliteral">&#39;Pt&#39;</span>,<span class="stringliteral">&#39;Au&#39;</span>,<span class="stringliteral">&#39;Hg&#39;</span>,<span class="stringliteral">&#39;Tl&#39;</span>,<span class="stringliteral">&#39;Pb&#39;</span>,<span class="stringliteral">&#39;Bi&#39;</span>,<span class="stringliteral">&#39;Po&#39;</span>,<span class="stringliteral">&#39;At&#39;</span>,<span class="stringliteral">&#39;Rn&#39;</span>,</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            <span class="stringliteral">&#39;Fr&#39;</span>,<span class="stringliteral">&#39;Ra&#39;</span>,<span class="stringliteral">&#39;Ac&#39;</span>,<span class="stringliteral">&#39;Th&#39;</span>,<span class="stringliteral">&#39;Pa&#39;</span>,<span class="stringliteral">&#39;U&#39;,&#39;</span>Np&#39;,&#39;Pu&#39;,&#39;Am&#39;,&#39;Cm&#39;,&#39;Bk&#39;,&#39;Cf&#39;,&#39;Es&#39;,&#39;Fm&#39;,&#39;Md&#39;,&#39;No&#39;,&#39;Lr&#39;,&#39;Rf&#39;,&#39;Db&#39;,&#39;Sg&#39;,&#39;Bh&#39;,&#39;Hs&#39;,&#39;Mt&#39;]</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment"># Dictionary of atomic masses ; also serves as the list of elements (periodic table)</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment"># Atomic mass data was updated on 2020-05-07 from NIST:</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="comment"># &quot;Atomic Weights and Isotopic Compositions with Relative Atomic Masses&quot;</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment"># https://www.nist.gov/pml/atomic-weights-and-isotopic-compositions-relative-atomic-masses</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment"># using All Elements -&gt; preformatted ASCII table.</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment"># The standard atomic weight was provided in several different formats:</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment"># Two numbers in brackets as in [1.00784,1.00811] : The average value of the two limits is used.</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment"># With parentheses(uncert) as in 4.002602(2) : The parentheses was split off and all significant digits are used.</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment"># A single number in brackets as in [98] : The single number was used</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment"># Not provided (for Am, Z=95 and up): The mass number of the lightest isotope was used</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;PeriodicTable = OrderedDict([(<span class="stringliteral">&quot;H&quot;</span>, 1.007975), (<span class="stringliteral">&quot;He&quot;</span>, 4.002602), <span class="comment"># First row</span></div><div class="line"><a name="l00261"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a9104a499383cefd53789d767a08472b3">  261</a></span>&#160;                             (<span class="stringliteral">&quot;Li&quot;</span>, 6.9675), (<span class="stringliteral">&quot;Be&quot;</span>, 9.0121831), (<span class="stringliteral">&quot;B&quot;</span>, 10.8135), (<span class="stringliteral">&quot;C&quot;</span>, 12.0106), (<span class="stringliteral">&quot;N&quot;</span>, 14.006855), (<span class="stringliteral">&quot;O&quot;</span>, 15.99940), (<span class="stringliteral">&quot;F&quot;</span>, 18.99840316), (<span class="stringliteral">&quot;Ne&quot;</span>, 20.1797), <span class="comment"># Second row Li-Ne</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                             (<span class="stringliteral">&quot;Na&quot;</span>, 22.98976928), (<span class="stringliteral">&quot;Mg&quot;</span>, 24.3055), (<span class="stringliteral">&quot;Al&quot;</span>, 26.9815385), (<span class="stringliteral">&quot;Si&quot;</span>, 28.085), (<span class="stringliteral">&quot;P&quot;</span>, 30.973762), (<span class="stringliteral">&quot;S&quot;</span>, 32.0675), (<span class="stringliteral">&quot;Cl&quot;</span>, 35.4515), (<span class="stringliteral">&quot;Ar&quot;</span>, 39.948), <span class="comment"># Third row Na-Ar</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                             (<span class="stringliteral">&quot;K&quot;</span>, 39.0983), (<span class="stringliteral">&quot;Ca&quot;</span>, 40.078), (<span class="stringliteral">&quot;Sc&quot;</span>, 44.955908), (<span class="stringliteral">&quot;Ti&quot;</span>, 47.867), (<span class="stringliteral">&quot;V&quot;</span>, 50.9415), (<span class="stringliteral">&quot;Cr&quot;</span>, 51.9961), (<span class="stringliteral">&quot;Mn&quot;</span>, 54.938044), (<span class="stringliteral">&quot;Fe&quot;</span>, 55.845), (<span class="stringliteral">&quot;Co&quot;</span>, 58.933194), <span class="comment"># Fourth row K-Kr</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                             (<span class="stringliteral">&quot;Ni&quot;</span>, 58.6934), (<span class="stringliteral">&quot;Cu&quot;</span>, 63.546), (<span class="stringliteral">&quot;Zn&quot;</span>, 65.38), (<span class="stringliteral">&quot;Ga&quot;</span>, 69.723), (<span class="stringliteral">&quot;Ge&quot;</span>, 72.63), (<span class="stringliteral">&quot;As&quot;</span>, 74.921595), (<span class="stringliteral">&quot;Se&quot;</span>, 78.971), (<span class="stringliteral">&quot;Br&quot;</span>, 79.904), (<span class="stringliteral">&quot;Kr&quot;</span>, 83.798),</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                             (<span class="stringliteral">&quot;Rb&quot;</span>, 85.4678), (<span class="stringliteral">&quot;Sr&quot;</span>, 87.62), (<span class="stringliteral">&quot;Y&quot;</span>, 88.90584), (<span class="stringliteral">&quot;Zr&quot;</span>, 91.224), (<span class="stringliteral">&quot;Nb&quot;</span>, 92.90637), (<span class="stringliteral">&quot;Mo&quot;</span>, 95.95), (<span class="stringliteral">&quot;Tc&quot;</span>, 98.), (<span class="stringliteral">&quot;Ru&quot;</span>, 101.07), (<span class="stringliteral">&quot;Rh&quot;</span>, 102.9055), <span class="comment"># Fifth row Rb-Xe</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                             (<span class="stringliteral">&quot;Pd&quot;</span>, 106.42), (<span class="stringliteral">&quot;Ag&quot;</span>, 107.8682), (<span class="stringliteral">&quot;Cd&quot;</span>, 112.414), (<span class="stringliteral">&quot;In&quot;</span>, 114.818), (<span class="stringliteral">&quot;Sn&quot;</span>, 118.71), (<span class="stringliteral">&quot;Sb&quot;</span>, 121.76), (<span class="stringliteral">&quot;Te&quot;</span>, 127.6), (<span class="stringliteral">&quot;I&quot;</span>, 126.90447), (<span class="stringliteral">&quot;Xe&quot;</span>, 131.293),</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                             (<span class="stringliteral">&quot;Cs&quot;</span>, 132.905452), (<span class="stringliteral">&quot;Ba&quot;</span>, 137.327), (<span class="stringliteral">&quot;La&quot;</span>, 138.90547), (<span class="stringliteral">&quot;Ce&quot;</span>, 140.116), (<span class="stringliteral">&quot;Pr&quot;</span>, 140.90766), (<span class="stringliteral">&quot;Nd&quot;</span>, 144.242), (<span class="stringliteral">&quot;Pm&quot;</span>, 145.), (<span class="stringliteral">&quot;Sm&quot;</span>, 150.36), <span class="comment"># Sixth row Cs-Rn</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                             (<span class="stringliteral">&quot;Eu&quot;</span>, 151.964), (<span class="stringliteral">&quot;Gd&quot;</span>, 157.25), (<span class="stringliteral">&quot;Tb&quot;</span>, 158.92535), (<span class="stringliteral">&quot;Dy&quot;</span>, 162.5), (<span class="stringliteral">&quot;Ho&quot;</span>, 164.93033), (<span class="stringliteral">&quot;Er&quot;</span>, 167.259), (<span class="stringliteral">&quot;Tm&quot;</span>, 168.93422), (<span class="stringliteral">&quot;Yb&quot;</span>, 173.054),</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                             (<span class="stringliteral">&quot;Lu&quot;</span>, 174.9668), (<span class="stringliteral">&quot;Hf&quot;</span>, 178.49), (<span class="stringliteral">&quot;Ta&quot;</span>, 180.94788), (<span class="stringliteral">&quot;W&quot;</span>, 183.84), (<span class="stringliteral">&quot;Re&quot;</span>, 186.207), (<span class="stringliteral">&quot;Os&quot;</span>, 190.23), (<span class="stringliteral">&quot;Ir&quot;</span>, 192.217), (<span class="stringliteral">&quot;Pt&quot;</span>, 195.084),</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                             (<span class="stringliteral">&quot;Au&quot;</span>, 196.966569), (<span class="stringliteral">&quot;Hg&quot;</span>, 200.592), (<span class="stringliteral">&quot;Tl&quot;</span>, 204.3835), (<span class="stringliteral">&quot;Pb&quot;</span>, 207.2), (<span class="stringliteral">&quot;Bi&quot;</span>, 208.9804), (<span class="stringliteral">&quot;Po&quot;</span>, 209.), (<span class="stringliteral">&quot;At&quot;</span>, 210.), (<span class="stringliteral">&quot;Rn&quot;</span>, 222.),</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                             (<span class="stringliteral">&quot;Fr&quot;</span>, 223.), (<span class="stringliteral">&quot;Ra&quot;</span>, 226.), (<span class="stringliteral">&quot;Ac&quot;</span>, 227.), (<span class="stringliteral">&quot;Th&quot;</span>, 232.0377), (<span class="stringliteral">&quot;Pa&quot;</span>, 231.03588), (<span class="stringliteral">&quot;U&quot;, 238.02891), (&quot;</span>Np&quot;, 237.), (&quot;Pu&quot;, 244.), # Seventh row Fr-Og</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                             (<span class="stringliteral">&quot;Am&quot;</span>, 241.), (<span class="stringliteral">&quot;Cm&quot;</span>, 243.), (<span class="stringliteral">&quot;Bk&quot;</span>, 247.), (<span class="stringliteral">&quot;Cf&quot;</span>, 249.), (<span class="stringliteral">&quot;Es&quot;</span>, 252.), (<span class="stringliteral">&quot;Fm&quot;</span>, 257.), (<span class="stringliteral">&quot;Md&quot;</span>, 258.), (<span class="stringliteral">&quot;No&quot;</span>, 259.),</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                             (<span class="stringliteral">&quot;Lr&quot;</span>, 262.), (<span class="stringliteral">&quot;Rf&quot;</span>, 267.), (<span class="stringliteral">&quot;Db&quot;</span>, 268.), (<span class="stringliteral">&quot;Sg&quot;</span>, 271.), (<span class="stringliteral">&quot;Bh&quot;</span>, 272.), (<span class="stringliteral">&quot;Hs&quot;</span>, 270.), (<span class="stringliteral">&quot;Mt&quot;</span>, 276.), (<span class="stringliteral">&quot;Ds&quot;</span>, 281.),</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                             (<span class="stringliteral">&quot;Rg&quot;</span>, 280.), (<span class="stringliteral">&quot;Cn&quot;</span>, 285.), (<span class="stringliteral">&quot;Nh&quot;</span>, 284.), (<span class="stringliteral">&quot;Fl&quot;</span>, 289.), (<span class="stringliteral">&quot;Mc&quot;</span>, 288.), (<span class="stringliteral">&quot;Lv&quot;</span>, 293.), (<span class="stringliteral">&quot;Ts&quot;</span>, 292.), (<span class="stringliteral">&quot;Og&quot;</span>, 294.)])</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment"># Old masses used pre-2020, retained in case it is useful:</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment"># PeriodicTable = OrderedDict([(&#39;H&#39; , 1.0079), (&#39;He&#39; , 4.0026),</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">#                              (&#39;Li&#39; , 6.941), (&#39;Be&#39; , 9.0122), (&#39;B&#39; , 10.811), (&#39;C&#39; , 12.0107), (&#39;N&#39; , 14.0067), (&#39;O&#39; , 15.9994), (&#39;F&#39; , 18.9984), (&#39;Ne&#39; , 20.1797),</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">#                              (&#39;Na&#39; , 22.9897), (&#39;Mg&#39; , 24.305), (&#39;Al&#39; , 26.9815), (&#39;Si&#39; , 28.0855), (&#39;P&#39; , 30.9738), (&#39;S&#39; , 32.065), (&#39;Cl&#39; , 35.453), (&#39;Ar&#39; , 39.948),</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">#                              (&#39;K&#39; , 39.0983), (&#39;Ca&#39; , 40.078), (&#39;Sc&#39; , 44.9559), (&#39;Ti&#39; , 47.867), (&#39;V&#39; , 50.9415), (&#39;Cr&#39; , 51.9961), (&#39;Mn&#39; , 54.938), (&#39;Fe&#39; , 55.845), (&#39;Co&#39; , 58.9332),</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">#                              (&#39;Ni&#39; , 58.6934), (&#39;Cu&#39; , 63.546), (&#39;Zn&#39; , 65.39), (&#39;Ga&#39; , 69.723), (&#39;Ge&#39; , 72.64), (&#39;As&#39; , 74.9216), (&#39;Se&#39; , 78.96), (&#39;Br&#39; , 79.904), (&#39;Kr&#39; , 83.8),</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">#                              (&#39;Rb&#39; , 85.4678), (&#39;Sr&#39; , 87.62), (&#39;Y&#39; , 88.9059), (&#39;Zr&#39; , 91.224), (&#39;Nb&#39; , 92.9064), (&#39;Mo&#39; , 95.94), (&#39;Tc&#39; , 98), (&#39;Ru&#39; , 101.07), (&#39;Rh&#39; , 102.9055),</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">#                              (&#39;Pd&#39; , 106.42), (&#39;Ag&#39; , 107.8682), (&#39;Cd&#39; , 112.411), (&#39;In&#39; , 114.818), (&#39;Sn&#39; , 118.71), (&#39;Sb&#39; , 121.76), (&#39;Te&#39; , 127.6), (&#39;I&#39; , 126.9045), (&#39;Xe&#39; , 131.293),</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">#                              (&#39;Cs&#39; , 132.9055), (&#39;Ba&#39; , 137.327), (&#39;La&#39; , 138.9055), (&#39;Ce&#39; , 140.116), (&#39;Pr&#39; , 140.9077), (&#39;Nd&#39; , 144.24), (&#39;Pm&#39; , 145), (&#39;Sm&#39; , 150.36),</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">#                              (&#39;Eu&#39; , 151.964), (&#39;Gd&#39; , 157.25), (&#39;Tb&#39; , 158.9253), (&#39;Dy&#39; , 162.5), (&#39;Ho&#39; , 164.9303), (&#39;Er&#39; , 167.259), (&#39;Tm&#39; , 168.9342), (&#39;Yb&#39; , 173.04),</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">#                              (&#39;Lu&#39; , 174.967), (&#39;Hf&#39; , 178.49), (&#39;Ta&#39; , 180.9479), (&#39;W&#39; , 183.84), (&#39;Re&#39; , 186.207), (&#39;Os&#39; , 190.23), (&#39;Ir&#39; , 192.217), (&#39;Pt&#39; , 195.078),</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">#                              (&#39;Au&#39; , 196.9665), (&#39;Hg&#39; , 200.59), (&#39;Tl&#39; , 204.3833), (&#39;Pb&#39; , 207.2), (&#39;Bi&#39; , 208.9804), (&#39;Po&#39; , 209), (&#39;At&#39; , 210), (&#39;Rn&#39; , 222),</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">#                              (&#39;Fr&#39; , 223), (&#39;Ra&#39; , 226), (&#39;Ac&#39; , 227), (&#39;Th&#39; , 232.0381), (&#39;Pa&#39; , 231.0359), (&#39;U&#39; , 238.0289), (&#39;Np&#39; , 237), (&#39;Pu&#39; , 244),</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">#                              (&#39;Am&#39; , 243), (&#39;Cm&#39; , 247), (&#39;Bk&#39; , 247), (&#39;Cf&#39; , 251), (&#39;Es&#39; , 252), (&#39;Fm&#39; , 257), (&#39;Md&#39; , 258), (&#39;No&#39; , 259),</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">#                              (&#39;Lr&#39; , 262), (&#39;Rf&#39; , 261), (&#39;Db&#39; , 262), (&#39;Sg&#39; , 266), (&#39;Bh&#39; , 264), (&#39;Hs&#39; , 277), (&#39;Mt&#39; , 268)])</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#ae26e509ce54bf76724a18ba91107df72">getElement</a>(mass):</div><div class="line"><a name="l00293"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#ae26e509ce54bf76724a18ba91107df72">  293</a></span>&#160;    <span class="keywordflow">return</span> PeriodicTable.keys()[np.argmin([np.abs(m-mass) <span class="keywordflow">for</span> m <span class="keywordflow">in</span> PeriodicTable.values()])]</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a4638e3bec89d2fa20ba340988456a1ac">elem_from_atomname</a>(atomname):</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Given an atom name, attempt to get the element in most cases. &quot;&quot;&quot;</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">return</span> re.search(<span class="stringliteral">&#39;[A-Z][a-z]*&#39;</span>,atomname).group(0)</div><div class="line"><a name="l00298"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a4638e3bec89d2fa20ba340988456a1ac">  298</a></span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">if</span> <span class="stringliteral">&quot;forcebalance&quot;</span> <span class="keywordflow">in</span> __name__:</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="comment">#| DCD read/write functions |#</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="comment"># Try to load _dcdlib.so either from a directory in the LD_LIBRARY_PATH</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment"># or from the same directory as this module.</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    have_dcdlib = <span class="keyword">False</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">for</span> fnm <span class="keywordflow">in</span> [<span class="stringliteral">&quot;_dcdlib.so&quot;</span>,</div><div class="line"><a name="l00307"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#aab4fe1dc561e993a549fa87600b86c66">  307</a></span>&#160;                os.path.join(imp.find_module(__name__.split(<span class="stringliteral">&#39;.&#39;</span>)[0])[1],<span class="stringliteral">&quot;_dcdlib.so&quot;</span>),</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                os.path.join(imp.find_module(__name__.split(<span class="stringliteral">&#39;.&#39;</span>)[0])[1],<span class="stringliteral">&quot;_dcdlib&quot;</span>+str(sysconfig.get_config_var(<span class="stringliteral">&#39;EXT_SUFFIX&#39;</span>))),</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                os.path.join(os.path.dirname(__file__),<span class="stringliteral">&quot;_dcdlib.so&quot;</span>),</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                os.path.join(os.path.dirname(__file__),<span class="stringliteral">&quot;_dcdlib&quot;</span>+str(sysconfig.get_config_var(<span class="stringliteral">&#39;EXT_SUFFIX&#39;</span>)))]:</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="keywordflow">if</span> os.path.exists(fnm):</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            _dcdlib = CDLL(fnm)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            have_dcdlib = <span class="keyword">True</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            <span class="keywordflow">break</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> have_dcdlib:</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Cannot import optional dcdlib module to read/write DCD files.\n&#39;</span>)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">#| PDB read/write functions |#</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keyword">from</span> .PDB <span class="keyword">import</span> *</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Cannot import optional pdb module to read/write PDB files.\n&#39;</span>)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">#=============================#</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">#| Mol2 read/write functions |#</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">#=============================#</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keyword">from</span> . <span class="keyword">import</span> Mol2</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Cannot import optional Mol2 module to read .mol2 files.\n&#39;</span>)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">#==============================#</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">#| OpenMM interface functions |#</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="comment">#==============================#</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1unit.html">simtk.unit</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1openmm.html">simtk.openmm</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1openmm_1_1app.html">simtk.openmm.app</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Cannot import optional OpenMM module.\n&#39;</span>)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordflow">elif</span> <span class="stringliteral">&quot;geometric&quot;</span> <span class="keywordflow">in</span> __name__:</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">#| PDB read/write functions |#</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="comment">#============================#</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <span class="keyword">from</span> .PDB <span class="keyword">import</span> *</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Failed to import optional pdb module to read/write PDB files.\n&#39;</span>)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">#==============================#</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">#| OpenMM interface functions |#</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">#==============================#</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1unit.html">simtk.unit</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1openmm.html">simtk.openmm</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keyword">from</span> <a class="code" href="namespacesimtk_1_1openmm_1_1app.html">simtk.openmm.app</a> <span class="keyword">import</span> *</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        logger.debug(<span class="stringliteral">&#39;Note: Failed to import optional OpenMM module.\n&#39;</span>)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">#| Convenience subroutines |#</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;bohr2ang = 0.529177210</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a3bec96f13384a74f923dab3a5b499d31">  369</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a784faffc34b87c6f72db0f4915e1a355">unmangle</a>(M1, M2):</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="stringliteral">    Create a mapping that takes M1&#39;s atom indices to M2&#39;s atom indices based on position.</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="stringliteral">    If we start with atoms in molecule &quot;PDB&quot;, and the new molecule &quot;M&quot;</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="stringliteral">    contains re-numbered atoms, then this code works:</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="stringliteral">    M.elem = list(np.array(PDB.elem)[unmangled])</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">if</span> M1.na != M2.na:</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        logger.error(<span class="stringliteral">&quot;Unmangler only deals with same number of atoms\n&quot;</span>)</div><div class="line"><a name="l00380"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a784faffc34b87c6f72db0f4915e1a355">  380</a></span>&#160;        <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    unmangler = {}</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(M1.na):</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(M2.na):</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            <span class="keywordflow">if</span> np.linalg.norm(M1.xyzs[0][i] - M2.xyzs[0][j]) &lt; 0.1:</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                unmangler[j] = i</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    unmangled = [unmangler[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sorted(unmangler.keys())]</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">if</span> len(unmangled) != M1.na:</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        logger.error(<span class="stringliteral">&quot;Unmangler failed (different structures?)\n&quot;</span>)</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">return</span> unmangled</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a5928a44288a03b8c3ff61204feaa054b">nodematch</a>(node1,node2):</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="comment"># Matching two nodes of a graph.  Nodes are equivalent if the elements are the same</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">return</span> node1[<span class="stringliteral">&#39;e&#39;</span>] == node2[<span class="stringliteral">&#39;e&#39;</span>]</div><div class="line"><a name="l00395"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a5928a44288a03b8c3ff61204feaa054b">  395</a></span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(word):</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;ONLY matches integers! If you have a decimal point? None shall pass!&quot;&quot;&quot;</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keywordflow">return</span> re.match(<span class="stringliteral">&#39;^[-+]?[0-9]+$&#39;</span>,word)</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(word):</div><div class="line"><a name="l00401"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">  401</a></span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Matches ANY number; it can be a decimal, scientific notation, integer, or what have you&quot;&quot;&quot;</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="keywordflow">return</span> re.match(<span class="stringliteral">r&#39;^[-+]?[0-9]*\.?[0-9]*([eEdD][-+]?[0-9]+)?$&#39;</span>,word)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment"># Used to get the white spaces in a split line.</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;splitter = re.compile(<span class="stringliteral">r&#39;(\s+|\S+)&#39;</span>)</div><div class="line"><a name="l00406"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">  406</a></span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment"># Container for Bravais lattice vector.  Three cell lengths, three angles, three vectors, volume, and TINKER trig functions.</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;Box = namedtuple(<span class="stringliteral">&#39;Box&#39;</span>,[<span class="stringliteral">&#39;a&#39;</span>,<span class="stringliteral">&#39;b&#39;</span>,<span class="stringliteral">&#39;c&#39;</span>,<span class="stringliteral">&#39;alpha&#39;</span>,<span class="stringliteral">&#39;beta&#39;</span>,<span class="stringliteral">&#39;gamma&#39;</span>,<span class="stringliteral">&#39;A&#39;</span>,<span class="stringliteral">&#39;B&#39;</span>,<span class="stringliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;V&#39;</span>])</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;radian = 180. / np.pi</div><div class="line"><a name="l00410"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a5e161d9ca62759362680a22c03493a92">  410</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a940e04377db02e5114741a4bf8a6f084">CubicLattice</a>(a):</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; This function takes in three lattice lengths and three lattice angles, and tries to return a complete box specification. &quot;&quot;&quot;</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    b = a</div><div class="line"><a name="l00413"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#abfef1f072cfa93bc31e36985a976b65f">  413</a></span>&#160;    c = a</div><div class="line"><a name="l00414"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a5a46092fd77c5b3b4cdbe06017ff9bd7">  414</a></span>&#160;    alpha = 90</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    beta = 90</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    gamma = 90</div><div class="line"><a name="l00417"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a940e04377db02e5114741a4bf8a6f084">  417</a></span>&#160;    alph = alpha*np.pi/180</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    bet  = beta*np.pi/180</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    gamm = gamma*np.pi/180</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    v = np.sqrt(1 - cos(alph)**2 - cos(bet)**2 - cos(gamm)**2 + 2*cos(alph)*cos(bet)*cos(gamm))</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    Mat = np.array([[a, b*cos(gamm), c*cos(bet)],</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                    [0, b*sin(gamm), c*((cos(alph)-cos(bet)*cos(gamm))/sin(gamm))],</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                    [0, 0, c*v/sin(gamm)]])</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    L1 = Mat.dot(np.array([[1],[0],[0]]))</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    L2 = Mat.dot(np.array([[0],[1],[0]]))</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    L3 = Mat.dot(np.array([[0],[0],[1]]))</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#abfef1f072cfa93bc31e36985a976b65f">Box</a>(a,b,c,alpha,beta,gamma,np.array(L1).flatten(),np.array(L2).flatten(),np.array(L3).flatten(),v*a*b*c)</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma):</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; This function takes in three lattice lengths and three lattice angles, and tries to return a complete box specification. &quot;&quot;&quot;</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    alph = alpha*np.pi/180</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    bet  = beta*np.pi/180</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    gamm = gamma*np.pi/180</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    v = np.sqrt(1 - cos(alph)**2 - cos(bet)**2 - cos(gamm)**2 + 2*cos(alph)*cos(bet)*cos(gamm))</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    Mat = np.array([[a, b*cos(gamm), c*cos(bet)],</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                    [0, b*sin(gamm), c*((cos(alph)-cos(bet)*cos(gamm))/sin(gamm))],</div><div class="line"><a name="l00437"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">  437</a></span>&#160;                    [0, 0, c*v/sin(gamm)]])</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    L1 = Mat.dot(np.array([[1],[0],[0]]))</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    L2 = Mat.dot(np.array([[0],[1],[0]]))</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    L3 = Mat.dot(np.array([[0],[0],[1]]))</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#abfef1f072cfa93bc31e36985a976b65f">Box</a>(a,b,c,alpha,beta,gamma,np.array(L1).flatten(),np.array(L2).flatten(),np.array(L3).flatten(),v*a*b*c)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a49fbd57aae59219cb5fb85c22362b1f3">BuildLatticeFromVectors</a>(v1, v2, v3):</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; This function takes in three lattice vectors and tries to return a complete box specification. &quot;&quot;&quot;</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    a = np.linalg.norm(v1)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    b = np.linalg.norm(v2)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    c = np.linalg.norm(v3)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    alpha = arccos(np.dot(v2, v3) / np.linalg.norm(v2) / np.linalg.norm(v3)) * radian</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    beta  = arccos(np.dot(v1, v3) / np.linalg.norm(v1) / np.linalg.norm(v3)) * radian</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    gamma = arccos(np.dot(v1, v2) / np.linalg.norm(v1) / np.linalg.norm(v2)) * radian</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    alph = alpha*np.pi/180</div><div class="line"><a name="l00452"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a49fbd57aae59219cb5fb85c22362b1f3">  452</a></span>&#160;    bet  = beta*np.pi/180</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    gamm = gamma*np.pi/180</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    v = np.sqrt(1 - cos(alph)**2 - cos(bet)**2 - cos(gamm)**2 + 2*cos(alph)*cos(bet)*cos(gamm))</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    Mat = np.array([[a, b*cos(gamm), c*cos(bet)],</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                    [0, b*sin(gamm), c*((cos(alph)-cos(bet)*cos(gamm))/sin(gamm))],</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                    [0, 0, c*v/sin(gamm)]])</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    L1 = Mat.dot(np.array([[1],[0],[0]]))</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    L2 = Mat.dot(np.array([[0],[1],[0]]))</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    L3 = Mat.dot(np.array([[0],[0],[1]]))</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#abfef1f072cfa93bc31e36985a976b65f">Box</a>(a,b,c,alpha,beta,gamma,np.array(L1).flatten(),np.array(L2).flatten(),np.array(L3).flatten(),v*a*b*c)</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">#|   Connectivity graph    |#</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">#|  Good for doing simple  |#</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">#|     topology tricks     |#</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keyword">import</span> networkx <span class="keyword">as</span> nx</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keyword">class </span>MyG(nx.Graph):</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="keyword">def </span>__init__(self):</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            super(MyG,self).__init__()</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            self.Alive = <span class="keyword">True</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keyword">def </span>__eq__(self, other):</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            <span class="comment"># This defines whether two MyG objects are &quot;equal&quot; to one another.</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.Alive:</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> other.Alive:</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            <span class="keywordflow">return</span> nx.is_isomorphic(self,other,node_match=nodematch)</div><div class="line"><a name="l00481"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a7ceb335632b1368c941413a9788cc047">  481</a></span>&#160;        <span class="keyword">def </span>__hash__(self):</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; The hash function is something we can use to discard two things that are obviously not equal.  Here we neglect the hash. &quot;&quot;&quot;</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            <span class="keywordflow">return</span> 1</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="keyword">def </span><a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>(self):</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; Return a list of the sorted atom numbers in this graph. &quot;&quot;&quot;</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <span class="keywordflow">return</span> sorted(list(self.nodes()))</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="keyword">def </span>AStr(self):</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; Return a string of atoms, which serves as a rudimentary &#39;fingerprint&#39; : &#39;99,100,103,151&#39; . &quot;&quot;&quot;</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            <span class="keywordflow">return</span> <span class="stringliteral">&#39;,&#39;</span>.join([<span class="stringliteral">&#39;%i&#39;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()])</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        <span class="keyword">def </span>e(self):</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; Return an array of the elements.  For instance [&#39;H&#39; &#39;C&#39; &#39;C&#39; &#39;H&#39;]. &quot;&quot;&quot;</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            elems = nx.get_node_attributes(self,<span class="stringliteral">&#39;e&#39;</span>)</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="keywordflow">return</span> [elems[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()]</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        <span class="keyword">def </span>ef(self):</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; Create an Empirical Formula &quot;&quot;&quot;</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            Formula = list(self.e())</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([(<span class="stringliteral">&#39;%s%i&#39;</span> % (k, Formula.count(k)) <span class="keywordflow">if</span> Formula.count(k) &gt; 1 <span class="keywordflow">else</span> <span class="stringliteral">&#39;%s&#39;</span> % k) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> sorted(set(Formula))])</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="keyword">def </span>x(self):</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            <span class="stringliteral">&quot;&quot;&quot; Get a list of the coordinates. &quot;&quot;&quot;</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;            coors = nx.get_node_attributes(self,<span class="stringliteral">&#39;x&#39;</span>)</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">return</span> np.array([coors[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()])</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">except</span> ImportError:</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    logger.warning(<span class="stringliteral">&quot;Cannot import optional NetworkX module, topology tools won&#39;t work\n.&quot;</span>)</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#af3d73b03a8dc403bb7372b8f83f88245">TopEqual</a>(mol1, mol2):</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; For the nanoreactor project: Determine whether two Molecule objects have the same topologies. &quot;&quot;&quot;</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="comment"># Checks to see if the two molecule objects have the same fragments.</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    GraphEqual = <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol1.molecules) == <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol2.molecules)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="comment"># Checks to see whether the molecule objects have the same atoms in each fragment.</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    AtomEqual = <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>([tuple(m.L()) <span class="keywordflow">for</span> m <span class="keywordflow">in</span> mol1.molecules]) == <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>([tuple(m.L()) <span class="keywordflow">for</span> m <span class="keywordflow">in</span> mol2.molecules])</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">return</span> GraphEqual <span class="keywordflow">and</span> AtomEqual</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a6b9b3403d57a07cf94d7a47a73e67da8">MolEqual</a>(mol1, mol2):</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="stringliteral">    Determine whether two Molecule objects have the same fragments by</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="stringliteral">    looking at elements and connectivity graphs.  This is less strict</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="stringliteral">    than TopEqual (i.e. more often returns True).</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="keywordflow">if</span> mol1.na != mol2.na : <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keywordflow">if</span> <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol1.elem) != <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol2.elem) : <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#af3d73b03a8dc403bb7372b8f83f88245">  521</a></span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol1.molecules) == <a class="code" href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">Counter</a>(mol2.molecules)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">format_xyz_coord</a>(element,xyz,tinker=False):</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Print a line consisting of (element, x, y, z) in accordance with .xyz file format</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="stringliteral">    @param[in] element A chemical element of a single atom</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="stringliteral">    @param[in] xyz A 3-element array containing x, y, z coordinates of that atom</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="keywordflow">if</span> tinker:</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-3s % 13.8f % 13.8f % 13.8f&quot;</span> % (element,xyz[0],xyz[1],xyz[2])</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-5s % 15.10f % 15.10f % 15.10f&quot;</span> % (element,xyz[0],xyz[1],xyz[2])</div><div class="line"><a name="l00534"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a6b9b3403d57a07cf94d7a47a73e67da8">  534</a></span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="keyword">def </span>_format_83(f):</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Format a single float into a string of width 8, with ideally 3 decimal</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="stringliteral">    places of precision. If the number is a little too large, we can</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="stringliteral">    gracefully degrade the precision by lopping off some of the decimal</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="stringliteral">    places. If it&#39;s much too large, we throw a ValueError&quot;&quot;&quot;</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> -999.999 &lt; f &lt; 9999.999:</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39;%8.3f&#39;</span> % f</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">if</span> -9999999 &lt; f &lt; 99999999:</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">return</span> (<span class="stringliteral">&#39;%8.3f&#39;</span> % f)[:8]</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&#39;coordinate &quot;%s&quot; could not be represented &#39;</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                     <span class="stringliteral">&#39;in a width-8 field&#39;</span> % f)</div><div class="line"><a name="l00546"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">  546</a></span>&#160;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a081f51f922805fee2d219661d7d31743">format_gro_coord</a>(resid, resname, aname, seqno, xyz):</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Print a line in accordance with .gro file format, with six decimal points of precision</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="stringliteral">    Nine decimal points of precision are necessary to get forces below 1e-3 kJ/mol/nm.</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="stringliteral">    @param[in] resid The number of the residue that the atom belongs to</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="stringliteral">    @param[in] resname The name of the residue that the atom belongs to</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="stringliteral">    @param[in] aname The name of the atom</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="stringliteral">    @param[in] seqno The sequential number of the atom</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="stringliteral">    @param[in] xyz A 3-element array containing x, y, z coordinates of that atom</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;%5i%-5s%5s%5i % 13.9f % 13.9f % 13.9f&quot;</span> % (resid,resname,aname,seqno,xyz[0],xyz[1],xyz[2])</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#aa91151bec25f2f39ce30c2a71bb7478f">format_xyzgen_coord</a>(element,xyzgen):</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Print a line consisting of (element, p, q, r, s, t, ...) where</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="stringliteral">    (p, q, r) are arbitrary atom-wise data (this might happen, for</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="stringliteral">    instance, with atomic charges)</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="stringliteral">    @param[in] element A chemical element of a single atom</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="stringliteral">    @param[in] xyzgen A N-element array containing data for that atom</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-5s&quot;</span> + <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 15.10f&quot;</span> % i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xyzgen)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a373f82faf5d8f3ce84095ed74ab77425">format_gro_box</a>(box):</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Print a line corresponding to the box vector in accordance with .gro file format</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="stringliteral">    @param[in] box Box NamedTuple</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00577"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a081f51f922805fee2d219661d7d31743">  577</a></span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="keywordflow">if</span> box.alpha == 90.0 <span class="keywordflow">and</span> box.beta == 90.0 <span class="keywordflow">and</span> box.gamma == 90.0:</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 13.9f&quot;</span> % (i/10) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [box.a, box.b, box.c]])</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 13.9f&quot;</span> % (i/10) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [box.A[0], box.B[1], box.C[2], box.A[1], box.A[2], box.B[0], box.B[2], box.C[0], box.C[1]]])</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a2cf7fe49895eedd6c60b7394f1435529">is_gro_coord</a>(line):</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains GROMACS data or not</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="stringliteral">    @param[in] line The line to be tested</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00589"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#aa91151bec25f2f39ce30c2a71bb7478f">  589</a></span>&#160;    sline = line.split()</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">if</span> len(sline) == 6:</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[2]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[3]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[4]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[5])])</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keywordflow">elif</span> len(sline) == 5:</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(line[15:20]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[2]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[3]),<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[4])])</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="keywordflow">return</span> 0</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a17d81a43f4f28d4db24d6548dc7018dd">is_charmm_coord</a>(line):</div><div class="line"><a name="l00598"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a373f82faf5d8f3ce84095ed74ab77425">  598</a></span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains CHARMM data or not</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="stringliteral">    @param[in] line The line to be tested</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    sline = line.split()</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">if</span> len(sline) &gt;= 7:</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[0]), <a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[1]), <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[4]), <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[5]), <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[6])])</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="keywordflow">return</span> 0</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a0f007f8498ecc025f1e066d47fabfd24">is_gro_box</a>(line):</div><div class="line"><a name="l00610"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a2cf7fe49895eedd6c60b7394f1435529">  610</a></span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains a GROMACS box vector or not</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="stringliteral">    @param[in] line The line to be tested</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    sline = line.split()</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keywordflow">if</span> len(sline) == 9 <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]):</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="keywordflow">return</span> 1</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">elif</span> len(sline) == 3 <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]):</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="keywordflow">return</span> 1</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">return</span> 0</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a157c193873713c7029b653c1ca51eb7a">add_strip_to_mat</a>(mat,strip):</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    out = list(mat)</div><div class="line"><a name="l00625"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a17d81a43f4f28d4db24d6548dc7018dd">  625</a></span>&#160;    <span class="keywordflow">if</span> out == [] <span class="keywordflow">and</span> strip != []:</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        out = list(strip)</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordflow">elif</span> out != [] <span class="keywordflow">and</span> strip != []:</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="keywordflow">for</span> (i,j) <span class="keywordflow">in</span> zip(out,strip):</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            i += list(j)</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">return</span> out</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">pvec</a>(vec):</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&#39; % .10e&#39;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> list(vec.flatten())])</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a3d07eb6fe9de1d679c82213a4d7e988d">grouper</a>(n, iterable):</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Groups a big long iterable into groups of ten or what have you. &quot;&quot;&quot;</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    args = [iter(iterable)] * n</div><div class="line"><a name="l00638"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a0f007f8498ecc025f1e066d47fabfd24">  638</a></span>&#160;    <span class="keywordflow">return</span> list([e <span class="keywordflow">for</span> e <span class="keywordflow">in</span> t <span class="keywordflow">if</span> e <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> zip_longest(*args))</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a097327ba25a338d642f7ab11dadb55cc">even_list</a>(totlen, splitsize):</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Creates a list of number sequences divided as evenly as possible.  &quot;&quot;&quot;</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    joblens = np.zeros(splitsize,dtype=int)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    subsets = []</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(totlen):</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        joblens[i%splitsize] += 1</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    jobnow = 0</div><div class="line"><a name="l00647"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a157c193873713c7029b653c1ca51eb7a">  647</a></span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(splitsize):</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        subsets.append(list(range(jobnow, jobnow + joblens[i])))</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        jobnow += joblens[i]</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">return</span> subsets</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="keyword">class </span><a class="code" href="classsrc_1_1molecule_1_1MolfileTimestep.html">MolfileTimestep</a>(Structure):</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Wrapper for the timestep C structure used in molfile plugins. &quot;&quot;&quot;</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    _fields_ = [(<span class="stringliteral">&quot;coords&quot;</span>,POINTER(c_float)), (<span class="stringliteral">&quot;velocities&quot;</span>,POINTER(c_float)),</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                (<span class="stringliteral">&quot;A&quot;</span>,c_float), (<span class="stringliteral">&quot;B&quot;</span>,c_float), (<span class="stringliteral">&quot;C&quot;</span>,c_float), (<span class="stringliteral">&quot;alpha&quot;</span>,c_float),</div><div class="line"><a name="l00656"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">  656</a></span>&#160;                (<span class="stringliteral">&quot;beta&quot;</span>,c_float), (<span class="stringliteral">&quot;gamma&quot;</span>,c_float), (<span class="stringliteral">&quot;physical_time&quot;</span>,c_double)]</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a406a751e54f7e50da529c5d45f7f7de8">both</a>(A, B, key):</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">return</span> key <span class="keywordflow">in</span> A.Data <span class="keywordflow">and</span> key <span class="keywordflow">in</span> B.Data</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div><div class="line"><a name="l00661"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a3d07eb6fe9de1d679c82213a4d7e988d">  661</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a9de48d83dc7f53e25b86a4a6076e3185">diff</a>(A, B, key):</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (key <span class="keywordflow">in</span> A.Data <span class="keywordflow">and</span> key <span class="keywordflow">in</span> B.Data) : <span class="keywordflow">return</span> <span class="keyword">False</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="keywordflow">if</span> type(A.Data[key]) <span class="keywordflow">is</span> np.ndarray:</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <span class="keywordflow">return</span> (A.Data[key] != B.Data[key]).any()</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;tinkersuf&#39;</span>:</div><div class="line"><a name="l00667"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a097327ba25a338d642f7ab11dadb55cc">  667</a></span>&#160;            <span class="keywordflow">return</span> [sorted([int(j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> i.split()]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> A.Data[key]] != \</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                [sorted([int(j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> i.split()]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> B.Data[key]]</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            <span class="keywordflow">return</span> A.Data[key] != B.Data[key]</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a53a3e04b9a57f9217a193d92c2062890">either</a>(A, B, key):</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">return</span> key <span class="keywordflow">in</span> A.Data <span class="keywordflow">or</span> key <span class="keywordflow">in</span> B.Data</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">#|  Alignment subroutines  |#</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">#| Moments added 08/03/12  |#</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">#===========================#</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a0b808b0181dfa0aed5879c61f683ec1a">EulerMatrix</a>(T1,T2,T3):</div><div class="line"><a name="l00680"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1MolfileTimestep.html">  680</a></span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Constructs an Euler matrix from three Euler angles. &quot;&quot;&quot;</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    DMat = np.zeros((3,3))</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    DMat[0,0] = np.cos(T1)</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    DMat[0,1] = np.sin(T1)</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    DMat[1,0] = -np.sin(T1)</div><div class="line"><a name="l00685"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a406a751e54f7e50da529c5d45f7f7de8">  685</a></span>&#160;    DMat[1,1] = np.cos(T1)</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    DMat[2,2] = 1</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    CMat = np.zeros((3,3))</div><div class="line"><a name="l00688"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a9de48d83dc7f53e25b86a4a6076e3185">  688</a></span>&#160;    CMat[0,0] = 1</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    CMat[1,1] = np.cos(T2)</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    CMat[1,2] = np.sin(T2)</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    CMat[2,1] = -np.sin(T2)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    CMat[2,2] = np.cos(T2)</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    BMat = np.zeros((3,3))</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    BMat[0,0] = np.cos(T3)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    BMat[0,1] = np.sin(T3)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    BMat[1,0] = -np.sin(T3)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    BMat[1,1] = np.cos(T3)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    BMat[2,2] = 1</div><div class="line"><a name="l00699"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a53a3e04b9a57f9217a193d92c2062890">  699</a></span>&#160;    EMat = multi_dot([BMat, CMat, DMat])</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">return</span> EMat</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a32c3d0fa2efc4d240274218803e1f42b">ComputeOverlap</a>(theta,elem,xyz1,xyz2):</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="stringliteral">    Computes an &#39;overlap&#39; between two molecules based on some</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="stringliteral">    fictitious density.  Good for fine-tuning alignment but gets stuck</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="stringliteral">    in local minima.</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00708"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a0b808b0181dfa0aed5879c61f683ec1a">  708</a></span>&#160;    xyz2R = np.dot(<a class="code" href="namespacesrc_1_1molecule.html#a0b808b0181dfa0aed5879c61f683ec1a">EulerMatrix</a>(theta[0],theta[1],theta[2]), xyz2.T).T</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    Obj = 0.0</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    elem = np.array(elem)</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> set(elem):</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> np.where(elem==i)[0]:</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> np.where(elem==i)[0]:</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                dx = xyz1[j] - xyz2R[k]</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                dx2 = np.dot(dx,dx)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                Obj -= np.exp(-0.5*dx2)</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="keywordflow">return</span> Obj</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#af5506b829909137d2b0b586eb1349c85">AlignToDensity</a>(elem,xyz1,xyz2,binary=False):</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="stringliteral">    Computes a &quot;overlap density&quot; from two frames.</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="stringliteral">    This function can be called by AlignToMoments to get rid of inversion problems</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    grid = np.pi*np.array(list(itertools.product([0,1],[0,1],[0,1])))</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    ovlp = np.array([<a class="code" href="namespacesrc_1_1molecule.html#a32c3d0fa2efc4d240274218803e1f42b">ComputeOverlap</a>(e, elem, xyz1, xyz2) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> grid]) <span class="comment"># Mao</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    t1 = grid[np.argmin(ovlp)]</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    xyz2R = np.dot(<a class="code" href="namespacesrc_1_1molecule.html#a0b808b0181dfa0aed5879c61f683ec1a">EulerMatrix</a>(t1[0],t1[1],t1[2]), xyz2.T).T.copy()</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">return</span> xyz2R</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a06bd27c59ccdbde31fbefbdec2daf1ad">AlignToMoments</a>(elem,xyz1,xyz2=None):</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;Pre-aligns molecules to &#39;moment of inertia&#39;.</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="stringliteral">    If xyz2 is passed in, it will assume that xyz1 is already</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="stringliteral">    aligned to the moment of inertia, and it simply does 180-degree</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="stringliteral">    rotations to make sure nothing is inverted.&quot;&quot;&quot;</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    xyz = xyz1 <span class="keywordflow">if</span> xyz2 <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> xyz2</div><div class="line"><a name="l00736"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a32c3d0fa2efc4d240274218803e1f42b">  736</a></span>&#160;    I = np.zeros((3,3))</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    <span class="keywordflow">for</span> i, xi <span class="keywordflow">in</span> enumerate(xyz):</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        I += (np.dot(xi,xi)*np.eye(3) - np.outer(xi,xi))</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        <span class="comment"># This is the original line from MSMBuilder, but we&#39;re choosing not to use masses</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        <span class="comment"># I += PeriodicTable[elem[i]]*(np.dot(xi,xi)*np.eye(3) - np.outer(xi,xi))</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    A, B = np.linalg.eig(I)</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="comment"># Sort eigenvectors by eigenvalue</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    BB   = B[:, np.argsort(A)]</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    determ = np.linalg.det(BB)</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    Thresh = 1e-3</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="keywordflow">if</span> np.abs(determ - 1.0) &gt; Thresh:</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordflow">if</span> np.abs(determ + 1.0) &gt; Thresh:</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            logger.info(<span class="stringliteral">&quot;in AlignToMoments, determinant is % .3f&quot;</span> % determ)</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        BB[:,2] *= -1</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    xyzr = np.dot(BB.T, xyz.T).T.copy()</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordflow">if</span> xyz2 <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        xyzrr = <a class="code" href="namespacesrc_1_1molecule.html#af5506b829909137d2b0b586eb1349c85">AlignToDensity</a>(elem,xyz1,xyzr,binary=<span class="keyword">True</span>)</div><div class="line"><a name="l00753"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#af5506b829909137d2b0b586eb1349c85">  753</a></span>&#160;        <span class="keywordflow">return</span> xyzrr</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        <span class="keywordflow">return</span> xyzr</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(matrix1,matrix2):</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="comment"># matrix2 contains the xyz coordinates of the REFERENCE</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keyword">assert</span> np.shape(matrix1) == np.shape(matrix2), <span class="stringliteral">&#39;Matrices not of same dimensions&#39;</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="comment"># Store number of rows</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    nrows = np.shape(matrix1)[0]</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment"># Getting centroid position for each selection</span></div><div class="line"><a name="l00765"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a06bd27c59ccdbde31fbefbdec2daf1ad">  765</a></span>&#160;    avg_pos1 = matrix1.sum(axis=0)/nrows</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    avg_pos2 = matrix2.sum(axis=0)/nrows</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="comment"># Translation of matrices</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    avg_matrix1 = matrix1-avg_pos1</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    avg_matrix2 = matrix2-avg_pos2</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="comment"># Covariance matrix</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    covar = np.dot(avg_matrix1.T,avg_matrix2)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="comment"># Do the SVD in order to get rotation matrix</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    v,s,wt = np.linalg.svd(covar)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="comment"># Rotation matrix</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="comment"># Transposition of v,wt</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    wvt = np.dot(wt.T, v.T)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment"># Ensure a right-handed coordinate system</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    d = np.eye(3)</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordflow">if</span> np.linalg.det(wvt) &lt; 0:</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        d[2,2] = -1.0</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    rot_matrix = multi_dot([wt.T,d,v.T]).T</div><div class="line"><a name="l00788"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">  788</a></span>&#160;    trans_matrix = avg_pos2-np.dot(avg_pos1,rot_matrix)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="keywordflow">return</span> trans_matrix, rot_matrix</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a8d9cdc5fd67e79c8b1edac8159d2e370">cartesian_product2</a>(arrays):</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Form a Cartesian product of two NumPy arrays. &quot;&quot;&quot;</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    la = len(arrays)</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    arr = np.empty([len(a) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> arrays] + [la], dtype=np.int32)</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(np.ix_(*arrays)):</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        arr[...,i] = a</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">return</span> arr.reshape(-1, la)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a926fcd7399f5becbd07f69cff154dca7">extract_int</a>(arr, avgthre, limthre, label=&quot;value&quot;, verbose=True):</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="stringliteral">    Get the representative integer value from an array.</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="stringliteral">    The integer value is the rounded mean.  Perform sanity</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="stringliteral">    checks to ensure the array isn&#39;t overly &quot;non-integer&quot;.</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="stringliteral">    arr : numpy.ndarray</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="stringliteral">        NumPy array containing a series of floating point values</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="stringliteral">        where we&#39;d like to extract the representative integer value.</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="stringliteral">    avgthre : float</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="stringliteral">        If the average deviates from the closest integer by</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="stringliteral">        more than this amount, do not pass.</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="stringliteral">    limthre : float</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="stringliteral">        If any element in this array deviates from the closest integer by</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="stringliteral">        more than this amount, do not pass.</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="stringliteral">    label : str</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="stringliteral">        Descriptive name of this variable, used only in printout.</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="stringliteral">    verbose : bool</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="stringliteral">        Print information in case array makes excursions larger than the threshold</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="stringliteral">    int</span></div><div class="line"><a name="l00824"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a8d9cdc5fd67e79c8b1edac8159d2e370">  824</a></span>&#160;<span class="stringliteral">        Representative integer value for the array.</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="stringliteral">    passed : bool</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="stringliteral">        Indicates whether the array mean and/or maximum deviations stayed with the thresholds.</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    average = np.mean(arr)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    maximum = np.max(arr)</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    minimum = np.min(arr)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    rounded = round(average)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    passed = <span class="keyword">True</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="keywordflow">if</span> abs(average - rounded) &gt; avgthre:</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="keywordflow">if</span> verbose:</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;            logger.info(<span class="stringliteral">&quot;Average %s (%f) deviates from integer %s (%i) by more than threshold of %f&quot;</span> % (label, average, label, rounded, avgthre))</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        passed = <span class="keyword">False</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> abs(maximum - minimum) &gt; limthre:</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="keywordflow">if</span> verbose:</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;            logger.info(<span class="stringliteral">&quot;Maximum %s fluctuation (%f) is larger than threshold of %f&quot;</span> % (label, abs(maximum-minimum), limthre))</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        passed = <span class="keyword">False</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordflow">return</span> int(rounded), passed</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a76b7defcd5b5e5db182fdf2f9f82f4ce">extract_pop</a>(M, verbose=True):</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="stringliteral">    Extract our best estimate of charge and spin-z from the comments</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="stringliteral">    section of a Molecule object created with Nanoreactor.  Note that</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="stringliteral">    spin-z is 1.0 if there is one unpaired electron (not one/half) because</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="stringliteral">    the unit is in terms of populations.</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="stringliteral">    This function is intended to work on atoms that are *extracted*</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="stringliteral">    from an ab initio MD trajectory, where the Mulliken charge and spin</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="stringliteral">    populations are not exactly integers.  It attempts to return the closest</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="stringliteral">    integer but it will sometimes fail.</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="stringliteral">    If the number of electrons and spin-z are inconsistent, then</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="stringliteral">    return -999,-999 (indicates failure).</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l00860"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a926fcd7399f5becbd07f69cff154dca7">  860</a></span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="stringliteral">    M : Molecule</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="stringliteral">        Molecule object that we&#39;re getting charge and spin from, with a known comment syntax</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="stringliteral">        Reaction: formula CHO -&gt; CO+H atoms [&#39;0-2&#39;] -&gt; [&#39;0-1&#39;,&#39;2&#39;] frame 219482 charge -0.742 sz +0.000 sz^2 0.000</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="stringliteral">    chg : int</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="stringliteral">        Representative integer net charge of this Molecule, or -999 if inconsistent</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="stringliteral">    spn : int</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="stringliteral">        Representative integer spin-z of this Molecule (one unpaired electron: sz=1), or -999 if inconsistent</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="comment"># Read in the charge and spin on the whole system.</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    srch  = <span class="keyword">lambda</span> s : np.array([float(re.search(<span class="stringliteral">r&#39;(?&lt;=%s )[-+]?[0-9]*\.?[0-9]*([eEdD][-+]?[0-9]+)?&#39;</span> % s, c).group(0)) <span class="keywordflow">for</span> c <span class="keywordflow">in</span> M.comms <span class="keywordflow">if</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([i <span class="keywordflow">in</span> c <span class="keywordflow">for</span> i <span class="keywordflow">in</span> (<span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;sz&#39;</span>)])])</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    Chgs  = srch(<span class="stringliteral">&#39;charge&#39;</span>) <span class="comment"># An array of the net charge.</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    SpnZs = srch(<span class="stringliteral">&#39;sz&#39;</span>)    <span class="comment"># An array of the net Z-spin.</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    Spn2s = srch(<span class="stringliteral">r&#39;sz\^2&#39;</span>) <span class="comment"># An array of the sum of sz^2 by atom.</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    chg, chgpass = <a class="code" href="namespacesrc_1_1molecule.html#a926fcd7399f5becbd07f69cff154dca7">extract_int</a>(Chgs, 0.3, 1.0, label=<span class="stringliteral">&quot;charge&quot;</span>)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    spn, spnpass = <a class="code" href="namespacesrc_1_1molecule.html#a926fcd7399f5becbd07f69cff154dca7">extract_int</a>(abs(SpnZs), 0.3, 1.0, label=<span class="stringliteral">&quot;spin-z&quot;</span>)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="comment"># Try to calculate the correct spin.</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    nproton = sum([Elements.index(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> M.elem])</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    nelectron = nproton + chg</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> spnpass:</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&quot;Going with the minimum spin consistent with charge.&quot;</span>)</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="keywordflow">if</span> nelectron%2 == 0:</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;            spn = 0</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            spn = 1</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="comment"># The number of electrons should be odd iff the spin is odd.</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="keywordflow">if</span> (int((nelectron-spn)/2))*2 != (nelectron-spn):</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&quot;\x1b[91mThe number of electrons (%i) is inconsistent with the spin-z (%i)\x1b[0m&quot;</span> % (nelectron, spn))</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        <span class="keywordflow">return</span> -999, -999</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&quot;%i electrons; charge %i, spin %i&quot;</span> % (nelectron, chg, spn))</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keywordflow">return</span> chg, spn</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a28c672c2de7b942b427a22f3b433b04e">arc</a>(Mol, begin=None, end=None, RMSD=True, align=True):</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="stringliteral">    Get the arc-length for a trajectory segment.</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="stringliteral">    Uses RMSD or maximum displacement of any atom in the trajectory.</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00906"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a76b7defcd5b5e5db182fdf2f9f82f4ce">  906</a></span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="stringliteral">    Mol : Molecule</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="stringliteral">        Molecule object for calculating the arc length.</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="stringliteral">    begin : int</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="stringliteral">        Starting frame, defaults to first frame</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="stringliteral">    end : int</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="stringliteral">        Ending frame, defaults to final frame</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="stringliteral">    RMSD : bool</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;<span class="stringliteral">        Set to True to use frame-to-frame RMSD; otherwise use the maximum displacement of any atom</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="stringliteral">    Arc : np.ndarray</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="stringliteral">        Arc length between frames in Angstrom, length is n_frames - 1</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">if</span> align:</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        Mol.align()</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordflow">if</span> begin <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        begin = 0</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="keywordflow">if</span> end <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        end = len(Mol)</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="keywordflow">if</span> RMSD:</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        Arc = Mol.pathwise_rmsd(align)</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        Arc = np.array([np.max([np.linalg.norm(Mol.xyzs[i+1][j]-Mol.xyzs[i][j]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(Mol.na)]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(begin, end-1)])</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="keywordflow">return</span> Arc</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#af77e6cac48816736aa9a5cfa2f74071b">EqualSpacing</a>(Mol, frames=0, dx=0, RMSD=True, align=True):</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="stringliteral">    Equalize the spacing of frames in a trajectory with linear interpolation.</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="stringliteral">    This is done in a very simple way, first calculating the arc length</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="stringliteral">    between frames, then creating an equally spaced array, and interpolating</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="stringliteral">    all Cartesian coordinates along this equally spaced array.</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="stringliteral">    This is intended to be used on trajectories with smooth transformations and</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="stringliteral">    ensures that concatenated frames containing both optimization coordinates</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="stringliteral">    and dynamics trajectories don&#39;t have sudden changes in their derivatives.</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="stringliteral">    Mol : Molecule</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;<span class="stringliteral">        Molecule object for equalizing the spacing.</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="stringliteral">    frames : int</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="stringliteral">        Return a Molecule object with this number of frames.</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="stringliteral">    RMSD : bool</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="stringliteral">        Use RMSD in the arc length calculation.</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l00956"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a28c672c2de7b942b427a22f3b433b04e">  956</a></span>&#160;<span class="stringliteral">    Mol1 : Molecule</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="stringliteral">        New molecule object, either the same one (if frames &gt; len(Mol))</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="stringliteral">        or with equally spaced frames.</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    ArcMol = <a class="code" href="namespacesrc_1_1molecule.html#a28c672c2de7b942b427a22f3b433b04e">arc</a>(Mol, RMSD=RMSD, align=align)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    ArcMolCumul = np.insert(np.cumsum(ArcMol), 0, 0.0)</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">if</span> frames != 0 <span class="keywordflow">and</span> dx != 0:</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        logger.error(<span class="stringliteral">&quot;Provide dx or frames or neither&quot;</span>)</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="keywordflow">elif</span> dx != 0:</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        frames = int(float(max(ArcMolCumul))/dx)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keywordflow">elif</span> frames == 0:</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        frames = len(ArcMolCumul)</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    ArcMolEqual = np.linspace(0, max(ArcMolCumul), frames)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    xyzold = np.array(Mol.xyzs)</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    xyznew = np.zeros((frames, Mol.na, 3))</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="keywordflow">for</span> a <span class="keywordflow">in</span> range(Mol.na):</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3):</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            xyznew[:,a,i] = np.interp(ArcMolEqual, ArcMolCumul, xyzold[:, a, i])</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="keywordflow">if</span> len(xyzold) == len(xyznew):</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        Mol1 = copy.deepcopy(Mol)</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <span class="comment"># If we changed the number of coordinates, then</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        <span class="comment"># do some integer interpolation of the comments and</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <span class="comment"># other frame variables.</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        Mol1 = Mol[np.array([int(round(i)) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> np.linspace(0, len(xyzold)-1, len(xyznew))])]</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    Mol1.xyzs = list(xyznew)</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="keywordflow">return</span> Mol1</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(xyz, pairs, box=None, displace=False):</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="stringliteral">    Compute distances between pairs of atoms.</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="stringliteral">    xyz : np.ndarray</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="stringliteral">        N_frames*N_atoms*3 (3D) array of atomic positions</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="stringliteral">        If you only have a single set of positions, pass in xyz[np.newaxis, :]</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="stringliteral">    pairs : list</span></div><div class="line"><a name="l00995"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#af77e6cac48816736aa9a5cfa2f74071b">  995</a></span>&#160;<span class="stringliteral">        List of 2-tuples of atom indices</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="stringliteral">    box : np.ndarray, optional</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;<span class="stringliteral">        N_frames*3 (2D) array of periodic box vectors</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="stringliteral">        If you only have a single set of positions, pass in box[np.newaxis, :]</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="stringliteral">    displace : bool</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="stringliteral">        If True, also return N_frames*N_pairs*3 array of displacement vectors</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="stringliteral">    np.ndarray</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="stringliteral">        N_pairs*N_frames (2D) array of minimum image convention distances</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="stringliteral">    np.ndarray (optional)</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="stringliteral">        if displace=True, N_frames*N_pairs*3 array of displacement vectors</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    <span class="comment"># Obtain atom selections for atom pairs</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    parray = np.array(pairs)</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    sel1 = parray[:,0]</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    sel2 = parray[:,1]</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    xyzpbc = xyz.copy()</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment"># Minimum image convention: Place all atoms in the box</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="comment"># [0, xbox); [0, ybox); [0, zbox)</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keywordflow">if</span> box <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        xyzpbc /= box[:,np.newaxis,:]</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        xyzpbc = xyzpbc % 1.0</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    <span class="comment"># Obtain atom selections for the pairs to be computed</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment"># These are typically longer than N but shorter than N^2.</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    xyzsel1 = xyzpbc[:,sel1,:]</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    xyzsel2 = xyzpbc[:,sel2,:]</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="comment"># Calculate xyz displacement</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    dxyz = xyzsel2-xyzsel1</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <span class="comment"># Apply minimum image convention to displacements</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">if</span> box <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        dxyz = np.mod(dxyz+0.5, 1.0) - 0.5</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        dxyz *= box[:,np.newaxis,:]</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    dr2 = np.sum(dxyz**2,axis=2)</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    dr = np.sqrt(dr2)</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordflow">if</span> displace:</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        <span class="keywordflow">return</span> dr, dxyz</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        <span class="keywordflow">return</span> dr</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="comment">#===================================#</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">#| Rotation subroutine 2018-10-28  |#</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">#| Copied from geomeTRIC.rotate    |#</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">#===================================#</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a593b80c51a439f35789c16ad5fbcbfec">form_rot</a>(q):</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="stringliteral">    Given a quaternion p, form a rotation matrix from it.</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="stringliteral">    </span></div><div class="line"><a name="l01045"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc"> 1045</a></span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="stringliteral">    q : numpy.ndarray</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="stringliteral">        1D array with 3 elements representing the rotation quaterion.</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="stringliteral">        Elements of quaternion are : [cos(a/2), sin(a/2)*axis[0..2]]</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="stringliteral">    </span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="stringliteral">    numpy.array</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="stringliteral">        3x3 rotation matrix</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    <span class="keyword">assert</span> q.ndim == 1</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keyword">assert</span> q.shape[0] == 4</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="comment"># Take the &quot;complex conjugate&quot;</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    qc = np.zeros_like(q)</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    qc[0] =  q[0]</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    qc[1] = -q[1]</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    qc[2] = -q[2]</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    qc[3] = -q[3]</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="comment"># Form al_q and al_qc matrices</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    al_q = np.array([[ q[0], -q[1], -q[2], -q[3]],</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                     [ q[1],  q[0], -q[3],  q[2]],</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                     [ q[2],  q[3],  q[0], -q[1]],</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                     [ q[3], -q[2],  q[1],  q[0]]])</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    ar_qc = np.array([[ qc[0], -qc[1], -qc[2], -qc[3]],</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                      [ qc[1],  qc[0],  qc[3], -qc[2]],</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                      [ qc[2], -qc[3],  qc[0],  qc[1]],</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                      [ qc[3],  qc[2], -qc[1],  qc[0]]])</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <span class="comment"># Multiply matrices</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    R4 = np.dot(al_q,ar_qc)</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="keywordflow">return</span> R4[1:, 1:]</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a18b08895867e37ef3cb86a3d4456c775">axis_angle</a>(axis, angle):</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="stringliteral">    Given a rotation axis and angle, return the corresponding</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="stringliteral">    3x3 rotation matrix, which will rotate a (Nx3) array of</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="stringliteral">    xyz coordinates as x0_rot = np.dot(R, x0.T).T</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="stringliteral">    Parameters</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="stringliteral">    ----------</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="stringliteral">    axis : numpy.ndarray</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="stringliteral">        1D array with 3 elements representing the rotation axis</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="stringliteral">    angle : float</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="stringliteral">        The angle of the rotation</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="stringliteral">    </span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="stringliteral">    Returns</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="stringliteral">    -------</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="stringliteral">    numpy.array</span></div><div class="line"><a name="l01093"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a593b80c51a439f35789c16ad5fbcbfec"> 1093</a></span>&#160;<span class="stringliteral">        3x3 rotation matrix</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="keyword">assert</span> axis.ndim == 1</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="keyword">assert</span> axis.shape[0] == 3</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    axis /= np.linalg.norm(axis)</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="comment"># Make quaternion</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    ct2 = np.cos(angle/2)</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    st2 = np.sin(angle/2)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    q = np.array([ct2, st2*axis[0], st2*axis[1], st2*axis[2]])</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    <span class="comment"># Form rotation matrix</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    R = <a class="code" href="namespacesrc_1_1molecule.html#a593b80c51a439f35789c16ad5fbcbfec">form_rot</a>(q)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    <span class="keywordflow">return</span> R</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="keyword">class </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>(object):</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    <span class="stringliteral">&quot;&quot;&quot; Lee-Ping&#39;s general file format conversion class.</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="stringliteral">    The purpose of this class is to read and write chemical file formats in a</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="stringliteral">    way that is convenient for research.  There are highly general file format</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="stringliteral">    converters out there (e.g. catdcd, openbabel) but I find that writing</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="stringliteral">    my own class can be very helpful for specific purposes.  Here are some things</span></div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<span class="stringliteral">    this class can do:</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="stringliteral">    - Convert a .gro file to a .xyz file, or a .pdb file to a .dcd file.</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;<span class="stringliteral">    Data is stored internally, so any readable file can be converted into</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="stringliteral">    any writable file as long as there is sufficient information to write</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;<span class="stringliteral">    that file.</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="stringliteral">    - Accumulate information from different files.  For example, we may read</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="stringliteral">    A.gro to get a list of coordinates, add quantum settings from a B.in file,</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;<span class="stringliteral">    and write A.in (this gives us a file that we can use to run QM calculations)</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="stringliteral">    - Concatenate two trajectories together as long as they&#39;re compatible.  This</span></div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="stringliteral">    is done by creating two Molecule objects and then simply adding them.  Addition</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="stringliteral">    means two things:  (1) Information fields missing from each class, but present</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="stringliteral">    in the other, are added to the sum, and (2) Appendable or per-frame fields</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="stringliteral">    (i.e. coordinates) are concatenated together.</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="stringliteral">    - Slice trajectories using reasonable Python language.  That is to</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="stringliteral">    say, MyMolecule[1:10] returns a new Molecule object that contains</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="stringliteral">    frames 1 through 9 (inclusive and numbered starting from zero.)</span></div><div class="line"><a name="l01133"></a><span class="lineno"><a class="line" href="namespacesrc_1_1molecule.html#a18b08895867e37ef3cb86a3d4456c775"> 1133</a></span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="stringliteral">    Special variables:  These variables cannot be set manually because</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="stringliteral">    there is a special method associated with getting them.</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="stringliteral">    na = The number of atoms.  You&#39;ll get this if you use MyMol.na or MyMol[&#39;na&#39;].</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="stringliteral">    ns = The number of snapshots.  You&#39;ll get this if you use MyMol.ns or MyMol[&#39;ns&#39;].</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="stringliteral">    Unit system:  Angstroms.</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;<span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    <span class="keyword">def </span>__init__(self, fnm = None, ftype = None, top = None, ttype = None, **kwargs):</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="stringliteral">        Create a Molecule object.</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="stringliteral">        fnm : str, optional</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="stringliteral">            File name to create the Molecule object from.  If provided,</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="stringliteral">            the file will be parsed and used to fill in the fields such as</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="stringliteral">            elem (elements), xyzs (coordinates) and so on.  If ftype is not</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="stringliteral">            provided, will automatically try to determine file type from file</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="stringliteral">            extension.  If not provided, will create an empty object.</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="stringliteral">        ftype : str, optional</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="stringliteral">            File type, corresponding to an entry in the internal table of known</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="stringliteral">            file types.  Provide this if you have a nonstandard file extension</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="stringliteral">            or if you wish to force to invoke a particular parser.</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="stringliteral">        top : str, optional</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="stringliteral">            &quot;Topology&quot; file name.  If provided, will build the Molecule</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="stringliteral">            using this file name, then &quot;fnm&quot; will load frames instead.</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="stringliteral">        ttype : str, optional</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="stringliteral">            &quot;Typology&quot; file type.</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="stringliteral">        build_topology : bool, optional</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="stringliteral">            Build the molecular topology consisting of: topology (overall connectivity graph),</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="stringliteral">            molecules (list of connected subgraphs), bonds (if not explicitly read in), default True</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="stringliteral">        toppbc : bool, optional</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="stringliteral">            Use periodic boundary conditions when building the molecular topology, default False</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="stringliteral">            The build_topology code will attempt to determine this intelligently.</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="stringliteral">        topframe : int, optional</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="stringliteral">            Provide a frame number for building the molecular topology, default first frame</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="stringliteral">        Fac : float, optional</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="stringliteral">            Multiplicative factor to covalent radii criterion for deciding whether two atoms are bonded</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;<span class="stringliteral">            Default value of 1.2 is reasonable, 1.4 will produce lots of bonds</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="stringliteral">        positive_resid : bool, optional</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="stringliteral">            If provided, enforce all positive resIDs.</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        <span class="comment"># If we passed in a &quot;topology&quot; file, read it in first, and then load the frames</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">if</span> top <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            load_fnm = fnm</div><div class="line"><a name="l01182"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html"> 1182</a></span>&#160;            load_type = ftype</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            fnm = top</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;            ftype = ttype</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            load_fnm = <span class="keywordtype">None</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;            load_type = <span class="keywordtype">None</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <span class="comment">#=========================================#</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        <span class="comment">#|           File type tables            |#</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        <span class="comment">#|    Feel free to edit these as more    |#</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        <span class="comment">#|      readers / writers are added      |#</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="comment">#=========================================#</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        </div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516">Read_Tab</a> = {<span class="stringliteral">&#39;gaussian&#39;</span> : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a742c96f62c86d00ac97bb5004f8ebd92">read_com</a>,</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                         <span class="stringliteral">&#39;gromacs&#39;</span>  : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4ce0cfbb42e84ec2fe5d8097d0ff5fda">read_gro</a>,</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                         <span class="stringliteral">&#39;charmm&#39;</span>   : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a3710f2055a57158a9b5fbab2c5943683">read_charmm</a>,</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                         <span class="stringliteral">&#39;dcd&#39;</span>      : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a258bc7b495910f9ff3bb552413207ecd">read_dcd</a>,</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                         <span class="stringliteral">&#39;mdcrd&#39;</span>    : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa7a40df32ff22ef52b902ac6a24dcb50">read_mdcrd</a>,</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                         <span class="stringliteral">&#39;inpcrd&#39;</span>   : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a25e54248bd35147e2c2aa210d06a58a5">read_inpcrd</a>,</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                         <span class="stringliteral">&#39;pdb&#39;</span>      : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af52f2ee9f9376925eab6e3309536e011">read_pdb</a>,</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                         <span class="stringliteral">&#39;xyz&#39;</span>      : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36a4504f013d86188435e01231235386">read_xyz</a>,</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                         <span class="stringliteral">&#39;qcschema&#39;</span> : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1b0681641dfbba1c2d182151b5e60f5d">read_qcschema</a>,</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                         <span class="stringliteral">&#39;mol2&#39;</span>     : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1d771e111c1cc4c8a0783b58081e282d">read_mol2</a>,</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                         <span class="stringliteral">&#39;qcin&#39;</span>     : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa9caaf6d7ccff3a9077da98b4c8096a9">read_qcin</a>,</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                         <span class="stringliteral">&#39;qcout&#39;</span>    : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a243cce870c970db8cac7f102325e872b">read_qcout</a>,</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                         <span class="stringliteral">&#39;qcesp&#39;</span>    : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a12369eb306cb29148e610e9ee08d7e2c">read_qcesp</a>,</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                         <span class="stringliteral">&#39;qdata&#39;</span>    : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a6c78338a640dbf1fd95c38f980203643">read_qdata</a>,</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                         <span class="stringliteral">&#39;tinker&#39;</span>   : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7e4057a5d9f4bb4a62cef21680f91327">read_arc</a>}</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        </div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0c2c1e8f6951f338e8ce2220a5d12045">Write_Tab</a> = {<span class="stringliteral">&#39;gromacs&#39;</span> : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#accdd08d1cdef8a51da59e1fc2268c7d8">write_gro</a>,</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                          <span class="stringliteral">&#39;xyz&#39;</span>     : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af42c16177cc7cbfce3c0b2be7b132480">write_xyz</a>,</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                          <span class="stringliteral">&#39;lammps&#39;</span>  : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7b85106cd6cc8e1d3e7e1ccb4edff551">write_lammps_data</a>,</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                          <span class="stringliteral">&#39;molproq&#39;</span> : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab74230360451f0feefcfceae3b292223">write_molproq</a>,</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                          <span class="stringliteral">&#39;dcd&#39;</span>     : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a722ba2597f067fc042169926c0b37274">write_dcd</a>,</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                          <span class="stringliteral">&#39;inpcrd&#39;</span>  : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af975f93f5c43f518b84d0bd067c75604">write_inpcrd</a>,</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                          <span class="stringliteral">&#39;mdcrd&#39;</span>   : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a94a0b29f772bb5e6e03383fd854ad70a">write_mdcrd</a>,</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                          <span class="stringliteral">&#39;pdb&#39;</span>     : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#adea929913736e69b7af631dc0014a1e7">write_pdb</a>,</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                          <span class="stringliteral">&#39;qcin&#39;</span>    : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a21d78053aab2fda1fd5e2577a02ec696">write_qcin</a>,</div><div class="line"><a name="l01219"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a8c3f5b48ac288e3b251b42d90c8f8016"> 1219</a></span>&#160;                          <span class="stringliteral">&#39;qdata&#39;</span>   : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac33547444f6fc81cae37ce37db9743ef">write_qdata</a>,</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                          <span class="stringliteral">&#39;tinker&#39;</span>  : self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5c04a001643a8165de635697f2d418f3">write_arc</a>}</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        </div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">Funnel</a>    = {<span class="stringliteral">&#39;gromos&#39;</span>  : <span class="stringliteral">&#39;gromacs&#39;</span>,</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                          <span class="stringliteral">&#39;gro&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                          <span class="stringliteral">&#39;g96&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                          <span class="stringliteral">&#39;gmx&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                          <span class="stringliteral">&#39;in&#39;</span>      : <span class="stringliteral">&#39;qcin&#39;</span>,</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                          <span class="stringliteral">&#39;qcin&#39;</span>    : <span class="stringliteral">&#39;qcin&#39;</span>,</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                          <span class="stringliteral">&#39;com&#39;</span>     : <span class="stringliteral">&#39;gaussian&#39;</span>,</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                          <span class="stringliteral">&#39;rst&#39;</span>     : <span class="stringliteral">&#39;inpcrd&#39;</span>,</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                          <span class="stringliteral">&#39;out&#39;</span>     : <span class="stringliteral">&#39;qcout&#39;</span>,</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                          <span class="stringliteral">&#39;esp&#39;</span>     : <span class="stringliteral">&#39;qcesp&#39;</span>,</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                          <span class="stringliteral">&#39;txt&#39;</span>     : <span class="stringliteral">&#39;qdata&#39;</span>,</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                          <span class="stringliteral">&#39;crd&#39;</span>     : <span class="stringliteral">&#39;charmm&#39;</span>,</div><div class="line"><a name="l01235"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516"> 1235</a></span>&#160;                          <span class="stringliteral">&#39;cor&#39;</span>     : <span class="stringliteral">&#39;charmm&#39;</span>,</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                          <span class="stringliteral">&#39;arc&#39;</span>     : <span class="stringliteral">&#39;tinker&#39;</span>}</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;        </div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a16ef842ad2eb3048d82d2303639e56e0">positive_resid</a> = kwargs.get(<span class="stringliteral">&#39;positive_resid&#39;</span>, 0)</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ae084bae0a4a0204c4d92fff5cbdbeee5">built_bonds</a> = <span class="keyword">False</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        </div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a> = {<span class="stringliteral">&#39;toppbc&#39;</span> : kwargs.get(<span class="stringliteral">&#39;toppbc&#39;</span>, <span class="keyword">False</span>),</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                             <span class="stringliteral">&#39;topframe&#39;</span> : kwargs.get(<span class="stringliteral">&#39;topframe&#39;</span>, 0),</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                             <span class="stringliteral">&#39;Fac&#39;</span> : kwargs.get(<span class="stringliteral">&#39;Fac&#39;</span>, 1.2),</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                             <span class="stringliteral">&#39;read_bonds&#39;</span> : <span class="keyword">False</span>,</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                             <span class="stringliteral">&#39;fragment&#39;</span> : kwargs.get(<span class="stringliteral">&#39;fragment&#39;</span>, <span class="keyword">False</span>),</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                             <span class="stringliteral">&#39;radii&#39;</span> : kwargs.get(<span class="stringliteral">&#39;radii&#39;</span>, {})}</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> set(list(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516">Read_Tab</a>.keys()) + list(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0c2c1e8f6951f338e8ce2220a5d12045">Write_Tab</a>.keys())):</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">Funnel</a>[i] = i</div><div class="line"><a name="l01251"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a0c2c1e8f6951f338e8ce2220a5d12045"> 1251</a></span>&#160;        <span class="comment"># Data container.  All of the data is stored in here.</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> = {}</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        </div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        <span class="keywordflow">if</span> fnm <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;fnm&#39;</span>] = fnm</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;            <span class="keywordflow">if</span> ftype <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                </div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                ftype = os.path.splitext(fnm)[1][1:]</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(fnm):</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                logger.error(<span class="stringliteral">&#39;Tried to create Molecule object from a file that does not exist: %s\n&#39;</span> % fnm)</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                <span class="keywordflow">raise</span> IOError</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;ftype&#39;</span>] = ftype</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            </div><div class="line"><a name="l01264"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8"> 1264</a></span>&#160;            Parsed = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516">Read_Tab</a>[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">Funnel</a>[ftype.lower()]](fnm, **kwargs)</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;            </div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> Parsed.items():</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] = val</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;            </div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [<span class="stringliteral">&#39;From %s: Frame %i / %i&#39;</span> % (fnm, i+1, self.ns) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_energies&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns):</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[i] += <span class="stringliteral">&#39;, Energy= % 18.10f&#39;</span> % self.qm_energies[i]</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [i.expandtabs() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>]</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            </div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;            <span class="keywordflow">if</span> kwargs.get(<span class="stringliteral">&#39;build_topology&#39;</span>, <span class="keyword">True</span>) <span class="keywordflow">and</span> hasattr(self, <span class="stringliteral">&#39;elem&#39;</span>) <span class="keywordflow">and</span> self.na &gt; 0:</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afae2c34b572e137801c8077f4267b247">build_topology</a>(force_bonds=<span class="keyword">False</span>)</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;        <span class="keywordflow">if</span> load_fnm <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01280"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a16ef842ad2eb3048d82d2303639e56e0"> 1280</a></span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a93e42cc0135d2a68354e384d6bc9185b">load_frames</a>(load_fnm, ftype=load_type, **kwargs)</div><div class="line"><a name="l01281"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ae084bae0a4a0204c4d92fff5cbdbeee5"> 1281</a></span>&#160;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l01283"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9"> 1283</a></span>&#160;    <span class="comment">#|     Core read/write functions     |#</span></div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="comment">#| Hopefully we won&#39;t have to change |#</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="comment">#|         these very often!         |#</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a23a3a5c340084abc00fb577d2b3c85c2">__len__</a>(self):</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return the number of frames in the trajectory. &quot;&quot;&quot;</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;        L = -1</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        klast = <span class="keywordtype">None</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        Defined = <span class="keyword">False</span></div><div class="line"><a name="l01293"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77"> 1293</a></span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;            Defined = <span class="keyword">True</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;            <span class="keywordflow">if</span> L != -1 <span class="keywordflow">and</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) != L:</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aaf70e66c397fd1e77644339ec81dfa9e">repair</a>(key, klast)</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;            L = len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            klast = key</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> Defined:</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            <span class="keywordflow">return</span> 0</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        <span class="keywordflow">return</span> L</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afbb728fb44c4465e4f53b26a64439165">__getattr__</a>(self, key):</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionary. &quot;&quot;&quot;</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;qm_forces&#39;</span>:</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            logger.warning(<span class="stringliteral">&#39;qm_forces is a deprecated keyword because it actually meant gradients; setting to qm_grads.&#39;</span>)</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;            key = <span class="stringliteral">&#39;qm_grads&#39;</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;ns&#39;</span>:</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            <span class="keywordflow">return</span> len(self)</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;na&#39;</span>: <span class="comment"># The &#39;na&#39; attribute is the number of atoms.</span></div><div class="line"><a name="l01311"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085"> 1311</a></span>&#160;            L = -1</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;            klast = <span class="keywordtype">None</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;            Defined = <span class="keyword">False</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;            <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                Defined = <span class="keyword">True</span></div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                <span class="keywordflow">if</span> L != -1 <span class="keywordflow">and</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) != L:</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aaf70e66c397fd1e77644339ec81dfa9e">repair</a>(key, klast)</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                L = len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                klast = key</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;            <span class="keywordflow">if</span> Defined:</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;                <span class="keywordflow">return</span> L</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                <span class="keywordflow">return</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[0])</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;                <span class="keywordflow">return</span> 0</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;            <span class="comment">#raise RuntimeError(&#39;na is ill-defined if the molecule has no AtomKeys member variables.&#39;)</span></div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        </div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;FrameKeys&#39;</span>:</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;            <span class="keywordflow">return</span> set(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>) &amp; FrameVariableNames</div><div class="line"><a name="l01331"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a23a3a5c340084abc00fb577d2b3c85c2"> 1331</a></span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;AtomKeys&#39;</span>:</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            <span class="keywordflow">return</span> set(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>) &amp; AtomVariableNames</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;MetaKeys&#39;</span>:</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            <span class="keywordflow">return</span> set(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>) &amp; MetaVariableNames</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;QuantumKeys&#39;</span>:</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;            <span class="keywordflow">return</span> set(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>) &amp; QuantumVariableNames</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;            <span class="keywordflow">return</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        <span class="keywordflow">return</span> getattr(super(Molecule, self), key)</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a73f8860755f337e3fafb91d074a7d459">__setattr__</a>(self, key, value):</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionary. &quot;&quot;&quot;</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        </div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;qm_forces&#39;</span>:</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;            logger.warning(<span class="stringliteral">&#39;qm_forces is a deprecated keyword because it actually meant gradients; setting to qm_grads.&#39;</span>)</div><div class="line"><a name="l01347"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#afbb728fb44c4465e4f53b26a64439165"> 1347</a></span>&#160;            key = <span class="stringliteral">&#39;qm_grads&#39;</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        <span class="keywordflow">if</span> key <span class="keywordflow">in</span> AllVariableNames:</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] = value</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <span class="keywordflow">return</span> super(Molecule,self).<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a73f8860755f337e3fafb91d074a7d459">__setattr__</a>(key, value)</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac40e3fd2c1f79e316be59016e7dfd253">__deepcopy__</a>(self, memo):</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Custom deepcopy method because Python 3.6 appears to have changed its behavior &quot;&quot;&quot;</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        <span class="comment"># Copy over variables that are not contained in self.Data</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;        New.positive_resid = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a16ef842ad2eb3048d82d2303639e56e0">positive_resid</a></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        New.built_bonds = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ae084bae0a4a0204c4d92fff5cbdbeee5">built_bonds</a></div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        New.top_settings = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>)</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;qm_grads&#39;</span>, <span class="stringliteral">&#39;qm_hessians&#39;</span>, <span class="stringliteral">&#39;qm_espxyzs&#39;</span>, <span class="stringliteral">&#39;qm_espvals&#39;</span>, <span class="stringliteral">&#39;qm_extchgs&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>, <span class="stringliteral">&#39;molecules&#39;</span>, <span class="stringliteral">&#39;qm_bondorder&#39;</span>]:</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                <span class="comment"># These variables are lists of NumPy arrays, NetworkX graph objects, or others with</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                <span class="comment"># explicitly defined copy() methods.</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                New.Data[key] = []</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])):</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                    New.Data[key].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i]))</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;topology&#39;</span>]:</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                <span class="comment"># These are NetworkX graph objects or other variables with explicitly defined copy() methods.</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                New.Data[key] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key].copy()</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;boxes&#39;</span>, <span class="stringliteral">&#39;qcrems&#39;</span>]:</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                <span class="comment"># We&#39;ll use the default deepcopy method for these:</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                <span class="comment"># boxes is a list of named tuples.</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                <span class="comment"># qcrems is a list of OrderedDicts.</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                New.Data[key] = []</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])):</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                    New.Data[key].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i]))</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;comms&#39;</span>, <span class="stringliteral">&#39;qm_energies&#39;</span>, <span class="stringliteral">&#39;qm_interaction&#39;</span>, <span class="stringliteral">&#39;qm_zpe&#39;</span>, <span class="stringliteral">&#39;qm_entropy&#39;</span>, <span class="stringliteral">&#39;qm_enthalpy&#39;</span>, <span class="stringliteral">&#39;elem&#39;</span>, <span class="stringliteral">&#39;partial_charge&#39;</span>,</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                         <span class="stringliteral">&#39;atomname&#39;</span>, <span class="stringliteral">&#39;atomtype&#39;</span>, <span class="stringliteral">&#39;tinkersuf&#39;</span>, <span class="stringliteral">&#39;resid&#39;</span>, <span class="stringliteral">&#39;resname&#39;</span>, <span class="stringliteral">&#39;qcsuf&#39;</span>, <span class="stringliteral">&#39;qm_ghost&#39;</span>, <span class="stringliteral">&#39;chain&#39;</span>, <span class="stringliteral">&#39;altloc&#39;</span>, <span class="stringliteral">&#39;icode&#39;</span>,</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                         <span class="stringliteral">&#39;terminal&#39;</span>]:</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key], list):</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Expected data attribute %s to be a list, but it is %s&#39;</span> % (key, str(type(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]))))</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                <span class="comment"># Lists of strings or floats.</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                New.Data[key] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][:]</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;fnm&#39;</span>, <span class="stringliteral">&#39;ftype&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>, <span class="stringliteral">&#39;qcerr&#39;</span>]:</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                <span class="comment"># These are strings, ints, or floats.</span></div><div class="line"><a name="l01386"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a73f8860755f337e3fafb91d074a7d459"> 1386</a></span>&#160;                New.Data[key] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;bonds&#39;</span>]:</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                <span class="comment"># List of lists of 2 integers.</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                New.Data[key] = []</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])):</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                    New.Data[key].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i][:])</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;qctemplate&#39;</span>]:</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                <span class="comment"># List of 2-tuples where the first element is a string</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;                <span class="comment"># (Q-Chem input section name) and the second element</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                <span class="comment"># is a list (Q-Chem input section data).</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                New.Data[key] = []</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                <span class="keywordflow">for</span> SectName, SectData <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]:</div><div class="line"><a name="l01398"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ac40e3fd2c1f79e316be59016e7dfd253"> 1398</a></span>&#160;                    New.Data[key].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>((SectName, SectData[:]))</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;Failed to copy key %s&quot;</span> % key)</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        <span class="keywordflow">return</span> New</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a30e057898525695364528d3b02c5762b">__getitem__</a>(self, key):</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="stringliteral">        The Molecule class has list-like behavior, so we can get slices of it.</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="stringliteral">        If we say MyMolecule[0:10], then we&#39;ll return a copy of MyMolecule with frames 0 through 9.</span></div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        <span class="keywordflow">if</span> isinstance(key, int) <span class="keywordflow">or</span> isinstance(key, slice) <span class="keywordflow">or</span> isinstance(key,np.ndarray) <span class="keywordflow">or</span> isinstance(key,list):</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            <span class="keywordflow">if</span> isinstance(key, int):</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                key = [key]</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;            New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                <span class="keywordflow">if</span> k == <span class="stringliteral">&#39;boxes&#39;</span>:</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                    New.Data[k] = [j <span class="keywordflow">for</span> i, j <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k]) <span class="keywordflow">if</span> i <span class="keywordflow">in</span> np.arange(len(self))[key]]</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                    New.Data[k] = list(np.array(copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k]))[key])</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.AtomKeys | self.MetaKeys:</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                New.Data[k] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k])</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;            New.top_settings = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>)</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;            <span class="keywordflow">return</span> New</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;            logger.error(<span class="stringliteral">&#39;getitem is not implemented for keys of type %s\n&#39;</span> % str(key))</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a31014aa4ca1b8259557bedd6d13a51aa">__delitem__</a>(self, key):</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;<span class="stringliteral">        Similarly, in order to delete a frame, we simply perform item deletion on</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;<span class="stringliteral">        framewise variables.</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            del self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k][key]</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a05079753fc6897507fa02eb4ef57fc77">__iter__</a>(self):</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; List-like behavior for looping over trajectories. Note that these values are returned by reference.</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="stringliteral">        Note that this is intended to be more efficient than __getitem__, so when we loop over a trajectory,</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;<span class="stringliteral">        it&#39;s best to go &quot;for m in M&quot; instead of &quot;for i in range(len(M)): m = M[i]&quot;</span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        <span class="keywordflow">for</span> frame <span class="keywordflow">in</span> range(self.ns):</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;            New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                New.Data[k] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k][frame]</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;            <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.AtomKeys | self.MetaKeys:</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;                New.Data[k] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k]</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;            <span class="keywordflow">yield</span> New</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a087212040303a4f62a3462106428cc38">__add__</a>(self,other):</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Add method for Molecule objects. &quot;&quot;&quot;</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="comment"># Check type of other</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(other,Molecule):</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;            logger.error(<span class="stringliteral">&#39;A Molecule instance can only be added to another Molecule instance\n&#39;</span>)</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;            <span class="keywordflow">raise</span> TypeError</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        <span class="comment"># Create the sum of the two classes by copying the first class.</span></div><div class="line"><a name="l01453"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a30e057898525695364528d3b02c5762b"> 1453</a></span>&#160;        Sum = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> AtomVariableNames | MetaVariableNames:</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;            <span class="comment"># Because a molecule object can only have one &#39;file name&#39; or &#39;file type&#39; attribute,</span></div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;            <span class="comment"># we only keep the original one.  This isn&#39;t perfect, but that&#39;s okay.</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;fnm&#39;</span>, <span class="stringliteral">&#39;ftype&#39;</span>, <span class="stringliteral">&#39;bonds&#39;</span>, <span class="stringliteral">&#39;molecules&#39;</span>, <span class="stringliteral">&#39;topology&#39;</span>] <span class="keywordflow">and</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;                Sum.Data[key] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;            <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a9de48d83dc7f53e25b86a4a6076e3185">diff</a>(self, other, key):</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;                <span class="keywordflow">for</span> i, j <span class="keywordflow">in</span> zip(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key], other.Data[key]):</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;                    logger.info(<span class="stringliteral">&quot;%s %s %s&quot;</span> % (i, j, str(i==j)))</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                logger.error(<span class="stringliteral">&#39;The data member called %s is not the same for these two objects\n&#39;</span> % key)</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                Sum.Data[key] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                Sum.Data[key] = copy.deepcopy(other.Data[key])</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> FrameVariableNames:</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;            <span class="keywordflow">if</span> <a class="code" href="namespacesrc_1_1molecule.html#a406a751e54f7e50da529c5d45f7f7de8">both</a>(self, other, key):</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                <span class="keywordflow">if</span> type(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s in self is a FrameKey, it must be a list\n&#39;</span> % key)</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                <span class="keywordflow">if</span> type(other.Data[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s in other is a FrameKey, it must be a list\n&#39;</span> % key)</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01476"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a31014aa4ca1b8259557bedd6d13a51aa"> 1476</a></span>&#160;                <span class="keywordflow">if</span> isinstance(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][0], np.ndarray):</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                    Sum.Data[key] = [i.copy() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]] + [i.copy() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> other.Data[key]]</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                    Sum.Data[key] = list(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] + other.Data[key])</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;            <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a53a3e04b9a57f9217a193d92c2062890">either</a>(self, other, key):</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                <span class="comment"># TINKER 6.3 compatibility - catch the specific case that one has a periodic box and the other doesn&#39;t.</span></div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;boxes&#39;</span>:</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                    <span class="keywordflow">if</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                        other.Data[<span class="stringliteral">&#39;boxes&#39;</span>] = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>][0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(other))]</div><div class="line"><a name="l01485"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a05079753fc6897507fa02eb4ef57fc77"> 1485</a></span>&#160;                    <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>] = [other.Data[<span class="stringliteral">&#39;boxes&#39;</span>][0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))]</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s is a FrameKey, must exist in both self and other for them to be added (for now).\n&#39;</span> % key)</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;        <span class="keywordflow">return</span> Sum</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4a1e6648a99afd550e7b24db3a2b249b">__iadd__</a>(self,other):</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Add method for Molecule objects. &quot;&quot;&quot;</span></div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        <span class="comment"># Check type of other</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(other,Molecule):</div><div class="line"><a name="l01496"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a087212040303a4f62a3462106428cc38"> 1496</a></span>&#160;            logger.error(<span class="stringliteral">&#39;A Molecule instance can only be added to another Molecule instance\n&#39;</span>)</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;            <span class="keywordflow">raise</span> TypeError</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        <span class="comment"># Create the sum of the two classes by copying the first class.</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> AtomVariableNames | MetaVariableNames:</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;fnm&#39;</span>, <span class="stringliteral">&#39;ftype&#39;</span>, <span class="stringliteral">&#39;bonds&#39;</span>, <span class="stringliteral">&#39;molecules&#39;</span>, <span class="stringliteral">&#39;topology&#39;</span>]: <span class="keywordflow">pass</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a9de48d83dc7f53e25b86a4a6076e3185">diff</a>(self, other, key):</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                <span class="keywordflow">for</span> i, j <span class="keywordflow">in</span> zip(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key], other.Data[key]):</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                    logger.info(<span class="stringliteral">&quot;%s %s %s&quot;</span> % (i, j, str(i==j)))</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                logger.error(<span class="stringliteral">&#39;The data member called %s is not the same for these two objects\n&#39;</span> % key)</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;            <span class="comment"># Information from the other class is added to this class (if said info doesn&#39;t exist.)</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;            <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] = copy.deepcopy(other.Data[key])</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;        <span class="comment"># FrameKeys must be a list.</span></div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> FrameVariableNames:</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            <span class="keywordflow">if</span> <a class="code" href="namespacesrc_1_1molecule.html#a406a751e54f7e50da529c5d45f7f7de8">both</a>(self, other, key):</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                <span class="keywordflow">if</span> type(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s in self is a FrameKey, it must be a list\n&#39;</span> % key)</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                <span class="keywordflow">if</span> type(other.Data[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s in other is a FrameKey, it must be a list\n&#39;</span> % key)</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                <span class="keywordflow">if</span> isinstance(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][0], np.ndarray):</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] += [i.copy() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> other.Data[key]]</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] += other.Data[key]</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;            <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a53a3e04b9a57f9217a193d92c2062890">either</a>(self, other, key):</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                <span class="comment"># TINKER 6.3 compatibility - catch the specific case that one has a periodic box and the other doesn&#39;t.</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;boxes&#39;</span>:</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                    <span class="keywordflow">if</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                        other.Data[<span class="stringliteral">&#39;boxes&#39;</span>] = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>][0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(other))]</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                    <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>] = [other.Data[<span class="stringliteral">&#39;boxes&#39;</span>][0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))]</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                    logger.error(<span class="stringliteral">&#39;Key %s is a FrameKey, must exist in both self and other for them to be added (for now).\n&#39;</span> % key)</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        <span class="keywordflow">return</span> self</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aaf70e66c397fd1e77644339ec81dfa9e">repair</a>(self, key, klast):</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Attempt to repair trivial issues that would otherwise break the object. &quot;&quot;&quot;</span></div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        kthis = key <span class="keywordflow">if</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) &lt; len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[klast]) <span class="keywordflow">else</span> klast</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        kother = klast <span class="keywordflow">if</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) &lt; len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[klast]) <span class="keywordflow">else</span> key</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;        diff = abs(len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) - len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[klast]))</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        <span class="keywordflow">if</span> kthis == <span class="stringliteral">&#39;comms&#39;</span>:</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            <span class="comment"># Append empty comments if necessary because this causes way too many crashes.</span></div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            <span class="keywordflow">if</span> diff &gt; 0:</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(diff):</div><div class="line"><a name="l01543"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a4a1e6648a99afd550e7b24db3a2b249b"> 1543</a></span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;comms&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(-1*diff):</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;comms&#39;</span>].pop()</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        <span class="keywordflow">elif</span> kthis == <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">and</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>]) == 1:</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;            <span class="comment"># If we only have one box then we can fill in the rest of the trajectory.</span></div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(diff): self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;boxes&#39;</span>][-1])</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;            logger.error(<span class="stringliteral">&#39;The keys %s and %s have different lengths (%i %i)&#39;</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                         <span class="stringliteral">&#39;- this isn\&#39;t supposed to happen for two AtomKeys member variables.&#39;</span></div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                         % (key, klast, len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]), len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[klast])))</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a16dcb06bf37392ef659cc156e0b61688">reorder_according_to</a>(self, other):</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="stringliteral">        Reorder atoms according to some other Molecule object.  This</span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="stringliteral">        happens when we run a program like pdb2gmx or pdbxyz and it</span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;<span class="stringliteral">        scrambles our atom ordering, forcing us to reorder the atoms</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="stringliteral">        for all frames in the current Molecule object.</span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="stringliteral">        Directions:</span></div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;<span class="stringliteral">        (1) Load up the scrambled file as a new Molecule object.</span></div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;<span class="stringliteral">        (2) Call this function: Original_Molecule.reorder_according_to(scrambled)</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="stringliteral">        (3) Save Original_Molecule to a new file name.</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;        M = self[0]</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        N = other</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;        unmangled       = <a class="code" href="namespacesrc_1_1molecule.html#a784faffc34b87c6f72db0f4915e1a355">unmangle</a>(M, N)</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;        NewData = {}</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;            NewData[key] = list(np.array(M.Data[key])[unmangled])</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;qm_grads&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>]:</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;                NewData[key] = list([self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i][unmangled] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))])</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> NewData:</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;            setattr(self, key, copy.deepcopy(NewData[key]))</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9f764980b8a0df810aa7264036617975">reorder_indices</a>(self, other):</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;</div><div class="line"><a name="l01586"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aaf70e66c397fd1e77644339ec81dfa9e"> 1586</a></span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;<span class="stringliteral">        Return the indices that would reorder atoms according to some</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;<span class="stringliteral">        other Molecule object.  This happens when we run a program</span></div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="stringliteral">        like pdb2gmx or pdbxyz and it scrambles our atom ordering.</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="stringliteral">        Directions:</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="stringliteral">        (1) Load up the scrambled file as a new Molecule object.</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="stringliteral">        (2) Call this function: Original_Molecule.reorder_indices(scrambled)</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#a784faffc34b87c6f72db0f4915e1a355">unmangle</a>(self[0], other)</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(self,other):</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;        self += other</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(self, *args):</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;        <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args:</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;            <span class="keywordflow">if</span> arg == <span class="stringliteral">&#39;na&#39;</span>: <span class="comment"># The &#39;na&#39; attribute is the number of atoms.</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;na&#39;</span>):</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                    <span class="keywordflow">continue</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            <span class="keywordflow">if</span> arg == <span class="stringliteral">&#39;qm_forces&#39;</span>:</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                logger.warning(<span class="stringliteral">&#39;qm_forces is a deprecated keyword because it actually meant gradients; setting to qm_grads.&#39;</span>)</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                arg = <span class="stringliteral">&#39;qm_grads&#39;</span></div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            <span class="keywordflow">if</span> arg <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                logger.error(<span class="stringliteral">&quot;%s is a required attribute for writing this type of file but it&#39;s not present\n&quot;</span> % arg)</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="comment"># def read(self, fnm, ftype = None):</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    <span class="comment">#     &quot;&quot;&quot; Read in a file. &quot;&quot;&quot;</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;    <span class="comment">#     if ftype is None:</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    <span class="comment">#         ## Try to determine from the file name using the extension.</span></div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    <span class="comment">#         ftype = os.path.splitext(fnm)[1][1:]</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;    <span class="comment">#     ## This calls the table of reader functions and prints out an error message if it fails.</span></div><div class="line"><a name="l01621"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a16dcb06bf37392ef659cc156e0b61688"> 1621</a></span>&#160;    <span class="comment">#     ## &#39;Answer&#39; is a dictionary of data that is returned from the reader function.</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    <span class="comment">#     Answer = self.Read_Tab[self.Funnel[ftype.lower()]](fnm)</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <span class="comment">#     return Answer</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a557af72409188133ef446ee8dbed2338">write</a>(self,fnm=None,ftype=None,append=False,selection=None,**kwargs):</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="keywordflow">if</span> fnm <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> ftype <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            logger.error(<span class="stringliteral">&quot;Output file name and file type are not specified.\n&quot;</span>)</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        <span class="keywordflow">elif</span> ftype <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;            ftype = os.path.splitext(fnm)[1][1:]</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        </div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [<span class="stringliteral">&#39;Generated by %s from %s: Frame %i of %i&#39;</span> % (package, fnm, i+1, self.ns) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>) &lt; len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>):</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>), len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>)):</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(<span class="stringliteral">&quot;Frame %i: generated by %s&quot;</span> % (i, package))</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        </div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a96266112f8af20de9810e2fee0d5861c">fout</a> = fnm</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;        <span class="keywordflow">if</span> type(selection) <span class="keywordflow">in</span> [int, np.int64, np.int32]:</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;            selection = [selection]</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">if</span> selection <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            selection = list(range(len(self)))</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;            selection = list(selection)</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        Answer = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0c2c1e8f6951f338e8ce2220a5d12045">Write_Tab</a>[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">Funnel</a>[ftype.lower()]](selection,**kwargs)</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        </div><div class="line"><a name="l01648"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a9f764980b8a0df810aa7264036617975"> 1648</a></span>&#160;        <span class="keywordflow">if</span> Answer <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;            <span class="keywordflow">if</span> fnm <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> fnm == sys.stdout:</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;                outfile = sys.stdout</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;            <span class="keywordflow">elif</span> append:</div><div class="line"><a name="l01652"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe"> 1652</a></span>&#160;                <span class="comment"># Writing to symbolic links risks unintentionally overwriting the source file -</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                <span class="comment"># thus we delete the link first.</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;                <span class="keywordflow">if</span> os.path.islink(fnm):</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                    os.unlink(fnm)</div><div class="line"><a name="l01656"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae"> 1656</a></span>&#160;                outfile = open(fnm,<span class="stringliteral">&#39;a&#39;</span>)</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;                <span class="keywordflow">if</span> os.path.islink(fnm):</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;                    os.unlink(fnm)</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;                outfile = open(fnm,<span class="stringliteral">&#39;w&#39;</span>)</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;            <span class="keywordflow">for</span> line <span class="keywordflow">in</span> Answer:</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                print(line, file=outfile)</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;            outfile.close()</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    <span class="comment">#|         Useful functions          |#</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    <span class="comment">#|     For doing useful things       |#</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">center_of_mass</a>(self):</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;        totMass = sum([PeriodicTable.get(self.elem[i], 0.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)])</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;        <span class="keywordflow">return</span> np.array([np.sum([xyz[i,:] * PeriodicTable.get(self.elem[i], 0.0) / totMass <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(xyz.shape[0])],axis=0) <span class="keywordflow">for</span> xyz <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>])</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a972ec8931555662db70e0f6acaa009ca">radius_of_gyration</a>(self):</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        totMass = sum([PeriodicTable[self.elem[i]] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)])</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        coms = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">center_of_mass</a>()</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        rgs = []</div><div class="line"><a name="l01678"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a557af72409188133ef446ee8dbed2338"> 1678</a></span>&#160;        <span class="keywordflow">for</span> i, xyz <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>):</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;            xyz1 = xyz.copy()</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;            xyz1 -= coms[i]</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            rgs.append(np.sqrt(np.sum([PeriodicTable[self.elem[i]]*np.dot(x,x) <span class="keywordflow">for</span> i, x <span class="keywordflow">in</span> enumerate(xyz1)])/totMass))</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        <span class="keywordflow">return</span> np.array(rgs)</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a6b6551ae13458225d8fc8d117112e23f">rigid_water</a>(self):</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; If one atom is oxygen and the next two are hydrogen, make the water molecule rigid. &quot;&quot;&quot;</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;elem&#39;</span>, <span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self)):</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            <span class="keywordflow">for</span> a <span class="keywordflow">in</span> range(self.na-2):</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;                <span class="keywordflow">if</span> self.elem[a] == <span class="stringliteral">&#39;O&#39;</span> <span class="keywordflow">and</span> self.elem[a+1] == <span class="stringliteral">&#39;H&#39;</span> <span class="keywordflow">and</span> self.elem[a+2] == <span class="stringliteral">&#39;H&#39;</span>:</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;                    flex = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i]</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;                    wat = flex[a:a+3]</div><div class="line"><a name="l01692"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a96266112f8af20de9810e2fee0d5861c"> 1692</a></span>&#160;                    com = wat.mean(0)</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;                    wat -= com</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;                    o  = wat[0]</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;                    h1 = wat[1]</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;                    h2 = wat[2]</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;                    r1 = h1 - o</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;                    r2 = h2 - o</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;                    r1 /= np.linalg.norm(r1)</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;                    r2 /= np.linalg.norm(r2)</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                    <span class="comment"># Obtain unit vectors.</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;                    ex = r1 + r2</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;                    ey = r1 - r2</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;                    ex /= np.linalg.norm(ex)</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;                    ey /= np.linalg.norm(ey)</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;                    Bond = 0.9572</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                    Ang = np.pi * 104.52 / 2 / 180</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;                    cosx = np.cos(Ang)</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                    cosy = np.sin(Ang)</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                    h1 = o + Bond*ex*cosx + Bond*ey*cosy</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;                    h2 = o + Bond*ex*cosx - Bond*ey*cosy</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;                    rig = np.array([o, h1, h2]) + com</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i][a:a+3] = rig</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a93e42cc0135d2a68354e384d6bc9185b">load_frames</a>(self, fnm, ftype=None, **kwargs):</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        </div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        <span class="keywordflow">if</span> fnm <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;            <span class="keywordflow">if</span> ftype <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;                </div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;                ftype = os.path.splitext(fnm)[1][1:]</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(fnm):</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                logger.error(<span class="stringliteral">&#39;Tried to create Molecule object from a file that does not exist: %s\n&#39;</span> % fnm)</div><div class="line"><a name="l01723"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697"> 1723</a></span>&#160;                <span class="keywordflow">raise</span> IOError</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;            </div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;            Parsed = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516">Read_Tab</a>[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">Funnel</a>[ftype.lower()]](fnm, **kwargs)</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> Parsed:</div><div class="line"><a name="l01727"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a972ec8931555662db70e0f6acaa009ca"> 1727</a></span>&#160;                logger.error(<span class="stringliteral">&#39;Did not get any coordinates from the new file %s\n&#39;</span> % fnm)</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;            <span class="keywordflow">if</span> Parsed[<span class="stringliteral">&#39;xyzs&#39;</span>][0].shape[0] != self.na:</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;                logger.error(<span class="stringliteral">&#39;When loading frames, don\&#39;t change the number of atoms\n&#39;</span>)</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;            </div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;            <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> Parsed.items():</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;                <span class="keywordflow">if</span> key <span class="keywordflow">in</span> FrameVariableNames:</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] = val</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;            </div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [<span class="stringliteral">&#39;Generated by %s from %s: Frame %i of %i&#39;</span> % (package, fnm, i+1, self.ns) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]</div><div class="line"><a name="l01739"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a6b6551ae13458225d8fc8d117112e23f"> 1739</a></span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [i.expandtabs() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>]</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ad47b76d0fe660f2cfafceb67f358a5c2">edit_qcrems</a>(self, in_dict, subcalc = None):</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Edit Q-Chem rem variables with a dictionary.  Pass a value of None to delete a rem variable. &quot;&quot;&quot;</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        <span class="keywordflow">if</span> subcalc <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;            <span class="keywordflow">for</span> qcrem <span class="keywordflow">in</span> self.qcrems:</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> in_dict.items():</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;                    <span class="keywordflow">if</span> val <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;                        qcrem.pop(key, <span class="keywordtype">None</span>)</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;                        qcrem[key] = val</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;            <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> in_dict.items():</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;                <span class="keywordflow">if</span> val <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                    self.qcrems[subcalc].pop(key, <span class="keywordtype">None</span>)</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;                    self.qcrems[subcalc][key] = val</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab863d592cf9369137d6298eb005556c9">add_quantum</a>(self, other):</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        <span class="keywordflow">if</span> type(other) <span class="keywordflow">is</span> Molecule:</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;            OtherMol = other</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;        <span class="keywordflow">elif</span> type(other) <span class="keywordflow">is</span> str:</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;            OtherMol = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>(other)</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> OtherMol.QuantumKeys:</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> AtomVariableNames <span class="keywordflow">and</span> len(OtherMol.Data[key]) != self.na:</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;                logger.error(<span class="stringliteral">&#39;The quantum-key %s is AtomData, but it doesn\&#39;t have the same number of atoms as the Molecule object we\&#39;re adding it to.&#39;</span>)</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] = copy.deepcopy(OtherMol.Data[key])</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div><div class="line"><a name="l01769"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a93e42cc0135d2a68354e384d6bc9185b"> 1769</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afa69c71616ba48c2641d3e2b5914b6d9">add_virtual_site</a>(self, idx, **kwargs):</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Add a virtual site to the system.  This does NOT set the position of the virtual site; it sits at the origin. &quot;&quot;&quot;</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> kwargs:</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key].insert(idx,kwargs[key])</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;                logger.error(<span class="stringliteral">&#39;You need to specify %s when adding a virtual site to this molecule.\n&#39;</span> % key)</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;            <span class="keywordflow">for</span> i, xyz <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>):</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;pos&#39;</span> <span class="keywordflow">in</span> kwargs:</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i] = np.insert(xyz, idx, xyz[kwargs[<span class="stringliteral">&#39;pos&#39;</span>]], axis=0)</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i] = np.insert(xyz, idx, 0.0, axis=0)</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;            logger.error(<span class="stringliteral">&#39;You need to have xyzs in this molecule to add a virtual site.\n&#39;</span>)</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a10b21e9ed15d4d1d3242a2696a939e61">replace_peratom</a>(self, key, orig, want):</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Replace all of the data for a certain attribute in the system from orig to want. &quot;&quot;&quot;</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        <span class="keywordflow">if</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i] == orig:</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i] = want</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;            logger.error(<span class="stringliteral">&#39;The key that we want to replace (%s) doesn\&#39;t exist.\n&#39;</span> % key)</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a958636d732433ffc356a1f7a1e70d7d7">replace_peratom_conditional</a>(self, key1, cond, key2, orig, want):</div><div class="line"><a name="l01798"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ad47b76d0fe660f2cfafceb67f358a5c2"> 1798</a></span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Replace all of the data for a attribute key2 from orig to want, contingent on key1 being equal to cond.</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="stringliteral">        For instance: replace H1 with H2 if resname is SOL.&quot;&quot;&quot;</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;        <span class="keywordflow">if</span> key2 <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> key1 <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key2][i] == orig <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key1][i] == cond:</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key2][i] = want</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;            logger.error(<span class="stringliteral">&#39;Either the comparison or replacement key (%s, %s) doesn\&#39;t exist.\n&#39;</span> % (key1, key2))</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af7b405613971e5d76720b1a655e05981">atom_select</a>(self,atomslice,build_topology=True):</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a copy of the object with certain atoms selected.  Takes an integer, list or array as argument. &quot;&quot;&quot;</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        <span class="keywordflow">if</span> isinstance(atomslice, int):</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;            atomslice = [atomslice]</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;        <span class="keywordflow">if</span> isinstance(atomslice, list):</div><div class="line"><a name="l01813"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ab863d592cf9369137d6298eb005556c9"> 1813</a></span>&#160;            atomslice = np.array(atomslice)</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys | self.MetaKeys:</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;            New.Data[key] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;            <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;tinkersuf&#39;</span>: <span class="comment"># Tinker suffix is a bit tricky</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;                Map = dict([(a+1, i+1) <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(atomslice)])</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;                CopySuf = list(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])[atomslice])</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;                NewSuf = []</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;                <span class="keywordflow">for</span> line <span class="keywordflow">in</span> CopySuf:</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;                    whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;                    s           = line.split()</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;                    <span class="keywordflow">if</span> len(s) &gt; 1:</div><div class="line"><a name="l01826"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#afa69c71616ba48c2641d3e2b5914b6d9"> 1826</a></span>&#160;                        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,len(s)):</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;                            s[i] = str(Map[int(s[i])])</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;                    sn = [int(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> s[1:]]</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;                    s = [s[0]] + list(np.array(s[1:])[np.argsort(sn)])</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;                    NewSuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+s[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(s))]))</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;                New.Data[<span class="stringliteral">&#39;tinkersuf&#39;</span>] = NewSuf[:]</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;                New.Data[key] = list(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])[atomslice])</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys:</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;           <span class="keywordflow">if</span> key <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;qm_grads&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>]:</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;               New.Data[key] = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key][i][atomslice] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))]</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;            New.Data[<span class="stringliteral">&#39;bonds&#39;</span>] = [(list(atomslice).index(b[0]), list(atomslice).index(b[1])) <span class="keywordflow">for</span> b <span class="keywordflow">in</span> self.bonds <span class="keywordflow">if</span> (b[0] <span class="keywordflow">in</span> atomslice <span class="keywordflow">and</span> b[1] <span class="keywordflow">in</span> atomslice)]</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;        New.top_settings = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a></div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;        <span class="keywordflow">if</span> build_topology:</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;            New.build_topology(force_bonds=<span class="keyword">False</span>)</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        <span class="keywordflow">return</span> New</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a06d6ebbb45f759c58b30f6c7c084c3e5">atom_stack</a>(self, other):</div><div class="line"><a name="l01845"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a10b21e9ed15d4d1d3242a2696a939e61"> 1845</a></span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a copy of the object with another molecule object appended.  WARNING: This function may invalidate stuff like QM energies. &quot;&quot;&quot;</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;        <span class="keywordflow">if</span> len(other) != len(self):</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;            logger.error(<span class="stringliteral">&#39;The number of frames of the Molecule objects being stacked are not equal.\n&#39;</span>)</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;        New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys | self.MetaKeys:</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;            New.Data[key] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;        <span class="comment"># This is how we&#39;re going to stack things like Cartesian coordinates and QM forces.</span></div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;        <span class="keyword">def </span>FrameStack(k):</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;            <span class="keywordflow">if</span> k <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> k <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01857"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a958636d732433ffc356a1f7a1e70d7d7"> 1857</a></span>&#160;                New.Data[k] = [np.vstack((s, o)) <span class="keywordflow">for</span> s, o <span class="keywordflow">in</span> zip(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[k], other.Data[k])]</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;qm_grads&#39;</span>, <span class="stringliteral">&#39;qm_hessians&#39;</span>, <span class="stringliteral">&#39;qm_espxyzs&#39;</span>, <span class="stringliteral">&#39;qm_espvals&#39;</span>, <span class="stringliteral">&#39;qm_extchgs&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>]:</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;            FrameStack(i)</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        <span class="comment"># Now build the new atom keys.</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">not</span> <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;                logger.error(<span class="stringliteral">&#39;Trying to stack two Molecule objects - the first object contains %s and the other does not\n&#39;</span> % key)</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;tinkersuf&#39;</span>: <span class="comment"># Tinker suffix is a bit tricky</span></div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;                NewSuf = []</div><div class="line"><a name="l01868"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af7b405613971e5d76720b1a655e05981"> 1868</a></span>&#160;                <span class="keywordflow">for</span> line <span class="keywordflow">in</span> other.Data[key]:</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                    whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;                    s           = line.split()</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;                    <span class="keywordflow">if</span> len(s) &gt; 1:</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;                        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,len(s)):</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;                            s[i] = str(int(s[i]) + self.na)</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;                    NewSuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+s[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(s))]))</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;                New.Data[key] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) + NewSuf</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;                <span class="keywordflow">if</span> type(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) <span class="keywordflow">is</span> np.ndarray:</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;                    New.Data[key] = np.concatenate((self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key], other.Data[key]))</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;                <span class="keywordflow">elif</span> type(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key]) <span class="keywordflow">is</span> list:</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;                    New.Data[key] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key] + other.Data[key]</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;                    logger.error(<span class="stringliteral">&#39;Cannot stack %s because it is of type %s\n&#39;</span> % (key, str(type(New.Data[key]))))</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> other.Data:</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;            New.Data[<span class="stringliteral">&#39;bonds&#39;</span>] = self.bonds + [(b[0]+self.na, b[1]+self.na) <span class="keywordflow">for</span> b <span class="keywordflow">in</span> other.bonds]</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        <span class="keywordflow">return</span> New</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a73446a192061fe52b26899005e3bbc31">align_by_moments</a>(self):</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Align molecules using the moment of inertia.</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="stringliteral">        Departs from MSMBuilder convention of</span></div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="stringliteral">        using arithmetic mean for mass. &quot;&quot;&quot;</span></div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        coms  = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">center_of_mass</a>()</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;        xyz1  = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[0]</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;        xyz1 -= coms[0]</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;        xyz1  = <a class="code" href="namespacesrc_1_1molecule.html#a06bd27c59ccdbde31fbefbdec2daf1ad">AlignToMoments</a>(self.elem,xyz1)</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;        <span class="keywordflow">for</span> index2, xyz2 <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>):</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;            xyz2 -= coms[index2]</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;            xyz2 = <a class="code" href="namespacesrc_1_1molecule.html#a06bd27c59ccdbde31fbefbdec2daf1ad">AlignToMoments</a>(self.elem,xyz1,xyz2)</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[index2] = xyz2</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a692df3c446a2c9517ab4a3d2a9e7b373">get_populations</a>(self):</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a cloned molecule object but with X-coordinates set</span></div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;<span class="stringliteral">        to Mulliken charges and Y-coordinates set to Mulliken</span></div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="stringliteral">        spins. &quot;&quot;&quot;</span></div><div class="line"><a name="l01905"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a06d6ebbb45f759c58b30f6c7c084c3e5"> 1905</a></span>&#160;        QS = copy.deepcopy(self)</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;        QSxyz = np.array(QS.xyzs)</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        QSxyz[:, :, 0] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab59ba8cf9a0b9e525428723c813d15c8">qm_mulliken_charges</a></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        QSxyz[:, :, 1] = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abdc7b61bb516d9f57aff156ec09b19bf">qm_mulliken_spins</a></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;        QSxyz[:, :, 2] *= 0.0</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        QS.xyzs = list(QSxyz)</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <span class="keywordflow">return</span> QS</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af2cf7dad143a2cca4cfa651c82185c3d">load_popxyz</a>(self, fnm):</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Given a charge-spin xyz file, load the charges (x-coordinate) and spins (y-coordinate) into internal arrays. &quot;&quot;&quot;</span></div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;        QS = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>(fnm, ftype=<span class="stringliteral">&#39;xyz&#39;</span>, build_topology = <span class="keyword">False</span>)</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab59ba8cf9a0b9e525428723c813d15c8">qm_mulliken_charges</a> = list(np.array(QS.xyzs)[:, :, 0])</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abdc7b61bb516d9f57aff156ec09b19bf">qm_mulliken_spins</a> = list(np.array(QS.xyzs)[:, :, 1])</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ad74d00f84b4b0b66b18de8a3f6b41c88">align</a>(self, smooth = False, center = True, center_mass = False, atom_select=None):</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Align molecules.</span></div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;<span class="stringliteral">        Has the option to create smooth trajectories</span></div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="stringliteral">        (align each frame to the previous one)</span></div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;<span class="stringliteral">        or to align each frame to the first one.</span></div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;<span class="stringliteral">        Also has the option to remove the center of mass.</span></div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="stringliteral">        Provide a list of atom indices to align along selected atoms.</span></div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;        <span class="keywordflow">if</span> isinstance(atom_select, list):</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;            atom_select = np.array(atom_select)</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <span class="keywordflow">if</span> center <span class="keywordflow">and</span> center_mass:</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;            logger.error(<span class="stringliteral">&#39;Specify center=True or center_mass=True but set the other one to False\n&#39;</span>)</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        coms = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">center_of_mass</a>()</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;        xyz1 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[0]</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        <span class="keywordflow">if</span> center:</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;            xyz1 -= xyz1.mean(0)</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;        <span class="keywordflow">elif</span> center_mass:</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;            xyz1 -= coms[0]</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;        <span class="keywordflow">for</span> index2, xyz2 <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>):</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;            <span class="keywordflow">if</span> index2 == 0: <span class="keywordflow">continue</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;            xyz2 -= xyz2.mean(0)</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;            <span class="keywordflow">if</span> smooth:</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;                ref = index2-1</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;                ref = 0</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;            <span class="keywordflow">if</span> atom_select <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;                tr, rt = <a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(xyz2[atom_select],self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[ref][atom_select])</div><div class="line"><a name="l01952"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a73446a192061fe52b26899005e3bbc31"> 1952</a></span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;                tr, rt = <a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(xyz2,self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[ref])</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;            xyz2 = np.dot(xyz2, rt) + tr</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[index2] = xyz2</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a3a4d580584a25a74ec835bf6b09ded81">center</a>(self, center_mass = False):</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Move geometric center to the origin. &quot;&quot;&quot;</span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        <span class="keywordflow">if</span> center_mass:</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;            coms = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">center_of_mass</a>()</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self)):</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i] -= coms[i]</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self)):</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i] -= self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i].mean(0)</div><div class="line"><a name="l01966"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a692df3c446a2c9517ab4a3d2a9e7b373"> 1966</a></span>&#160;</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a55418dce14e7b54da5ccfa96b0c564d4">build_bonds</a>(self):</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Build the bond connectivity graph. &quot;&quot;&quot;</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;        sn = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;topframe&#39;</span>]</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;        toppbc = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;toppbc&#39;</span>]</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        Fac = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;Fac&#39;</span>]</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        mindist = 1.0 <span class="comment"># Any two atoms that are closer than this distance are bonded.</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        <span class="comment"># Create an atom-wise list of covalent radii.</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;        <span class="comment"># Molecule object can have its own set of radii that overrides the global ones</span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        R = np.array([self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;radii&#39;</span>].get(i, (Radii[Elements.index(i)-1] <span class="keywordflow">if</span> i <span class="keywordflow">in</span> Elements <span class="keywordflow">else</span> 0.0)) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.elem])</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        <span class="comment"># Create a list of 2-tuples corresponding to combinations of atomic indices using a grid algorithm.</span></div><div class="line"><a name="l01977"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af2cf7dad143a2cca4cfa651c82185c3d"> 1977</a></span>&#160;        mins = np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn],axis=0)</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        maxs = np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn],axis=0)</div><div class="line"><a name="l01979"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ab59ba8cf9a0b9e525428723c813d15c8"> 1979</a></span>&#160;        <span class="comment"># Grid size in Angstrom.  This number is optimized for speed in a 15,000 atom system (united atom pentadecane).</span></div><div class="line"><a name="l01980"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#abdc7b61bb516d9f57aff156ec09b19bf"> 1980</a></span>&#160;        gsz = 6.0</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;        <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;boxes&#39;</span>):</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;            xmin = 0.0</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;            ymin = 0.0</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;            zmin = 0.0</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;            xmax = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].a</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;            ymax = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].b</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;            zmax = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].c</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;            <span class="keywordflow">if</span> any([i != 90.0 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].alpha, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].beta, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].gamma]]):</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;                logger.warning(<span class="stringliteral">&quot;Warning: Topology building will not work with broken molecules in nonorthogonal cells.&quot;</span>)</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;                toppbc = <span class="keyword">False</span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;            xmin = mins[0]</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;            ymin = mins[1]</div><div class="line"><a name="l01994"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ad74d00f84b4b0b66b18de8a3f6b41c88"> 1994</a></span>&#160;            zmin = mins[2]</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;            xmax = maxs[0]</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;            ymax = maxs[1]</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;            zmax = maxs[2]</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;            toppbc = <span class="keyword">False</span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;        xext = xmax-xmin</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        yext = ymax-ymin</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        zext = zmax-zmin</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;        <span class="keywordflow">if</span> toppbc:</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;            gszx = xext/int(xext/gsz)</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;            gszy = yext/int(yext/gsz)</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;            gszz = zext/int(zext/gsz)</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;            gszx = gsz</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;            gszy = gsz</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;            gszz = gsz</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;        <span class="comment"># Run algorithm to determine bonds.</span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;        <span class="comment"># Decide if we want to use the grid algorithm.</span></div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;        use_grid = toppbc <span class="keywordflow">or</span> (np.min([xext, yext, zext]) &gt; 2.0*gsz)</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;        <span class="keywordflow">if</span> use_grid:</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;            <span class="comment"># Inside the grid algorithm.</span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;            <span class="comment"># 1) Determine the left edges of the grid cells.</span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;            <span class="comment"># Note that we leave out the rightmost grid cell,</span></div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;            <span class="comment"># because this may cause spurious partitionings.</span></div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;            xgrd = np.arange(xmin, xmax-gszx, gszx)</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;            ygrd = np.arange(ymin, ymax-gszy, gszy)</div><div class="line"><a name="l02023"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a3a4d580584a25a74ec835bf6b09ded81"> 2023</a></span>&#160;            zgrd = np.arange(zmin, zmax-gszz, gszz)</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;            <span class="comment"># 2) Grid cells are denoted by a three-index tuple.</span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;            gidx = list(itertools.product(range(len(xgrd)), range(len(ygrd)), range(len(zgrd))))</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;            <span class="comment"># 3) Build a dictionary which maps a grid cell to itself plus its neighboring grid cells.</span></div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;            <span class="comment"># Two grid cells are defined to be neighbors if the differences between their x, y, z indices are at most 1.</span></div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;            gngh = OrderedDict()</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;            amax = np.array(gidx[-1])</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;            amin = np.array(gidx[0])</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;            n27 = np.array(list(itertools.product([-1,0,1],repeat=3)))</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> gidx:</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;                gngh[i] = []</div><div class="line"><a name="l02034"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a55418dce14e7b54da5ccfa96b0c564d4"> 2034</a></span>&#160;                ai = np.array(i)</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> n27:</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;                    nj = ai+j</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;                    <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(3):</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                        mod = amax[k]-amin[k]+1</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;                        <span class="keywordflow">if</span> nj[k] &lt; amin[k]:</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                            nj[k] += mod</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                        <span class="keywordflow">elif</span> nj[k] &gt; amax[k]:</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;                            nj[k] -= mod</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                    gngh[i].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(tuple(nj))</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;            <span class="comment"># 4) Loop over the atoms and assign each to a grid cell.</span></div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;            <span class="comment"># Note: I think this step becomes the bottleneck if we choose very small grid sizes.</span></div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;            gasn = OrderedDict([(i, []) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> gidx])</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                xidx = -1</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                yidx = -1</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                zidx = -1</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> xgrd:</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                    xi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i][0]</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                    <span class="keywordflow">while</span> xi &lt; xmin: xi += xext</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;                    <span class="keywordflow">while</span> xi &gt; xmax: xi -= xext</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;                    <span class="keywordflow">if</span> xi &lt; j: <span class="keywordflow">break</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;                    xidx += 1</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> ygrd:</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;                    yi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i][1]</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;                    <span class="keywordflow">while</span> yi &lt; ymin: yi += yext</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                    <span class="keywordflow">while</span> yi &gt; ymax: yi -= yext</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;                    <span class="keywordflow">if</span> yi &lt; j: <span class="keywordflow">break</span></div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;                    yidx += 1</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> zgrd:</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;                    zi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i][2]</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;                    <span class="keywordflow">while</span> zi &lt; zmin: zi += zext</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;                    <span class="keywordflow">while</span> zi &gt; zmax: zi -= zext</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;                    <span class="keywordflow">if</span> zi &lt; j: <span class="keywordflow">break</span></div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;                    zidx += 1</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;                gasn[(xidx,yidx,zidx)].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(i)</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;            <span class="comment"># 5) Create list of 2-tuples corresponding to combinations of atomic indices.</span></div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;            <span class="comment"># This is done by looping over pairs of neighboring grid cells and getting Cartesian products of atom indices inside.</span></div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;            <span class="comment"># It may be possible to get a 2x speedup by eliminating forward-reverse pairs (e.g. (5, 4) and (4, 5) and duplicates (5,5).)</span></div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;            AtomIterator = []</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> gasn:</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;                <span class="keywordflow">for</span> j <span class="keywordflow">in</span> gngh[i]:</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;                    apairs = <a class="code" href="namespacesrc_1_1molecule.html#a8d9cdc5fd67e79c8b1edac8159d2e370">cartesian_product2</a>([gasn[i], gasn[j]])</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                    <span class="keywordflow">if</span> len(apairs) &gt; 0: AtomIterator.append(apairs[apairs[:,0]&gt;apairs[:,1]])</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;            AtomIterator = np.ascontiguousarray(np.vstack(AtomIterator))</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;            <span class="comment"># Create a list of 2-tuples corresponding to combinations of atomic indices.</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;            <span class="comment"># This is much faster than using itertools.combinations.</span></div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;            AtomIterator = np.ascontiguousarray(np.vstack((np.fromiter(itertools.chain(*[[i]*(self.na-i-1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32), np.fromiter(itertools.chain(*[range(i+1,self.na) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32))).T)</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;        <span class="comment"># Create a list of thresholds for determining whether a certain interatomic distance is considered to be a bond.</span></div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;        BT0 = R[AtomIterator[:,0]]</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;        BT1 = R[AtomIterator[:,1]]</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;        BondThresh = (BT0+BT1) * Fac</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        BondThresh = (BondThresh &gt; mindist) * BondThresh + (BondThresh &lt; mindist) * mindist</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;boxes&#39;</span>) <span class="keywordflow">and</span> toppbc:</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;            dxij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][np.newaxis, :], AtomIterator, box=np.array([[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[sn].c]]))[0]</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;            dxij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][np.newaxis, :], AtomIterator)[0]</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;        <span class="comment"># Update topology settings with what we learned</span></div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;toppbc&#39;</span>] = toppbc</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        <span class="comment"># Create a list of atoms that each atom is bonded to.</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;        atom_bonds = [[] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        bond_bool = dxij &lt; BondThresh</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;        <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(bond_bool):</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;            <span class="keywordflow">if</span> <span class="keywordflow">not</span> a: <span class="keywordflow">continue</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;            (ii, jj) = AtomIterator[i]</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;            <span class="keywordflow">if</span> ii == jj: <span class="keywordflow">continue</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;            atom_bonds[ii].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(jj)</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;            atom_bonds[jj].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(ii)</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        bondlist = []</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;        <span class="keywordflow">for</span> i, bi <span class="keywordflow">in</span> enumerate(atom_bonds):</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;            <span class="keywordflow">for</span> j <span class="keywordflow">in</span> bi:</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;                <span class="keywordflow">if</span> i == j: <span class="keywordflow">continue</span></div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;                <span class="comment"># Do not add a bond between resids if fragment is set to True.</span></div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;fragment&#39;</span>] <span class="keywordflow">and</span> <span class="stringliteral">&#39;resid&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>.keys() <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[i] != self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[j] : <span class="keywordflow">continue</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;                <span class="keywordflow">elif</span> i &lt; j:</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;                    bondlist.append((i, j))</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;                    bondlist.append((j, i))</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;        bondlist = sorted(list(set(bondlist)))</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;bonds&#39;</span>] = sorted(list(set(bondlist)))</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ae084bae0a4a0204c4d92fff5cbdbeee5">built_bonds</a> = <span class="keyword">True</span></div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afae2c34b572e137801c8077f4267b247">build_topology</a>(self, force_bonds=True, **kwargs):</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;<span class="stringliteral">        Create self.topology and self.molecules; these are graph</span></div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="stringliteral">        representations of the individual molecules (fragments)</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="stringliteral">        contained in the Molecule object.</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="stringliteral">        force_bonds : bool</span></div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="stringliteral">            Build the bonds from interatomic distances.  If the user</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;<span class="stringliteral">            calls build_topology from outside, assume this is the</span></div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="stringliteral">            default behavior.  If creating a Molecule object using</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;<span class="stringliteral">            __init__, do not force the building of bonds by default</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="stringliteral">            (only build bonds if not read from file.)</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="stringliteral">        topframe : int, optional</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;<span class="stringliteral">            Provide the frame number used for reading the bonds.  If</span></div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="stringliteral">            not provided, this will be taken from the top_settings</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="stringliteral">            field.  If provided, this will take priority and write</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="stringliteral">            the value into top_settings.</span></div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;        sn = kwargs.get(<span class="stringliteral">&#39;topframe&#39;</span>, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;topframe&#39;</span>])</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;topframe&#39;</span>] = sn</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;        <span class="keywordflow">if</span> self.na &gt; 100000:</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;            logger.warning(<span class="stringliteral">&quot;Warning: Large number of atoms (%i), topology building may take a long time&quot;</span> % self.na)</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;        <span class="comment"># Build bonds from connectivity graph if not read from file.</span></div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        <span class="keywordflow">if</span> (<span class="keywordflow">not</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&#39;read_bonds&#39;</span>]) <span class="keywordflow">or</span> force_bonds:</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a55418dce14e7b54da5ccfa96b0c564d4">build_bonds</a>()</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;        <span class="comment"># Create a NetworkX graph object to hold the bonds.</span></div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;        G = MyG()</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;        <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(self.elem):</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;            G.add_node(i)</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;            <span class="keywordflow">if</span> parse_version(nx.__version__) &gt;= parse_version(<span class="stringliteral">&#39;2.0&#39;</span>):</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;                    nx.set_node_attributes(G,{i:self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[i]}, name=<span class="stringliteral">&#39;n&#39;</span>)</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;                nx.set_node_attributes(G,{i:a}, name=<span class="stringliteral">&#39;e&#39;</span>)</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;                nx.set_node_attributes(G,{i:self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i]}, name=<span class="stringliteral">&#39;x&#39;</span>)</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;                    nx.set_node_attributes(G,<span class="stringliteral">&#39;n&#39;</span>,{i:self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[i]})</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;                nx.set_node_attributes(G,<span class="stringliteral">&#39;e&#39;</span>,{i:a})</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;                nx.set_node_attributes(G,<span class="stringliteral">&#39;x&#39;</span>,{i:self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i]})</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;        <span class="keywordflow">for</span> (i, j) <span class="keywordflow">in</span> self.bonds:</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;            G.add_edge(i, j)</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        <span class="comment"># The Topology is simply the NetworkX graph object.</span></div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a> = G</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        <span class="comment"># LPW: Molecule.molecules is a funny misnomer... it should be fragments or substructures or something</span></div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">molecules</a> = [G.subgraph(c).copy() <span class="keywordflow">for</span> c <span class="keywordflow">in</span> nx.connected_components(G)]</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <span class="keywordflow">for</span> g <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">molecules</a>: g.__class__ = MyG</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;        <span class="comment"># Deprecated in networkx 2.2</span></div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;        <span class="comment"># self.molecules = list(nx.connected_component_subgraphs(G))</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac9ca356c6a6ea6d5b470d819ab473f84">distance_matrix</a>(self, pbc=True):</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Obtain distance matrix between all pairs of atoms. &quot;&quot;&quot;</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;        AtomIterator = np.ascontiguousarray(np.vstack((np.fromiter(itertools.chain(*[[i]*(self.na-i-1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32),</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;                                                       np.fromiter(itertools.chain(*[range(i+1,self.na) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32))).T)</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;        <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;boxes&#39;</span>) <span class="keywordflow">and</span> pbc:</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;            boxes = np.array([[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].c] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))])</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;            drij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator, box=boxes)</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;            drij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator)</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;        <span class="keywordflow">return</span> AtomIterator, list(drij)</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a29b2035c5e476fb22707d6c17eaf5e3e">distance_displacement</a>(self):</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Obtain distance matrix and displacement vectors between all pairs of atoms. &quot;&quot;&quot;</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;        AtomIterator = np.ascontiguousarray(np.vstack((np.fromiter(itertools.chain(*[[i]*(self.na-i-1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32),</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;                                                       np.fromiter(itertools.chain(*[range(i+1,self.na) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32))).T)</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;        <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;boxes&#39;</span>) <span class="keywordflow">and</span> pbc:</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;            boxes = np.array([[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].c] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))])</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;            drij, dxij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator, box=boxes, displace=<span class="keyword">True</span>)</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;            drij, dxij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator, box=<span class="keywordtype">None</span>, displace=<span class="keyword">True</span>)</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        <span class="keywordflow">return</span> AtomIterator, list(drij), list(dxij)</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ae8aa53ace87ec66daf8264b2add069c3">rotate_bond</a>(self, frame, aj, ak, increment=15):</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; </span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="stringliteral">        Return a new Molecule object containing the selected frame</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;<span class="stringliteral">        plus a number of frames where the selected dihedral angle is rotated</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;<span class="stringliteral">        in steps of &#39;increment&#39; given in degrees.</span></div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;<span class="stringliteral">        </span></div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;<span class="stringliteral">        This function is designed to be called by Molecule.rotate_check_clash().</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;<span class="stringliteral">        frame : int</span></div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;<span class="stringliteral">            Structure number of the current Molecule to be rotated</span></div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;<span class="stringliteral">        aj, ak : int</span></div><div class="line"><a name="l02208"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#afae2c34b572e137801c8077f4267b247"> 2208</a></span>&#160;<span class="stringliteral">            Atom numbers of the bond to be rotated</span></div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="stringliteral">        increment : float</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;<span class="stringliteral">            Degrees of the rotation increment</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;<span class="stringliteral">        </span></div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;<span class="stringliteral">        Returns</span></div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;<span class="stringliteral">        -------</span></div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="stringliteral">        Molecule</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;<span class="stringliteral">            New Molecule object containing the rotated structures</span></div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;        <span class="comment"># Select the single frame containing the structure to be rotated.</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;        M = self[frame]</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;        <span class="comment"># Delete the connection between atoms to be rotated in order</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        <span class="comment"># to determine the rotation fragments.</span></div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;        delBonds = []</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;        <span class="keywordflow">for</span> ibond, bond <span class="keywordflow">in</span> enumerate(M.bonds):</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;            <span class="keywordflow">if</span> bond == (aj, ak) <span class="keywordflow">or</span> bond == (ak, aj):</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                delBonds.append(bond)</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;        <span class="keywordflow">if</span> len(delBonds) &gt; 1:</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Expected only one bond to be deleted&#39;</span>)</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;        <span class="keywordflow">if</span> len(M.molecules) != 1:</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Expected a single molecule&#39;</span>)</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        M.bonds.remove(delBonds[0])</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;        M.top_settings[<span class="stringliteral">&#39;read_bonds&#39;</span>]=<span class="keyword">True</span></div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        M.build_topology(force_bonds=<span class="keyword">False</span>)</div><div class="line"><a name="l02233"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987"> 2233</a></span>&#160;        <span class="keywordflow">if</span> len(M.molecules) != 2:</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Expected two molecules after removing a bond&#39;</span>)</div><div class="line"><a name="l02235"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d"> 2235</a></span>&#160;</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;        <span class="comment"># gAtoms contains the set of atoms to be rotated</span></div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;        <span class="comment"># oAtoms contains the &quot;other&quot; atoms</span></div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;        <span class="keywordflow">if</span> len(M.molecules[0].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()) &lt; len(M.molecules[1].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()):</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;            gAtoms = M.molecules[0].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;            oAtoms = M.molecules[1].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02242"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ac9ca356c6a6ea6d5b470d819ab473f84"> 2242</a></span>&#160;            gAtoms = M.molecules[1].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;            oAtoms = M.molecules[0].<a class="code" href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">L</a>()</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;        <span class="comment"># atom2 is the &quot;reference atom&quot; on the group being rotated</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;        <span class="comment"># and will be moved to the origin during the rotation operation</span></div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;        <span class="keywordflow">if</span> aj <span class="keywordflow">in</span> gAtoms:</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;            atom1 = ak</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;            atom2 = aj</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;            atom1 = aj</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;            atom2 = ak</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;        M.bonds.append(delBonds[0])</div><div class="line"><a name="l02254"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a29b2035c5e476fb22707d6c17eaf5e3e"> 2254</a></span>&#160;        </div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;        <span class="comment"># Rotation axis</span></div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;        axis = M.xyzs[0][atom2] - M.xyzs[0][atom1]</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;    </div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;        <span class="comment"># Move the &quot;reference atom&quot; to the origin</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        x0 = M.xyzs[0][gAtoms]</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;        x0_ref = M.xyzs[0][atom2]</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;        x0 -= x0_ref</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    </div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;        <span class="comment"># Create grid in rotation angle</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;        <span class="comment"># and the rotated structures</span></div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        <span class="keywordflow">for</span> thetaDeg <span class="keywordflow">in</span> np.arange(increment, 360, increment):</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;            theta = np.pi * thetaDeg / 180</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;            <span class="comment"># Make quaternion</span></div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;            R = <a class="code" href="namespacesrc_1_1molecule.html#a18b08895867e37ef3cb86a3d4456c775">axis_angle</a>(axis, theta)</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;            <span class="comment"># Get rotated coordinates</span></div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;            x0_rot = np.dot(R, x0.T).T</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;            <span class="comment"># Copy old coordinates to new</span></div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;            xnew = M.xyzs[0].copy()</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;            <span class="comment"># Write rotated positions into new coordinates;</span></div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;            <span class="comment"># shift back to original positions</span></div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;            xnew[gAtoms] = x0_rot + x0_ref</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;            <span class="comment"># Append new coordinates to our Molecule object</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;            M.xyzs.append(xnew)</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;            M.comms.append(<span class="stringliteral">&quot;Rotated by %.2f degrees&quot;</span> % increment)</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        <span class="keywordflow">return</span> M, (gAtoms, oAtoms)</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a201a811c87574b4e229880540e4e6ef9">find_clashes</a>(self, thre=0.0, pbc=True, groups=None):</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; </span></div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;<span class="stringliteral">        Obtain a list of atoms that &#39;clash&#39; (i.e. are more than</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="stringliteral">        3 bonds apart and are closer than the provided threshold.)</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02286"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ae8aa53ace87ec66daf8264b2add069c3"> 2286</a></span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="stringliteral">        thre : float</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="stringliteral">            Create a sorted-list of all non-bonded atom pairs </span></div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="stringliteral">            with distance below this threshold</span></div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="stringliteral">        pbc : bool</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="stringliteral">            Whether to use PBC when computing interatomic distances</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="stringliteral">        filt : tuple (group1, group2)</span></div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="stringliteral">            If not None, only compute distances between atoms in &#39;group1&#39;</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;<span class="stringliteral">            and atoms in &#39;group2&#39;. For example this could be [gAtoms, oAtoms]</span></div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="stringliteral">            from rotate_bond</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="stringliteral">        Returns</span></div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="stringliteral">        -------</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="stringliteral">        minPair_frames : list of tuples</span></div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="stringliteral">           The closest pair of non-bonded atoms in each frame</span></div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="stringliteral">        minDist_frames : list of tuples</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="stringliteral">           The distance between the closest pair of non-bonded atoms in each frame</span></div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="stringliteral">        clashPairs_frames : list of lists</span></div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="stringliteral">           Pairs of non-bonded atoms with distance below the threshold in each frame</span></div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="stringliteral">        clashDists_frames : list of lists</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="stringliteral">           Distances between pairs of non-bonded atoms below the threshold in each frame</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;        <span class="keywordflow">if</span> groups <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;            AtomIterator = np.ascontiguousarray([[min(g), max(g)] <span class="keywordflow">for</span> g <span class="keywordflow">in</span> itertools.product(groups[0], groups[1])])</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;            AtomIterator = np.ascontiguousarray(np.vstack((np.fromiter(itertools.chain(*[[i]*(self.na-i-1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32),</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;                                                           np.fromiter(itertools.chain(*[range(i+1,self.na) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=np.int32))).T)</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;        ang13 = [(min(a[0], a[2]), max(a[0], a[2])) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac89b40e6c15282d3c685e80672a01cbf">find_angles</a>()]</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;        dih14 = [(min(d[0], d[3]), max(d[0], d[3])) <span class="keywordflow">for</span> d <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac07431c9d938d6f0e24e71beef9119c5">find_dihedrals</a>()]</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;        bondedPairs = np.where([tuple(aPair) <span class="keywordflow">in</span> (self.bonds+ang13+dih14) <span class="keywordflow">for</span> aPair <span class="keywordflow">in</span> AtomIterator])[0]</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;        AtomIterator_nb = np.delete(AtomIterator, bondedPairs, axis=0)</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        minPair_frames = []</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;        minDist_frames = []</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;        clashPairs_frames = []</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;        clashDists_frames = []</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;        <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;boxes&#39;</span>) <span class="keywordflow">and</span> pbc:</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;            boxes = np.array([[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[i].c] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self))])</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;            drij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator_nb, box=boxes)</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;            drij = <a class="code" href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">AtomContact</a>(np.array(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>), AtomIterator_nb)</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;        <span class="keywordflow">for</span> frame <span class="keywordflow">in</span> range(len(self)):</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;            clashPairIdx = np.where(drij[frame] &lt; thre)[0]</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;            clashPairs = AtomIterator_nb[clashPairIdx]</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;            clashDists = drij[frame, clashPairIdx]</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;            sorter = np.argsort(clashDists)</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;            clashPairs = clashPairs[sorter]</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;            clashDists = clashDists[sorter]</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;            minIdx = np.argmin(drij[frame])</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;            minPair = AtomIterator_nb[minIdx]</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;            minDist = drij[frame, minIdx]</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;            minPair_frames.append(minPair)</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;            minDist_frames.append(minDist)</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;            clashPairs_frames.append(clashPairs.copy())</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;            clashDists_frames.append(clashDists.copy())</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;        <span class="keywordflow">return</span> minPair_frames, minDist_frames, clashPairs_frames, clashDists_frames</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a011f4f4e9170d8f3c86adf61453142ce">rotate_check_clash</a>(self, frame, rotate_index, thresh_hyd=1.4, thresh_hvy=1.8, printLevel=1):</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; </span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="stringliteral">        Return a new Molecule object containing the selected frame </span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;<span class="stringliteral">        plus a number of frames where the selected dihedral angle is rotated</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="stringliteral">        in steps of &#39;increment&#39; given in degrees.  Additionally, check for</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="stringliteral">        if pairs of non-bonded atoms &quot;clash&quot; i.e. approach below the specified</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;<span class="stringliteral">        thresholds.</span></div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;<span class="stringliteral">        frame : int</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;<span class="stringliteral">            Structure number of the current Molecule to be rotated</span></div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;<span class="stringliteral">            (if only a single frame, this number should be 0)</span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="stringliteral">        rotate_index : tuple</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;<span class="stringliteral">            4 atom indices (ai, aj, ak, al) representing the dihedral angle to be rotated.</span></div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;<span class="stringliteral">            The first and last indices are used to measure the dihedral angle.</span></div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="stringliteral">        thresh_hyd : float</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="stringliteral">            Clash threshold for hydrogen atoms.  Reasonable values are in between 1.3 and 2.0.</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="stringliteral">        thresh_hvy : float</span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="stringliteral">            Clash threshold for heavy atoms.  Reasonable values are in between 1.7 and 2.5.</span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;<span class="stringliteral">        printLevel: int</span></div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;<span class="stringliteral">            Sets the amount of printout (larger = more printout)</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;<span class="stringliteral">        </span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="stringliteral">        Returns</span></div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="stringliteral">        -------</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="stringliteral">        Molecule</span></div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;<span class="stringliteral">            New Molecule object containing the rotated structures</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;<span class="stringliteral">        Success : bool</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;<span class="stringliteral">            True if no clashes</span></div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> hasattr(self, <span class="stringliteral">&#39;atomname&#39;</span>):</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;Please add atom names before calling rotate_check_clash().&quot;</span>)</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        ai, aj, ak, al = rotate_index</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;        Success = <span class="keyword">False</span></div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;        <span class="comment"># Create grid of rotated structures</span></div><div class="line"><a name="l02379"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a201a811c87574b4e229880540e4e6ef9"> 2379</a></span>&#160;        M_rot_H, frags = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ae8aa53ace87ec66daf8264b2add069c3">rotate_bond</a>(frame, aj, ak, 15)</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        phis = M_rot_H.measure_dihedrals(*rotate_index)</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(M_rot_H)):</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;            M_rot_H.comms[i] = (<span class="stringliteral">&#39;Rigid scan: atomname %s, serial %s, dihedral %.3f&#39;</span> </div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;                                % (<span class="stringliteral">&#39;-&#39;</span>.join([self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> rotate_index]), </div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;                                   <span class="stringliteral">&#39;-&#39;</span>.join([<span class="stringliteral">&quot;%i&quot;</span> % (i+1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> rotate_index]), phis[i]))</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;        heavyIdx = [i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na) <span class="keywordflow">if</span> self.elem[i] != <span class="stringliteral">&#39;H&#39;</span>]</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;        heavy_frags = [[],[]]</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;        <span class="keywordflow">for</span> iHeavy, iAll <span class="keywordflow">in</span> enumerate(heavyIdx):</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;            <span class="keywordflow">if</span> iAll <span class="keywordflow">in</span> frags[0]:</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;                heavy_frags[0].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(iHeavy)</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;            <span class="keywordflow">if</span> iAll <span class="keywordflow">in</span> frags[1]:</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;                heavy_frags[1].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(iHeavy)</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        M_rot_C = M_rot_H.atom_select(heavyIdx)</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        minPair_H_frames, minDist_H_frames, clashPairs_H_frames, clashDists_H_frames = M_rot_H.find_clashes(thre=thresh_hyd, groups=frags)</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;        minPair_C_frames, minDist_C_frames, clashPairs_C_frames, clashDists_C_frames = M_rot_C.find_clashes(thre=thresh_hvy, groups=heavy_frags)</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        <span class="comment"># Get the following information: (1) Whether a clash exists, (2) the frame with the smallest distance,</span></div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;        <span class="comment"># (3) the pair of atoms with the smallest distance, (4) the smallest distance</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        haveClash_H = any([len(c) &gt; 0 <span class="keywordflow">for</span> c <span class="keywordflow">in</span> clashPairs_H_frames])</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        minFrame_H = np.argmin(minDist_H_frames)</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        minAtoms_H = minPair_H_frames[minFrame_H]</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;        minDist_H = minDist_H_frames[minFrame_H]</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        haveClash_C = any([len(c) &gt; 0 <span class="keywordflow">for</span> c <span class="keywordflow">in</span> clashPairs_C_frames])</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;        minFrame_C = np.argmin(minDist_C_frames)</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;        minAtoms_C = minPair_C_frames[minFrame_C]</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;        minDist_C = minDist_C_frames[minFrame_C]</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> (haveClash_H <span class="keywordflow">or</span> haveClash_C):</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;            <span class="keywordflow">if</span> printLevel &gt;= 1: </div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;                print(<span class="stringliteral">&quot;\n    \x1b[1;92mSuccess - no clashes. Thresh(H, Hvy) = (%.2f, %.2f)\x1b[0m&quot;</span> % (thresh_hyd, thresh_hvy))</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;                mini = M_rot_H.atomname[minAtoms_H[0]]</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;                minj = M_rot_H.atomname[minAtoms_H[1]]</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;                print(<span class="stringliteral">&quot;    Closest (Hyd) : rot-frame %i atoms %s-%s %.2f&quot;</span> % (minFrame_H, mini, minj, minDist_H))</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;                mini = M_rot_C.atomname[minAtoms_C[0]]</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;                minj = M_rot_C.atomname[minAtoms_C[1]]</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;                print(<span class="stringliteral">&quot;    Closest (Hvy) : rot-frame %i atoms %s-%s %.2f&quot;</span> % (minFrame_C, mini, minj, minDist_C))</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;            Success = <span class="keyword">True</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;            <span class="keywordflow">if</span> haveClash_H:</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;                mini = M_rot_H.atomname[minAtoms_H[0]]</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;                minj = M_rot_H.atomname[minAtoms_H[1]]</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;                <span class="keywordflow">if</span> printLevel &gt;= 2: print(<span class="stringliteral">&quot;    Clash (Hyd) : rot-frame %i atoms %s-%s %.2f&quot;</span> % (minFrame_H, mini, minj, minDist_H))</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;            <span class="keywordflow">if</span> haveClash_C:</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;                mini = M_rot_C.atomname[minAtoms_C[0]]</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;                minj = M_rot_C.atomname[minAtoms_C[1]]</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;                <span class="keywordflow">if</span> printLevel &gt;= 2: print(<span class="stringliteral">&quot;    Clash (Hvy) : rot-frame %i atoms %s-%s %.2f&quot;</span> % (minFrame_C, mini, minj, minDist_C))</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;        <span class="keywordflow">return</span> M_rot_H, Success</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac89b40e6c15282d3c685e80672a01cbf">find_angles</a>(self):</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a list of 3-tuples corresponding to all of the</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;<span class="stringliteral">        angles in the system.  Verified for lysine and tryptophan</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="stringliteral">        dipeptide when comparing to TINKER&#39;s analyze program. &quot;&quot;&quot;</span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> hasattr(self, <span class="stringliteral">&#39;topology&#39;</span>):</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;            logger.error(<span class="stringliteral">&quot;Need to have built a topology to find angles\n&quot;</span>)</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;        angidx = []</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;        <span class="comment"># Iterate over separate molecules</span></div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;        <span class="keywordflow">for</span> mol <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">molecules</a>:</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;            <span class="comment"># Iterate over atoms in the molecule</span></div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;            <span class="keywordflow">for</span> a2 <span class="keywordflow">in</span> list(mol.nodes()):</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;                <span class="comment"># Find all bonded neighbors to this atom</span></div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                friends = sorted(list(nx.neighbors(mol, a2)))</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;                <span class="keywordflow">if</span> len(friends) &lt; 2: <span class="keywordflow">continue</span></div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;                <span class="comment"># Double loop over bonded neighbors</span></div><div class="line"><a name="l02445"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a011f4f4e9170d8f3c86adf61453142ce"> 2445</a></span>&#160;                <span class="keywordflow">for</span> i, a1 <span class="keywordflow">in</span> enumerate(friends):</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;                    <span class="keywordflow">for</span> a3 <span class="keywordflow">in</span> friends[i+1:]:</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;                        <span class="comment"># Add bonded atoms in the correct order</span></div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;                        angidx.append((a1, a2, a3))</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;        <span class="keywordflow">return</span> angidx</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac07431c9d938d6f0e24e71beef9119c5">find_dihedrals</a>(self):</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a list of 4-tuples corresponding to all of the</span></div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="stringliteral">        dihedral angles in the system.  Verified for alanine and</span></div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;<span class="stringliteral">        tryptophan dipeptide when comparing to TINKER&#39;s analyze</span></div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="stringliteral">        program. &quot;&quot;&quot;</span></div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> hasattr(self, <span class="stringliteral">&#39;topology&#39;</span>):</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;            logger.error(<span class="stringliteral">&quot;Need to have built a topology to find dihedrals\n&quot;</span>)</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;        dihidx = []</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        <span class="comment"># Iterate over separate molecules</span></div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        <span class="keywordflow">for</span> mol <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">molecules</a>:</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;            <span class="comment"># Iterate over bonds in the molecule</span></div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;            <span class="keywordflow">for</span> edge <span class="keywordflow">in</span> list(mol.edges()):</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;                <span class="comment"># Determine correct ordering of atoms (middle atoms are ordered by convention)</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;                a2 = edge[0] <span class="keywordflow">if</span> edge[0] &lt; edge[1] <span class="keywordflow">else</span> edge[1]</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;                a3 = edge[1] <span class="keywordflow">if</span> edge[0] &lt; edge[1] <span class="keywordflow">else</span> edge[0]</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;                <span class="keywordflow">for</span> a1 <span class="keywordflow">in</span> sorted(list(nx.neighbors(mol, a2))):</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;                    <span class="keywordflow">if</span> a1 != a3:</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;                        <span class="keywordflow">for</span> a4 <span class="keywordflow">in</span> sorted(list(nx.neighbors(mol, a3))):</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;                            <span class="keywordflow">if</span> a4 != a2 <span class="keywordflow">and</span> len({a1, a2, a3, a4}) == 4:</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;                                dihidx.append((a1, a2, a3, a4))</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;        <span class="keywordflow">return</span> dihidx</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;</div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a2a818455c2439cd42f7489d3f811eb72">measure_distances</a>(self, i, j):</div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;        distances = []</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;        <span class="keywordflow">for</span> s <span class="keywordflow">in</span> range(self.ns):</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;            x1 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][i]</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;            x2 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][j]</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;            distance = np.linalg.norm(x1-x2)</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;            distances.append(distance)</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;        <span class="keywordflow">return</span> distances</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ad9a055066973a760e4898581224736b0">measure_angles</a>(self, i, j, k):</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;        angles = []</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;        <span class="keywordflow">for</span> s <span class="keywordflow">in</span> range(self.ns):</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;            x1 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][i]</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;            x2 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][j]</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;            x3 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][k]</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;            v1 = x1-x2</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;            v2 = x3-x2</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;            n = np.dot(v1,v2)/(np.linalg.norm(v1)*np.linalg.norm(v2))</div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;            angle = np.arccos(n)</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;            angles.append(angle * 180/ np.pi)</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;        <span class="keywordflow">return</span> angles</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4c1539dbe8854e261e7dbdb4a6fa0a98">measure_dihedrals</a>(self, i, j, k, l):</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Return a series of dihedral angles, given four atom indices numbered from zero. &quot;&quot;&quot;</span></div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;        phis = []</div><div class="line"><a name="l02502"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ac89b40e6c15282d3c685e80672a01cbf"> 2502</a></span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;            <span class="keywordflow">if</span> any(p <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.bonds <span class="keywordflow">for</span> p <span class="keywordflow">in</span> [(min(i,j),max(i,j)),(min(j,k),max(j,k)),(min(k,l),max(k,l))]):</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;                logger.warning([(min(i,j),max(i,j)),(min(j,k),max(j,k)),(min(k,l),max(k,l))])</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;                logger.warning(<span class="stringliteral">&quot;Measuring dihedral angle for four atoms that aren&#39;t bonded.  Hope you know what you&#39;re doing!&quot;</span>)</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;            logger.warning(<span class="stringliteral">&quot;This molecule object doesn&#39;t have bonds defined, sanity-checking is off.&quot;</span>)</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;        <span class="keywordflow">for</span> s <span class="keywordflow">in</span> range(self.ns):</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;            x4 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][l]</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;            x3 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][k]</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;            x2 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][j]</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;            x1 = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[s][i]</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;            v1 = x2-x1</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;            v2 = x3-x2</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;            v3 = x4-x3</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;            t1 = np.linalg.norm(v2)*np.dot(v1,np.cross(v2,v3))</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;            t2 = np.dot(np.cross(v1,v2),np.cross(v2,v3))</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;            phi = np.arctan2(t1,t2)</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;            phis.append(phi * 180 / np.pi)</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;            <span class="comment">#phimod = phi*180/pi % 360</span></div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;            <span class="comment">#phis.append(phimod)</span></div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;            <span class="comment">#print phimod</span></div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        <span class="keywordflow">return</span> phis</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#abb42e2d8a17fac1eb2a8912e1ea3a9a7">find_rings</a>(self, max_size=6):</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;<span class="stringliteral">        Return a list of rings in the molecule. Tested on a DNA base</span></div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;<span class="stringliteral">        pair and C60.  Warning: Using large max_size for rings</span></div><div class="line"><a name="l02529"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ac07431c9d938d6f0e24e71beef9119c5"> 2529</a></span>&#160;<span class="stringliteral">        (e.g. for finding the macrocycle in porphyrin) could lead to</span></div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;<span class="stringliteral">        some undefined behavior.</span></div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;<span class="stringliteral">        max_size : int</span></div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="stringliteral">            The maximum ring size.  If a large ring contains smaller</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;<span class="stringliteral">            sub-rings, they are all mapped into one.</span></div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;<span class="stringliteral">        Returns</span></div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;<span class="stringliteral">        -------</span></div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="stringliteral">        list</span></div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;<span class="stringliteral">            A list of rings sorted in ascending order of the smallest</span></div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;<span class="stringliteral">            atom number. The atoms in each ring are ordered starting</span></div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;<span class="stringliteral">            from the lowest number and going along the ring, with the</span></div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;<span class="stringliteral">            second atom being the lower of the two possible choices.</span></div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;        friends = []</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;            friends.append(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a>.neighbors(i))</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;        <span class="comment"># Determine if atom is in a ring</span></div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afae2c34b572e137801c8077f4267b247">build_topology</a>()</div><div class="line"><a name="l02551"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a2a818455c2439cd42f7489d3f811eb72"> 2551</a></span>&#160;        <span class="comment"># Get triplets of atoms that are in rings</span></div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;        triplets = []</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;            g = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a>)</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;            n = g.neighbors(i)</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;            g.remove_node(i)</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;            <span class="keywordflow">for</span> a, b <span class="keywordflow">in</span> itertools.combinations(n, 2):</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;                <span class="keywordflow">try</span>:</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;                    PathLength = nx.shortest_path_length(g, a, b)</div><div class="line"><a name="l02560"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ad9a055066973a760e4898581224736b0"> 2560</a></span>&#160;                <span class="keywordflow">except</span> nx.exception.NetworkXNoPath:</div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;                    PathLength = 0</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;                <span class="keywordflow">if</span> PathLength &gt; 0 <span class="keywordflow">and</span> PathLength &lt;= (max_size-2):</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;                    <span class="keywordflow">if</span> b &gt; a:</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;                        triplets.append((a, i, b))</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;                        triplets.append((b, i, a))</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;        <span class="comment"># Organize triplets into rings</span></div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;        rings = []</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;        <span class="comment"># Triplets are assigned to rings</span></div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;        assigned = {}</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;        <span class="comment"># For each triplet that isn&#39;t already counted, see if it belongs to a ring already</span></div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;        <span class="keywordflow">while</span> set(assigned.keys()) != set(triplets):</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;            <span class="keywordflow">for</span> t <span class="keywordflow">in</span> triplets:</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;                <span class="keywordflow">if</span> t <span class="keywordflow">not</span> <span class="keywordflow">in</span> assigned:</div><div class="line"><a name="l02575"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a4c1539dbe8854e261e7dbdb4a6fa0a98"> 2575</a></span>&#160;                    <span class="comment"># print t, &quot;has not been assigned yet&quot;</span></div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;                    <span class="comment"># Whether this triplet has been assigned to a ring</span></div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;                    has_been_assigned = <span class="keyword">False</span></div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;                    <span class="comment"># Create variable for new rings</span></div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;                    new_rings = copy.deepcopy(rings)</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;                    <span class="comment"># Assign triplet to a ring</span></div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;                    <span class="keywordflow">for</span> iring, ring <span class="keywordflow">in</span> enumerate(rings):</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;                        <span class="comment"># Loop over triplets in the ring</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;                        <span class="keywordflow">for</span> r <span class="keywordflow">in</span> ring:</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;                            <span class="comment"># Two triplets belong to the same ring if two of the atoms</span></div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;                            <span class="comment"># are the same AND there exists a path connecting them with the</span></div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;                            <span class="comment"># center atom deleted.  Check the forward and reverse orientations</span></div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;                            <span class="keywordflow">if</span> ((r[0] == t[1] <span class="keywordflow">and</span> r[1] == t[2]) <span class="keywordflow">or</span></div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;                                (r[::-1][0] == t[1] <span class="keywordflow">and</span> r[::-1][1] == t[2]) <span class="keywordflow">or</span></div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;                                (r[0] == t[::-1][1] <span class="keywordflow">and</span> r[1] == t[::-1][2]) <span class="keywordflow">or</span></div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;                                (r[::-1][0] == t[::-1][1] <span class="keywordflow">and</span> r[1] == t[::-1][2])):</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;                                ends = list(set(r).symmetric_difference(t))</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;                                mids = set(r).intersection(t)</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;                                g = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a>)</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;                                <span class="keywordflow">for</span> m <span class="keywordflow">in</span> mids: g.remove_node(m)</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;                                <span class="keywordflow">try</span>:</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;                                    PathLength = nx.shortest_path_length(g, ends[0], ends[1])</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;                                <span class="keywordflow">except</span> nx.exception.NetworkXNoPath:</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;                                    PathLength = 0</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;                                <span class="keywordflow">if</span> PathLength &lt;= 0 <span class="keywordflow">or</span> PathLength &gt; (max_size-2):</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;                                    <span class="comment"># print r, t, &quot;share two atoms but are on different rings&quot;</span></div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;                                    <span class="keywordflow">continue</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;                                <span class="keywordflow">if</span> has_been_assigned:</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;                                    <span class="comment"># This happens if two rings have separately been found but they&#39;re actually the same</span></div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;                                    <span class="comment"># print &quot;trying to assign t=&quot;, t, &quot;to r=&quot;, r, &quot;but it&#39;s already in&quot;, rings[assigned[t]]</span></div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;                                    <span class="comment"># print &quot;Merging&quot;, rings[iring], &quot;into&quot;, rings[assigned[t]]</span></div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;                                    <span class="keywordflow">for</span> r1 <span class="keywordflow">in</span> rings[iring]:</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;                                        new_rings[assigned[t]].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(r1)</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;                                    del new_rings[new_rings.index(rings[iring])]</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;                                    <span class="keywordflow">break</span></div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;                                new_rings[iring].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(t)</div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;                                assigned[t] = iring</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;                                has_been_assigned = <span class="keyword">True</span></div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;                                <span class="comment"># print t, &quot;assigned to ring&quot;, iring</span></div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;                                <span class="keywordflow">break</span></div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;                    <span class="comment"># If the triplet was not assigned to a ring,</span></div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;                    <span class="comment"># then create a new one</span></div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> has_been_assigned:</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;                        <span class="comment"># print t, &quot;creating new ring&quot;, len(new_rings)</span></div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;                        assigned[t] = len(new_rings)</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;                        new_rings.append([t])</div><div class="line"><a name="l02621"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#abb42e2d8a17fac1eb2a8912e1ea3a9a7"> 2621</a></span>&#160;                    <span class="comment"># Now the ring has a new triplet assigned to it</span></div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;                    rings = copy.deepcopy(new_rings)</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;        <span class="comment"># Keep the middle atom in each triplet</span></div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;        rings = [sorted(list(set([t[1] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> r]))) <span class="keywordflow">for</span> r <span class="keywordflow">in</span> rings]</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;        <span class="comment"># print rings</span></div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;        <span class="comment"># Sorted rings start from the lowest atom and go around the ring in ascending order</span></div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;        sorted_rings = []</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;        <span class="keywordflow">for</span> ring <span class="keywordflow">in</span> rings:</div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;            <span class="comment"># print &quot;Sorting Ring&quot;, ring</span></div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;            minr = min(ring)</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;            ring.remove(minr)</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;            sring = [minr]</div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;            <span class="keywordflow">while</span> len(ring) &gt; 0:</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;                <span class="keywordflow">for</span> r <span class="keywordflow">in</span> sorted(ring):</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;                    <span class="keywordflow">if</span> sring[-1] <span class="keywordflow">in</span> friends[r]:</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;                        ring.remove(r)</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;                        sring.append(r)</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;                        <span class="keywordflow">break</span></div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;            sorted_rings.append(sring[:])</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;        <span class="keywordflow">return</span> sorted(sorted_rings, key = <span class="keyword">lambda</span> val: val[0])</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5aac5225e3c6c540659410f7a783cd99">order_by_connectivity</a>(self, m, i, currList, max_min_path):</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;<span class="stringliteral">        Recursive function that orders atoms based on connectivity.</span></div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;<span class="stringliteral">        To call the function, pass in the topology object (e.g. M.molecules[0])</span></div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;<span class="stringliteral">        and the index of the atom assigned to be &quot;first&quot;.</span></div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;<span class="stringliteral">        The neighbors of &quot;i&quot; are placed in decreasing order of the</span></div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;<span class="stringliteral">        maximum length of the shortest path to all other atoms - i.e.</span></div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;<span class="stringliteral">        an atom closer to the &quot;edge&quot; of the molecule has a longer</span></div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;<span class="stringliteral">        shortest-path to atoms on the other &quot;edge&quot;, and they should</span></div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;<span class="stringliteral">        be added first.</span></div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;<span class="stringliteral">        Snippet:</span></div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;<span class="stringliteral">        from forcebalance.molecule import *</span></div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;<span class="stringliteral">        import numpy as np</span></div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;<span class="stringliteral">        M = Molecule(&#39;movProt.xyz&#39;, Fac=1.25)</span></div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;<span class="stringliteral">        # Arbitrarily select heaviest atom as the first atom in each molecule</span></div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;<span class="stringliteral">        firstAtom = [m.L()[np.argmax([PeriodicTable[M.elem[i]] for i in m.L()])] for m in M.molecules]</span></div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;<span class="stringliteral">        # Explicitly set the first atom in the first molecule</span></div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;<span class="stringliteral">        firstAtom[0] = 40</span></div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;<span class="stringliteral">        # Build a list of new atom orderings</span></div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;<span class="stringliteral">        newOrder = []</span></div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="stringliteral">        for i in range(len(M.molecules)):</span></div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;<span class="stringliteral">            newOrder += M.order_by_connectivity(M.molecules[i], firstAtom[i], [], None)</span></div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="stringliteral">        # Write the new Molecule object</span></div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;<span class="stringliteral">        newM = M.atom_select(newOrder)</span></div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;<span class="stringliteral">        newM.write(&#39;reordered1.xyz&#39;)</span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;<span class="stringliteral">        Parameters</span></div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;<span class="stringliteral">        ----------</span></div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;<span class="stringliteral">        m : topology object (contained in Molecule)</span></div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;<span class="stringliteral">        i : integer</span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;<span class="stringliteral">            Index of the atom to be added first (if called recursively,</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;<span class="stringliteral">            the index of subsequent atoms to be added)</span></div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="stringliteral">        currList : list</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="stringliteral">            Current list of new atom orderings</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="stringliteral">        max_min_path : dict</span></div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="stringliteral">            Dictionary mapping</span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;        <span class="keywordflow">if</span> m <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">molecules</a>:</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;topology is not part of Molecule object&quot;</span>)</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;        <span class="keywordflow">if</span> max_min_path <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;            spl = nx.shortest_path_length(m)</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;            <span class="comment"># Dictionary mapping atom index to</span></div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;            <span class="comment"># maximum length of shortest path to all other atoms</span></div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;            <span class="comment"># The larger this number, the closer to the &quot;edge&quot; of the molecule</span></div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;            max_min_path = dict([(k, max(spl[k].values())) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> m.L()])</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;        <span class="comment">#currList = currList[:]</span></div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;        <span class="comment">#print currList</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;        <span class="comment">#print max_min_path</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;        <span class="comment">#raw_input()</span></div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;        currList.append(i)</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;        matom = m.L()</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;        <span class="comment">#print spl.keys()</span></div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;        <span class="comment">#print matom</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;        <span class="comment">#raw_input()</span></div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;        <span class="keywordflow">if</span> i <span class="keywordflow">not</span> <span class="keywordflow">in</span> matom:</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;            <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;atom %i not in molecule&#39;</span> % i)</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;        jlist = np.array(m.neighbors(i))</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;        jmass = [PeriodicTable[self.elem[j]] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> jlist]</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;        jnghs = [len(m.neighbors(j)) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> jlist]</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;        jpath = [max_min_path[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> jlist]</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;        <span class="comment">#print &quot;i&quot;, i, M.elem[i], &quot;currList&quot;, currList, &quot;jpath&quot;, jpath</span></div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;        <span class="comment">#raw_input()</span></div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> jlist[np.argsort(jpath)[::-1]]:</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;            <span class="keywordflow">if</span> j <span class="keywordflow">in</span> currList: <span class="keywordflow">continue</span></div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;            <span class="comment">#print &quot;adding&quot;, j, &quot;to currList&quot;</span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;            <span class="comment">#print &quot;calling order_by_connectivity: j&quot;, j, &quot;currList&quot;, currList</span></div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5aac5225e3c6c540659410f7a783cd99">order_by_connectivity</a>(m, j, currList, max_min_path)</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;        <span class="keywordflow">return</span> currList</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab2a58903fe3c7522158165619b92fab2">aliphatic_hydrogens</a>(self):</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;        hyds = []</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;            <span class="keywordflow">if</span> self.elem[i] != <span class="stringliteral">&quot;H&quot;</span>: <span class="keywordflow">continue</span></div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;            <span class="keywordflow">if</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a>.neighbors(i)) != 1:</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;                <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;Hydrogen with not one bond?&quot;</span>)</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;            <span class="keywordflow">if</span> self.elem[self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">topology</a>.neighbors(i)[0]] <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">&quot;N&quot;</span>, <span class="stringliteral">&quot;O&quot;</span>, <span class="stringliteral">&quot;F&quot;</span>, <span class="stringliteral">&quot;P&quot;</span>, <span class="stringliteral">&quot;S&quot;</span>, <span class="stringliteral">&quot;Cl&quot;</span>]:</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;                hyds.append(i)</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;        <span class="keywordflow">return</span> hyds</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac2da956804fed7a98341c94582838f26">all_pairwise_rmsd</a>(self):</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Find pairwise RMSD (super slow, not like the one in MSMBuilder.) &quot;&quot;&quot;</span></div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;        N = len(self)</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;        Mat = np.zeros((N,N),dtype=float)</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(N):</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;            xyzi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i].copy()</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;            xyzi -= xyzi.mean(0)</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;            <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i):</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;                xyzj = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[j].copy()</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;                xyzj -= xyzj.mean(0)</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;                tr, rt = <a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(xyzj, xyzi)</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;                xyzj = np.dot(xyzj, rt) + tr</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;                rmsd = np.sqrt(3*np.mean((xyzj - xyzi) ** 2))</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;                Mat[i,j] = rmsd</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;                Mat[j,i] = rmsd</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;        <span class="keywordflow">return</span> Mat</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af1fbd83fc5bba35b5df496413410f84d">pathwise_rmsd</a>(self, align=True):</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Find RMSD between frames along path. &quot;&quot;&quot;</span></div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;        N = len(self)</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;        Vec = np.zeros(N-1, dtype=float)</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(N-1):</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;            xyzi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i].copy()</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;            j=i+1</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;            xyzj = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[j].copy()</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;            <span class="keywordflow">if</span> align:</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;                xyzi -= xyzi.mean(0)</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;                xyzj -= xyzj.mean(0)</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;                tr, rt = <a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(xyzj, xyzi)</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;                xyzj = np.dot(xyzj, rt) + tr</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;            rmsd = np.sqrt(3*np.mean((xyzj - xyzi) ** 2))</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;            Vec[i] = rmsd</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        <span class="keywordflow">return</span> Vec</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;</div><div class="line"><a name="l02758"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a5aac5225e3c6c540659410f7a783cd99"> 2758</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a029c994fba2c8388259bd062def28fde">ref_rmsd</a>(self, i, align=True):</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Find RMSD to a reference frame. &quot;&quot;&quot;</span></div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;        N = len(self)</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;        Vec = np.zeros(N)</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;        xyzi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[i].copy()</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;        <span class="keywordflow">if</span> align: xyzi -= xyzi.mean(0)</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(N):</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;            xyzj = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[j].copy()</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;            <span class="keywordflow">if</span> align:</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;                xyzj -= xyzj.mean(0)</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;                tr, rt = <a class="code" href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">get_rotate_translate</a>(xyzj, xyzi)</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;                xyzj = np.dot(xyzj, rt) + tr</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;            rmsd = np.sqrt(3*np.mean((xyzj - xyzi) ** 2))</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;            Vec[j] = rmsd</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;        <span class="keywordflow">return</span> Vec</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a42c302c3f922e6f89862f2e5d39514a6">align_center</a>(self):</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ad74d00f84b4b0b66b18de8a3f6b41c88">align</a>()</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a466ab9dea14be9117488c6198b0f77cd">openmm_positions</a>(self):</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Returns the Cartesian coordinates in the Molecule object in</span></div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;<span class="stringliteral">        a list of OpenMM-compatible positions, so it is possible to type</span></div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;<span class="stringliteral">        simulation.context.setPositions(Mol.openmm_positions()[0])</span></div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;<span class="stringliteral">        or something like that.</span></div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;        Positions = []</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;        <span class="keywordflow">for</span> xyz <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>:</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;            Pos = []</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;            <span class="keywordflow">for</span> xyzi <span class="keywordflow">in</span> xyz:</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;                Pos.append(Vec3(xyzi[0]/10,xyzi[1]/10,xyzi[2]/10))</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;            Positions.append(Pos*nanometer)</div><div class="line"><a name="l02791"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ab2a58903fe3c7522158165619b92fab2"> 2791</a></span>&#160;        <span class="keywordflow">return</span> Positions</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4afda180689c9bfde319a025f96d4c0b">openmm_boxes</a>(self):</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Returns the periodic box vectors in the Molecule object in</span></div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;<span class="stringliteral">        a list of OpenMM-compatible boxes, so it is possible to type</span></div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;<span class="stringliteral">        simulation.context.setPeriodicBoxVectors(Mol.openmm_boxes()[0])</span></div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;<span class="stringliteral">        or something like that.</span></div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;boxes&#39;</span>)</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;        <span class="keywordflow">return</span> [(Vec3(*box.A)/10.0, Vec3(*box.B)/10.0, Vec3(*box.C)/10.0) * nanometer <span class="keywordflow">for</span> box <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>]</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;</div><div class="line"><a name="l02803"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ac2da956804fed7a98341c94582838f26"> 2803</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a004a64d4b979002026c23d15a79e8dfc">split</a>(self, fnm=None, ftype=None, method=&quot;chunks&quot;, num=None):</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Split the molecule object into a number of separate files</span></div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;<span class="stringliteral">        (chunks), either by specifying the number of frames per chunk</span></div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;<span class="stringliteral">        or the number of chunks.  Only relevant for &quot;trajectories&quot;.</span></div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;<span class="stringliteral">        The type of file may be specified; if they aren&#39;t specified</span></div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;<span class="stringliteral">        then the original file type is used.</span></div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;<span class="stringliteral">        The output file names are [name].[numbers].[extension] where</span></div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;<span class="stringliteral">        [name] can be specified by passing &#39;fnm&#39; or taken from the</span></div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;<span class="stringliteral">        object&#39;s &#39;fnm&#39; attribute by default.  [numbers] are integers</span></div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;<span class="stringliteral">        ranging from the lowest to the highest chunk number, prepended</span></div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="stringliteral">        by zeros.</span></div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="stringliteral">        If the number of chunks / frames is not specified, then one file</span></div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="stringliteral">        is written for each frame.</span></div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;<span class="stringliteral">        @return fnms A list of the file names that were written.</span></div><div class="line"><a name="l02821"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af1fbd83fc5bba35b5df496413410f84d"> 2821</a></span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;        logger.error(<span class="stringliteral">&#39;Apparently this function has not been implemented!!&#39;</span>)</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;        <span class="keywordflow">raise</span> NotImplementedError</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aeab236a12cffd66ce282c1a7d03af7f9">without</a>(self, *args):</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;<span class="stringliteral">        Return a copy of the Molecule object but with certain fields</span></div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;<span class="stringliteral">        deleted if they exist.  This is useful for when we&#39;d like to</span></div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;<span class="stringliteral">        add Molecule objects that don&#39;t share some fields that we know</span></div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;<span class="stringliteral">        about.</span></div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;        <span class="comment"># Create the sum of the two classes by copying the first class.</span></div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;        New = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>()</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;        <span class="keywordflow">for</span> key <span class="keywordflow">in</span> AllVariableNames:</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;            <span class="keywordflow">if</span> key <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> key <span class="keywordflow">not</span> <span class="keywordflow">in</span> args:</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;                New.Data[key] = copy.deepcopy(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[key])</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;        <span class="keywordflow">return</span> New</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;</div><div class="line"><a name="l02839"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a029c994fba2c8388259bd062def28fde"> 2839</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7aeff86c1d2b8f73bea9191b33f665c3">read_comm_charge_mult</a>(self, verbose=False):</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Set charge and multiplicity from reading the comment line, formatted in a specific way. &quot;&quot;&quot;</span></div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;        q, sz = <a class="code" href="namespacesrc_1_1molecule.html#a76b7defcd5b5e5db182fdf2f9f82f4ce">extract_pop</a>(self, verbose=verbose)</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a146f60bbab00e12c5754fd666233e86f">charge</a> = q</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa6fbbf278cf844c7bbdac896c71f5c64">mult</a> = abs(sz) + 1</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;    <span class="comment">#|         Reading functions         |#</span></div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1b0681641dfbba1c2d182151b5e60f5d">read_qcschema</a>(self, schema, **kwargs):</div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;        <span class="comment"># Already read in</span></div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;        <span class="keywordflow">if</span> isinstance(schema, dict):</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;            <span class="keywordflow">pass</span></div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;</div><div class="line"><a name="l02854"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a42c302c3f922e6f89862f2e5d39514a6"> 2854</a></span>&#160;        <span class="comment"># Try to read file</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;        <span class="keywordflow">elif</span> isinstance(schema, str):</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;            with open(schema, <span class="stringliteral">&quot;r&quot;) as handle:</span></div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;<span class="stringliteral">                schema = json.loads(handle)</span></div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;<span class="stringliteral">        </span><span class="keywordflow">else</span>:</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;            <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&quot;Schema type not understood &#39;{}&#39;&quot;</span>.format(type(schema)))</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;        ret = {<span class="stringliteral">&quot;elem&quot;</span>: schema[<span class="stringliteral">&quot;symbols&quot;</span>],</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;               <span class="stringliteral">&quot;xyzs&quot;</span>: [np.array(schema[<span class="stringliteral">&quot;geometry&quot;</span>])],</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;               <span class="stringliteral">&quot;comments&quot;</span>: []}</div><div class="line"><a name="l02863"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a466ab9dea14be9117488c6198b0f77cd"> 2863</a></span>&#160;        <span class="keywordflow">return</span> ret</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36a4504f013d86188435e01231235386">read_xyz</a>(self, fnm, **kwargs):</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; .xyz files can be TINKER formatted which is why we have the try/except here. &quot;&quot;&quot;</span></div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;            <span class="keywordflow">return</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4b84ec657b8c89c34674bb205f7eb1b2">read_xyz0</a>(fnm, **kwargs)</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;        <span class="keywordflow">except</span> ActuallyArcError:</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;            <span class="keywordflow">return</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7e4057a5d9f4bb4a62cef21680f91327">read_arc</a>(fnm, **kwargs)</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4b84ec657b8c89c34674bb205f7eb1b2">read_xyz0</a>(self, fnm, **kwargs):</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Parse a .xyz file which contains several xyz coordinates, and return their elements.</span></div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;<span class="stringliteral">        @param[in] fnm The input file name</span></div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;<span class="stringliteral">        @return elem  A list of chemical elements in the XYZ file</span></div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;<span class="stringliteral">        @return comms A list of comments.</span></div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;<span class="stringliteral">        @return xyzs  A list of XYZ coordinates (number of snapshots times number of atoms)</span></div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02880"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a4afda180689c9bfde319a025f96d4c0b"> 2880</a></span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;        xyz   = []</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;        xyzs  = []</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;        comms = []</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;        elem  = []</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;        an    = 0</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        na    = 0</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        ln    = 0</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;        absln = 0</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;            <span class="keywordflow">if</span> ln == 0:</div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;                <span class="comment"># Skip blank lines.</span></div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;                <span class="keywordflow">if</span> len(line.strip()) &gt; 0:</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;                    <span class="keywordflow">try</span>:</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;                        na = int(line.strip())</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;                    <span class="keywordflow">except</span>:</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;                        <span class="comment"># If the first line contains a comment, it&#39;s a TINKER .arc file</span></div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;                        logger.warning(<span class="stringliteral">&quot;Non-integer detected in first line; will parse as TINKER .arc file.&quot;</span>)</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;                        <span class="keywordflow">raise</span> ActuallyArcError</div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;            <span class="keywordflow">elif</span> ln == 1:</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;                sline = line.split()</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;                <span class="keywordflow">if</span> len(sline) == 6 <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(word) <span class="keywordflow">for</span> word <span class="keywordflow">in</span> sline]):</div><div class="line"><a name="l02903"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a004a64d4b979002026c23d15a79e8dfc"> 2903</a></span>&#160;                    <span class="comment"># If the second line contains box data, it&#39;s a TINKER .arc file</span></div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;                    logger.warning(<span class="stringliteral">&quot;Tinker box data detected in second line; will parse as TINKER .arc file.&quot;</span>)</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;                    <span class="keywordflow">raise</span> ActuallyArcError</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;                <span class="keywordflow">elif</span> len(sline) &gt;= 5 <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[0]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[2]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[3]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[4]):</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;                    <span class="comment"># If the second line contains coordinate data, it&#39;s a TINKER .arc file</span></div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;                    logger.warning(<span class="stringliteral">&quot;Tinker coordinate data detected in second line; will parse as TINKER .arc file.&quot;</span>)</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;                    <span class="keywordflow">raise</span> ActuallyArcError</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;                comms.append(line.strip())</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;                line = re.sub(<span class="stringliteral">r&quot;([0-9])(-[0-9])&quot;</span>, <span class="stringliteral">r&quot;\1 \2&quot;</span>, line)</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;                <span class="comment"># Error checking. Slows performance by ~20% when tested on a 200 MB .xyz file</span></div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;                <span class="keywordflow">if</span> <span class="keywordflow">not</span> re.match(<span class="stringliteral">r&quot;[A-Z][A-Za-z]?( +[-+]?([0-9]*\.)?[0-9]+){3}$&quot;</span>, line):</div><div class="line"><a name="l02915"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aeab236a12cffd66ce282c1a7d03af7f9"> 2915</a></span>&#160;                    <span class="keywordflow">raise</span> IOError(<span class="stringliteral">&quot;Expected coordinates at line %i but got this instead:\n%s&quot;</span> % (absln, line))</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;                sline = line.split()</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;                xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:]])</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;                <span class="keywordflow">if</span> len(elem) &lt; na:</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;                    elem.append(sline[0])</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;                an += 1</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;                <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;                    xyzs.append(np.array(xyz))</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;                    xyz = []</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;                    an  = 0</div><div class="line"><a name="l02925"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a7aeff86c1d2b8f73bea9191b33f665c3"> 2925</a></span>&#160;            <span class="keywordflow">if</span> ln == na+1:</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;                <span class="comment"># Reset the line number counter when we hit the last line in a block.</span></div><div class="line"><a name="l02927"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a146f60bbab00e12c5754fd666233e86f"> 2927</a></span>&#160;                ln = -1</div><div class="line"><a name="l02928"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aa6fbbf278cf844c7bbdac896c71f5c64"> 2928</a></span>&#160;            ln += 1</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;            absln += 1</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;        Answer = {<span class="stringliteral">&#39;elem&#39;</span> : elem,</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;                  <span class="stringliteral">&#39;xyzs&#39;</span> : xyzs,</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;                  <span class="stringliteral">&#39;comms&#39;</span>: comms}</div><div class="line"><a name="l02933"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a1b0681641dfbba1c2d182151b5e60f5d"> 2933</a></span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa7a40df32ff22ef52b902ac6a24dcb50">read_mdcrd</a>(self, fnm, **kwargs):</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Parse an AMBER .mdcrd file.  This requires at least the number of atoms.</span></div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;<span class="stringliteral">        This will FAIL for monatomic trajectories (but who the heck makes those?)</span></div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;<span class="stringliteral">        @param[in] fnm The input file name</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;<span class="stringliteral">        @return xyzs  A list of XYZ coordinates (number of snapshots times number of atoms)</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;<span class="stringliteral">        @return boxes Boxes (if present.)</span></div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;na&#39;</span>)</div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;        xyz    = []</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;        xyzs   = []</div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;        boxes  = []</div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;        ln     = 0</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;            sline = line.split()</div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;            <span class="keywordflow">if</span> ln == 0:</div><div class="line"><a name="l02952"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a36a4504f013d86188435e01231235386"> 2952</a></span>&#160;                <span class="keywordflow">pass</span></div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;                <span class="keywordflow">if</span> xyz == [] <span class="keywordflow">and</span> len(sline) == 3:</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;                    a, b, c = (float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split())</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;                    boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, 90.0, 90.0, 90.0))</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;                    xyz += [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()]</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;                    <span class="keywordflow">if</span> len(xyz) == self.na * 3:</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;                        xyzs.append(np.array(xyz).reshape(-1,3))</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;                        xyz = []</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;            ln += 1</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : xyzs}</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;        <span class="keywordflow">if</span> len(boxes) &gt; 0:</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;            Answer[<span class="stringliteral">&#39;boxes&#39;</span>] = boxes</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l02967"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a4b84ec657b8c89c34674bb205f7eb1b2"> 2967</a></span>&#160;</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a25e54248bd35147e2c2aa210d06a58a5">read_inpcrd</a>(self, fnm, **kwargs):</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Parse an AMBER .inpcrd or .rst file.</span></div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;<span class="stringliteral">        @param[in] fnm The input file name</span></div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;<span class="stringliteral">        @return xyzs  A list of XYZ coordinates (number of snapshots times number of atoms)</span></div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;<span class="stringliteral">        @return boxes Boxes (if present.)</span></div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;        xyz    = []</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;        xyzs   = []</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;        <span class="comment"># We read in velocities but never use them.</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;        vel    = []</div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;        vels   = []</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;        boxes  = []</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;        ln     = 0</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;        an     = 0</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;        mode   = <span class="stringliteral">&#39;x&#39;</span></div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;            line = line.replace(<span class="stringliteral">&#39;\n&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;            <span class="keywordflow">if</span> ln == 0:</div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;                comms = [line]</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;            <span class="keywordflow">elif</span> ln == 1:</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;                <span class="comment"># Although is isn&#39;t exactly up to spec, </span></div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;                <span class="comment"># it seems that some .rst7 files have spaces that precede the &quot;integer&quot;</span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;                <span class="comment"># and others have &gt;99999 atoms</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;                <span class="comment"># na = int(line[:5])</span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;                na = int(line.split()[0])</div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;            <span class="keywordflow">elif</span> mode == <span class="stringliteral">&#39;x&#39;</span>:</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;                xyz.append([float(line[:12]), float(line[12:24]), float(line[24:36])])</div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;                an += 1</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;                <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;                    xyzs.append(np.array(xyz))</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;                    mode = <span class="stringliteral">&#39;v&#39;</span></div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;                    an = 0</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;                <span class="keywordflow">if</span> len(line) &gt; 36:</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;                    xyz.append([float(line[36:48]), float(line[48:60]), float(line[60:72])])</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;                    an += 1</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;                    <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;                        xyzs.append(np.array(xyz))</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;                        mode = <span class="stringliteral">&#39;v&#39;</span></div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;                        an = 0</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;            <span class="keywordflow">elif</span> mode == <span class="stringliteral">&#39;v&#39;</span>:</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;                vel.append([float(line[:12]), float(line[12:24]), float(line[24:36])])</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;                an += 1</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;                <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;                    vels.append(np.array(vel))</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;                    mode = <span class="stringliteral">&#39;b&#39;</span></div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;                    an = 0</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;                <span class="keywordflow">if</span> len(line) &gt; 36:</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;                    vel.append([float(line[36:48]), float(line[48:60]), float(line[60:72])])</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;                    an += 1</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;                    <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;                        vels.append(np.array(vel))</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;                        mode = <span class="stringliteral">&#39;b&#39;</span></div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;                        an = 0</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;            <span class="keywordflow">elif</span> mode == <span class="stringliteral">&#39;b&#39;</span>:</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;                a, b, c = (float(line[:12]), float(line[12:24]), float(line[24:36]))</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;                boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, 90.0, 90.0, 90.0))</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;            ln += 1</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;        <span class="comment"># If there is only one velocity, then it should actually be a periodic box.</span></div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;        <span class="keywordflow">if</span> len(vel) == 1:</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;            a, b, c = vel[0]</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;            boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, 90.0, 90.0, 90.0))</div><div class="line"><a name="l03031"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aa7a40df32ff22ef52b902ac6a24dcb50"> 3031</a></span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : xyzs, <span class="stringliteral">&#39;comms&#39;</span> : comms}</div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;        <span class="keywordflow">if</span> len(boxes) &gt; 0:</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;            Answer[<span class="stringliteral">&#39;boxes&#39;</span>] = boxes</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a6c78338a640dbf1fd95c38f980203643">read_qdata</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;        xyzs     = []</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;        energies = []</div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;        grads   = []</div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;        espxyzs  = []</div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;        espvals  = []</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;        interaction = []</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;COORDS&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;                xyzs.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;FORCES&#39;</span> <span class="keywordflow">in</span> line <span class="keywordflow">or</span> <span class="stringliteral">&#39;GRADIENT&#39;</span> <span class="keywordflow">in</span> line: <span class="comment"># &#39;FORCES&#39; is from an earlier version and a misnomer</span></div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;                grads.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ESPXYZ&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;                espxyzs.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ESPVAL&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;                espvals.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]))</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ENERGY&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;                energies.append(float(line.split()[1]))</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;            <span class="keywordflow">elif</span> <span class="stringliteral">&#39;INTERACTION&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;                interaction.append(float(line.split()[1]))</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;        Answer = {}</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;        <span class="keywordflow">if</span> len(xyzs) &gt; 0:</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;            Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = xyzs</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;        <span class="keywordflow">if</span> len(energies) &gt; 0:</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;            Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = energies</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;        <span class="keywordflow">if</span> len(interaction) &gt; 0:</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;            Answer[<span class="stringliteral">&#39;qm_interaction&#39;</span>] = interaction</div><div class="line"><a name="l03064"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a25e54248bd35147e2c2aa210d06a58a5"> 3064</a></span>&#160;        <span class="keywordflow">if</span> len(grads) &gt; 0:</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = grads</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        <span class="keywordflow">if</span> len(espxyzs) &gt; 0:</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;            Answer[<span class="stringliteral">&#39;qm_espxyzs&#39;</span>] = espxyzs</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;        <span class="keywordflow">if</span> len(espvals) &gt; 0:</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;            Answer[<span class="stringliteral">&#39;qm_espvals&#39;</span>] = espvals</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1d771e111c1cc4c8a0783b58081e282d">read_mol2</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;        xyz      = []</div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;        charge   = []</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        atomname = []</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;        atomtype = []</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;        elem     = []</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;        resname  = []</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;        resid    = []</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;        data = <a class="code" href="classsrc_1_1Mol2_1_1mol2__set.html">Mol2.mol2_set</a>(fnm)</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        <span class="keywordflow">if</span> len(data.compounds) &gt; 1:</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;Not sure what to do if the MOL2 file contains multiple compounds\n&quot;</span>)</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;        <span class="keywordflow">for</span> i, atom <span class="keywordflow">in</span> enumerate(list(data.compounds.items())[0][1].atoms):</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;            xyz.append([atom.x, atom.y, atom.z])</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;            charge.append(atom.charge)</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;            atomname.append(atom.atom_name)</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;            atomtype.append(atom.atom_type)</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;            resname.append(atom.subst_name)</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;            resid.append(atom.subst_id)</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;            thiselem = atom.atom_name</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;            <span class="keywordflow">if</span> len(thiselem) &gt; 1:</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;                thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])</div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;            elem.append(thiselem)</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;</div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;        <span class="comment"># resname = [list(data.compounds.items())[0][0] for i in range(len(elem))]</span></div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;        <span class="comment"># resid = [1 for i in range(len(elem))]</span></div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;</div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;        <span class="comment"># Deprecated &#39;abonds&#39; format.</span></div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;        <span class="comment"># bonds    = [[] for i in range(len(elem))]</span></div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;        <span class="comment"># for bond in data.compounds.items()[0][1].bonds:</span></div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;        <span class="comment">#     a1 = bond.origin_atom_id - 1</span></div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;        <span class="comment">#     a2 = bond.target_atom_id - 1</span></div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;        <span class="comment">#     aL, aH = (a1, a2) if a1 &lt; a2 else (a2, a1)</span></div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;        <span class="comment">#     bonds[aL].append(aH)</span></div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;</div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;        bonds = []</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;        <span class="keywordflow">for</span> bond <span class="keywordflow">in</span> list(data.compounds.items())[0][1].bonds:</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;            a1 = bond.origin_atom_id - 1</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;            a2 = bond.target_atom_id - 1</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;            aL, aH = (a1, a2) <span class="keywordflow">if</span> a1 &lt; a2 <span class="keywordflow">else</span> (a2, a1)</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;            bonds.append((aL,aH))</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&quot;read_bonds&quot;</span>] = <span class="keyword">True</span></div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : [np.array(xyz)],</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;                  <span class="stringliteral">&#39;partial_charge&#39;</span> : charge,</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;                  <span class="stringliteral">&#39;atomname&#39;</span> : atomname,</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;                  <span class="stringliteral">&#39;atomtype&#39;</span> : atomtype,</div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;                  <span class="stringliteral">&#39;elem&#39;</span>     : elem,</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;                  <span class="stringliteral">&#39;resname&#39;</span>  : resname,</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;                  <span class="stringliteral">&#39;resid&#39;</span>    : resid,</div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;                  <span class="stringliteral">&#39;bonds&#39;</span>    : bonds</div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;                  }</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03125"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a6c78338a640dbf1fd95c38f980203643"> 3125</a></span>&#160;</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a258bc7b495910f9ff3bb552413207ecd">read_dcd</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;        xyzs = []</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;        boxes = []</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;        <span class="keywordflow">if</span> _dcdlib.vmdplugin_init() != 0:</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;            logger.error(<span class="stringliteral">&quot;Unable to init DCD plugin\n&quot;</span>)</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;            <span class="keywordflow">raise</span> IOError</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;        natoms = c_int(-1)</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;        frame  = 0</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;        dcd       = _dcdlib.open_dcd_read(fnm, <span class="stringliteral">&quot;dcd&quot;</span>, byref(natoms))</div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;        ts        = <a class="code" href="classsrc_1_1molecule_1_1MolfileTimestep.html">MolfileTimestep</a>()</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;        _xyz      = c_float * (natoms.value * 3)</div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;        xyzvec    = _xyz()</div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;        ts.coords = xyzvec</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;        <span class="keywordflow">while</span> <span class="keyword">True</span>:</div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;            result = _dcdlib.read_next_timestep(dcd, natoms, byref(ts))</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;            <span class="keywordflow">if</span> result == 0:</div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;                frame += 1</div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;            <span class="keywordflow">elif</span> result == -1:</div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;                <span class="keywordflow">break</span></div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;            <span class="comment">#npa    = np.array(xyzvec)</span></div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;            xyz    = np.asfarray(xyzvec)</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;            xyzs.append(xyz.reshape(-1, 3))</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;            boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(ts.A, ts.B, ts.C, 90.0, 90.0, 90.0))</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;        _dcdlib.close_file_read(dcd)</div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;        dcd = <span class="keywordtype">None</span></div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : xyzs,</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;                  <span class="stringliteral">&#39;boxes&#39;</span> : boxes}</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a742c96f62c86d00ac97bb5004f8ebd92">read_com</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Parse a Gaussian .com file and return a SINGLE-ELEMENT list of xyz coordinates (no multiple file support)</span></div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;<span class="stringliteral">        @param[in] fnm The input file name</span></div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;<span class="stringliteral">        @return elem   A list of chemical elements in the XYZ file</span></div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;<span class="stringliteral">        @return comms  A single-element list for the comment.</span></div><div class="line"><a name="l03161"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a1d771e111c1cc4c8a0783b58081e282d"> 3161</a></span>&#160;<span class="stringliteral">        @return xyzs   A single-element list for the  XYZ coordinates.</span></div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;<span class="stringliteral">        @return charge The total charge of the system.</span></div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;<span class="stringliteral">        @return mult   The spin multiplicity of the system.</span></div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;        elem    = []</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;        xyz     = []</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;        ln      = 0</div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;        absln   = 0</div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;        comfile = open(fnm).readlines()</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;        inxyz = 0</div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> comfile:</div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;            <span class="comment"># Everything after exclamation point is a comment</span></div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;            sline = line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a004a64d4b979002026c23d15a79e8dfc">split</a>()</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;            <span class="keywordflow">if</span> len(sline) == 2:</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;                <span class="keywordflow">if</span> <a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[0]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[1]):</div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;                    charge = int(sline[0])</div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;                    mult = int(sline[1])</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;                    title_ln = ln - 2</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;            <span class="keywordflow">elif</span> len(sline) == 4:</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;                inxyz = 1</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;                <span class="keywordflow">if</span> sline[0].capitalize() <span class="keywordflow">in</span> PeriodicTable <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[1]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[2]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[3]):</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;                    elem.append(sline[0])</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;                    xyz.append(np.array([float(sline[1]),float(sline[2]),float(sline[3])]))</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;            <span class="keywordflow">elif</span> inxyz:</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;                <span class="keywordflow">break</span></div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;            ln += 1</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;            absln += 1</div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;</div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>   : [np.array(xyz)],</div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;                  <span class="stringliteral">&#39;elem&#39;</span>   : elem,</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;                  <span class="stringliteral">&#39;comms&#39;</span>  : [comfile[title_ln].strip()],</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;                  <span class="stringliteral">&#39;charge&#39;</span> : charge,</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;                  <span class="stringliteral">&#39;mult&#39;</span>   : mult}</div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;</div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7e4057a5d9f4bb4a62cef21680f91327">read_arc</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Read a TINKER .arc file.</span></div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;<span class="stringliteral">        @param[in] fnm  The input file name</span></div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;<span class="stringliteral">        @return xyzs    A list for the  XYZ coordinates.</span></div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;<span class="stringliteral">        @return boxes   A list of periodic boxes (newer .arc files have these)</span></div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;<span class="stringliteral">        @return resid   The residue ID numbers.  These are not easy to get!</span></div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;<span class="stringliteral">        @return elem    A list of chemical elements in the XYZ file</span></div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;<span class="stringliteral">        @return comms   A single-element list for the comment.</span></div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;<span class="stringliteral">        @return tinkersuf  The suffix that comes after lines in the XYZ coordinates; this is usually topology info</span></div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;        tinkersuf   = []</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;        boxes = []</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;        xyzs  = []</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;        xyz   = []</div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;        resid = []</div><div class="line"><a name="l03215"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a258bc7b495910f9ff3bb552413207ecd"> 3215</a></span>&#160;        elem  = []</div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;        comms = []</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;        thisres = set([])</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;        forwardres = set([])</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;        title = <span class="keyword">True</span></div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;        nframes = 0</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;        thisresid   = 1</div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;        ln = 0</div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;        thisatom = 0</div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;            sline = line.split()</div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;            <span class="keywordflow">if</span> len(sline) == 0: <span class="keywordflow">continue</span></div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;            <span class="comment"># The first line always contains the number of atoms</span></div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;            <span class="comment"># The words after the first line are comments</span></div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;            <span class="keywordflow">if</span> title:</div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;                na = int(sline[0])</div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;                comms.append(<span class="stringliteral">&#39; &#39;</span>.join(sline[1:]))</div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;                title = <span class="keyword">False</span></div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;            <span class="keywordflow">elif</span> len(sline) &gt;= 5:</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;                <span class="keywordflow">if</span> len(sline) == 6 <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[1]) <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]): <span class="comment"># Newer .arc files have a .box line.</span></div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;                    a, b, c, alpha, beta, gamma = (float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[:6])</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;                    boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma))</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;                <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">isint</a>(sline[0]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[2]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[3]) <span class="keywordflow">and</span> <a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[4]): <span class="comment"># A line of data better look like this</span></div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;                    <span class="keywordflow">if</span> nframes == 0:</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;                        elem.append(<a class="code" href="namespacesrc_1_1molecule.html#a4638e3bec89d2fa20ba340988456a1ac">elem_from_atomname</a>(sline[1]))</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;                        resid.append(thisresid)</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;                        whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;                        <span class="keywordflow">if</span> len(sline) &gt; 5:</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;                            s = sline[5:]</div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;                            <span class="keywordflow">if</span> len(s) &gt; 1:</div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;                                sn = [int(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> s[1:]]</div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;                                s = [s[0]] + list(np.array(s[1:])[np.argsort(sn)])</div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;                            tinkersuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+s[j-5] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(5,len(sline))]))</div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;                        <span class="keywordflow">else</span>:</div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;                            tinkersuf.append(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;                    <span class="comment"># LPW Make sure ..</span></div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;                    thisatom += 1</div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;                    <span class="comment">#thisatom = int(sline[0])</span></div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;                    thisres.add(thisatom)</div><div class="line"><a name="l03255"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a742c96f62c86d00ac97bb5004f8ebd92"> 3255</a></span>&#160;                    forwardres.add(thisatom)</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;                    <span class="keywordflow">if</span> len(sline) &gt;= 6:</div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;                        forwardres.update([int(j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> sline[6:]])</div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;                    <span class="keywordflow">if</span> thisres == forwardres:</div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;                        thisres = set([])</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;                        forwardres = set([])</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;                        thisresid += 1</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;                    xyz.append([float(sline[2]),float(sline[3]),float(sline[4])])</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;                    <span class="keywordflow">if</span> thisatom == na:</div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;                        thisatom = 0</div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;                        nframes += 1</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                        title = <span class="keyword">True</span></div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;                        xyzs.append(np.array(xyz))</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;                        xyz = []</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;            ln += 1</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>   : xyzs,</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;                  <span class="stringliteral">&#39;resid&#39;</span>  : resid,</div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;                  <span class="stringliteral">&#39;elem&#39;</span>   : elem,</div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;                  <span class="stringliteral">&#39;comms&#39;</span>  : comms,</div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;                  <span class="stringliteral">&#39;tinkersuf&#39;</span> : tinkersuf}</div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;        <span class="keywordflow">if</span> len(boxes) &gt; 0: Answer[<span class="stringliteral">&#39;boxes&#39;</span>] = boxes</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a4ce0cfbb42e84ec2fe5d8097d0ff5fda">read_gro</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Read a GROMACS .gro file.</span></div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;        xyzs     = []</div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;        elem     = [] <span class="comment"># The element, most useful for quantum chemistry calculations</span></div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;        atomname = [] <span class="comment"># The atom name, for instance &#39;HW1&#39;</span></div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;        comms    = []</div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;        resid    = []</div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;        resname  = []</div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;        boxes    = []</div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;        xyz      = []</div><div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;        ln       = 0</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;        frame    = 0</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;        absln    = 0</div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;        na       = -10</div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;            sline = line.split()</div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;            <span class="keywordflow">if</span> ln == 0:</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;                comms.append(line.strip())</div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;            <span class="keywordflow">elif</span> ln == 1:</div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;                na = int(line.strip())</div><div class="line"><a name="l03300"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a7e4057a5d9f4bb4a62cef21680f91327"> 3300</a></span>&#160;            <span class="keywordflow">elif</span> ln == na + 2:</div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;                box = [float(i)*10 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]</div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;                <span class="keywordflow">if</span> len(box) == 3:</div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;                    a = box[0]</div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;                    b = box[1]</div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;                    c = box[2]</div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;                    alpha = 90.0</div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;                    beta = 90.0</div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;                    gamma = 90.0</div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;                    boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma))</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;                <span class="keywordflow">elif</span> len(box) == 9:</div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;                    v1 = np.array([box[0], box[3], box[4]])</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;                    v2 = np.array([box[5], box[1], box[6]])</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;                    v3 = np.array([box[7], box[8], box[2]])</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;                    boxes.append(<a class="code" href="namespacesrc_1_1molecule.html#a49fbd57aae59219cb5fb85c22362b1f3">BuildLatticeFromVectors</a>(v1, v2, v3))</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;                xyzs.append(np.array(xyz)*10)</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;                xyz = []</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;                ln = -1</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;                frame += 1</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;                coord = []</div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;                <span class="keywordflow">if</span> frame == 0: <span class="comment"># Create the list of residues, atom names etc. only if it&#39;s the first frame.</span></div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;                    <span class="comment"># Name of the residue, for instance &#39;153SOL1 -&gt; SOL1&#39; ; strips leading numbers</span></div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;                    thisresid = int(line[0:5].strip())</div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;                    resid.append(thisresid)</div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;                    thisresname = line[5:10].strip()</div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;                    resname.append(thisresname)</div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;                    thisatomname = line[10:15].strip()</div><div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;                    atomname.append(thisatomname)</div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;</div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;                    thiselem = sline[1]</div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;                    <span class="keywordflow">if</span> len(thiselem) &gt; 1:</div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;                        thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])</div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;                    elem.append(thiselem)</div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;</div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;                <span class="comment"># Different frames may have different decimal precision</span></div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;                <span class="keywordflow">if</span> ln == 2:</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;                    pdeci = [i <span class="keywordflow">for</span> i, x <span class="keywordflow">in</span> enumerate(line) <span class="keywordflow">if</span> x == <span class="stringliteral">&#39;.&#39;</span>]</div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;                    ndeci = pdeci[1] - pdeci[0] - 5</div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;</div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,4):</div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;                    <span class="keywordflow">try</span>:</div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;                        thiscoord = float(line[(pdeci[0]-4)+(5+ndeci)*(i-1):(pdeci[0]-4)+(5+ndeci)*i].strip())</div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;                    <span class="keywordflow">except</span>: <span class="comment"># Attempt to read incorrectly formatted GRO files.</span></div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;                        thiscoord = float(line.split()[i+2])</div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;                    coord.append(thiscoord)</div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;                xyz.append(coord)</div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;            ln += 1</div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;            absln += 1</div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>     : xyzs,</div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;                  <span class="stringliteral">&#39;elem&#39;</span>     : elem,</div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;                  <span class="stringliteral">&#39;atomname&#39;</span> : atomname,</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;                  <span class="stringliteral">&#39;resid&#39;</span>    : resid,</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;                  <span class="stringliteral">&#39;resname&#39;</span>  : resname,</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;                  <span class="stringliteral">&#39;boxes&#39;</span>    : boxes,</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;                  <span class="stringliteral">&#39;comms&#39;</span>    : comms}</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a3710f2055a57158a9b5fbab2c5943683">read_charmm</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Read a CHARMM .cor (or .crd) file.</span></div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;        xyzs     = []</div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;        elem     = [] <span class="comment"># The element, most useful for quantum chemistry calculations</span></div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;        atomname = [] <span class="comment"># The atom name, for instance &#39;HW1&#39;</span></div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;        comms    = []</div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;        resid    = []</div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;        resname  = []</div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;        xyz      = []</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;        thiscomm = []</div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;        ln       = 0</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;        frame    = 0</div><div class="line"><a name="l03373"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a4ce0cfbb42e84ec2fe5d8097d0ff5fda"> 3373</a></span>&#160;        an       = 0</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;            sline = line.split()</div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;            <span class="keywordflow">if</span> re.match(<span class="stringliteral">r&#39;^\*&#39;</span>,line):</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;                <span class="keywordflow">if</span> len(sline) == 1:</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;                    comms.append(<span class="stringliteral">&#39;;&#39;</span>.join(list(thiscomm)))</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;                    thiscomm = []</div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;                    thiscomm.append(<span class="stringliteral">&#39; &#39;</span>.join(sline[1:]))</div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;^ *[0-9]+ +(EXT)?$&#39;</span>,line):</div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;                na = int(sline[0])</div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;            <span class="keywordflow">elif</span> <a class="code" href="namespacesrc_1_1molecule.html#a17d81a43f4f28d4db24d6548dc7018dd">is_charmm_coord</a>(line):</div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;                <span class="keywordflow">if</span> frame == 0: <span class="comment"># Create the list of residues, atom names etc. only if it&#39;s the first frame.</span></div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;                    resid.append(sline[1])</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;                    resname.append(sline[2])</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;                    atomname.append(sline[3])</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;                    thiselem = sline[3]</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;                    <span class="keywordflow">if</span> len(thiselem) &gt; 1:</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;                        thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;                    elem.append(thiselem)</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;                xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[4:7]])</div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;                an += 1</div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;                <span class="keywordflow">if</span> an == na:</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;                    xyzs.append(np.array(xyz))</div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;                    xyz = []</div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;                    an = 0</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;                    frame += 1</div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;            ln += 1</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;        Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>     : xyzs,</div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;                  <span class="stringliteral">&#39;elem&#39;</span>     : elem,</div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;                  <span class="stringliteral">&#39;atomname&#39;</span> : atomname,</div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;                  <span class="stringliteral">&#39;resid&#39;</span>    : resid,</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;                  <span class="stringliteral">&#39;resname&#39;</span>  : resname,</div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;                  <span class="stringliteral">&#39;comms&#39;</span>    : comms}</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;</div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa9caaf6d7ccff3a9077da98b4c8096a9">read_qcin</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Read a Q-Chem input file.</span></div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;<span class="stringliteral">        These files can be very complicated, and I can&#39;t write a completely</span></div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;<span class="stringliteral">        general parser for them.  It is important to keep our goal in</span></div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;<span class="stringliteral">        mind:</span></div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;<span class="stringliteral">        1) The main goal is to convert a trajectory to Q-Chem input</span></div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;<span class="stringliteral">        files with identical calculation settings.</span></div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;<span class="stringliteral">        2) When we print the Q-Chem file, we should preserve the line</span></div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;<span class="stringliteral">        ordering of the &#39;rem&#39; section, but also be able to add &#39;rem&#39;</span></div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;<span class="stringliteral">        options at the end.</span></div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;<span class="stringliteral">        3) We should accommodate the use case that the Q-Chem file may have</span></div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;<span class="stringliteral">        follow-up calculations delimited by &#39;@@@&#39;.</span></div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;<span class="stringliteral">        4) We can read in all of the xyz&#39;s as a trajectory, but only the</span></div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;<span class="stringliteral">        Q-Chem settings belonging to the first xyz will be saved.</span></div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;</div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;        qcrem                = OrderedDict()</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;        qcrems               = []</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        xyz                  = []</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;        xyzs                 = []</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;        elem                 = []</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;        section              = <span class="keywordtype">None</span></div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;        <span class="comment"># The Z-matrix printing in new versions throws me off.</span></div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;        <span class="comment"># This could appear at the end of an optimization.</span></div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;        <span class="comment"># We detect when &quot;Z-matrix Print&quot; appears and skip the</span></div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;        <span class="comment"># section that follows.</span></div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;        zmatrix              = <span class="keyword">False</span></div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;        template             = []</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;        fff = <span class="keyword">False</span></div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;        inside_section       = <span class="keyword">False</span></div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;        reading_template     = <span class="keyword">True</span></div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;        charge               = 0</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;        mult                 = 0</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;        Answer               = {}</div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;        SectionData          = []</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;        template_cut         = 0</div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;        readsuf              = <span class="keyword">True</span></div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;        suffix               = [] <span class="comment"># The suffix, which comes after every atom line in the $molecule section, is for determining the MM atom type and topology.</span></div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;        ghost                = [] <span class="comment"># If the element in the $molecule section is preceded by an &#39;@&#39; sign, it&#39;s a ghost atom for counterpoise calculations.</span></div><div class="line"><a name="l03455"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a3710f2055a57158a9b5fbab2c5943683"> 3455</a></span>&#160;        infsm                = <span class="keyword">False</span></div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm).readlines():</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;            sline = line.split()</div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;            dline = line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a004a64d4b979002026c23d15a79e8dfc">split</a>()</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;Z-matrix Print&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;                zmatrix = <span class="keyword">True</span></div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;            <span class="keywordflow">if</span> re.match(<span class="stringliteral">r&#39;^\$&#39;</span>,line):</div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;                wrd = re.sub(<span class="stringliteral">r&#39;\$&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,line).lower()</div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;                <span class="keywordflow">if</span> zmatrix:</div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;                    <span class="keywordflow">if</span> wrd == <span class="stringliteral">&#39;end&#39;</span>:</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;                        zmatrix = <span class="keyword">False</span></div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;                    <span class="keywordflow">if</span> wrd == <span class="stringliteral">&#39;end&#39;</span>:</div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;                        inside_section = <span class="keyword">False</span></div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;                        <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;molecule&#39;</span>:</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;                            <span class="keywordflow">if</span> len(xyz) &gt; 0:</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;                                xyzs.append(np.array(xyz))</div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;                            xyz = []</div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;                            fff = <span class="keyword">True</span></div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;                            <span class="keywordflow">if</span> suffix:</div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;                                readsuf = <span class="keyword">False</span></div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;                        <span class="keywordflow">elif</span> section == <span class="stringliteral">&#39;rem&#39;</span>:</div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;                            <span class="keywordflow">if</span> reading_template:</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;                                qcrems.append(qcrem)</div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;                                qcrem = OrderedDict()</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;                        <span class="keywordflow">if</span> reading_template:</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;                            <span class="keywordflow">if</span> section != <span class="stringliteral">&#39;external_charges&#39;</span>: <span class="comment"># Ignore the external charges section because it varies from frame to frame.</span></div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;                                template.append((section,SectionData))</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;                        SectionData = []</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;                        section = wrd</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;                        inside_section = <span class="keyword">True</span></div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;            <span class="keywordflow">elif</span> inside_section:</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;                <span class="keywordflow">if</span> zmatrix:</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Parse error - zmatrix should not activate inside_section&#39;</span>)</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;                <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;molecule&#39;</span>:</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;                    <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">&quot;*&quot;</span>):</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;                        infsm = <span class="keyword">True</span></div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;                    <span class="keywordflow">if</span> (<span class="keywordflow">not</span> infsm) <span class="keywordflow">and</span> (len(dline) &gt;= 4 <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(dline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,4)])):</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;                        <span class="keywordflow">if</span> fff:</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;                            reading_template = <span class="keyword">False</span></div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;                            template_cut = list(i <span class="keywordflow">for</span> i, dat <span class="keywordflow">in</span> enumerate(template) <span class="keywordflow">if</span> <span class="stringliteral">&#39;@@@&#39;</span> <span class="keywordflow">in</span> dat[0])[-1]</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;                        <span class="keywordflow">else</span>:</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;                            <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^@&#39;</span>, sline[0]): <span class="comment"># This is a ghost atom</span></div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;                                ghost.append(<span class="keyword">True</span>)</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;                            <span class="keywordflow">else</span>:</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;                                ghost.append(<span class="keyword">False</span>)</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;                            elem.append(re.sub(<span class="stringliteral">&#39;@&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,sline[0]))</div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;                        xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:4]])</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;                        <span class="keywordflow">if</span> readsuf <span class="keywordflow">and</span> len(sline) &gt; 4:</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;                            whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;                            suffix.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+sline[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(4,len(sline))]))</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;                    <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;[+-]?[0-9]+ +[0-9]+$&quot;</span>,line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].strip()):</div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;                        <span class="keywordflow">if</span> <span class="keywordflow">not</span> fff:</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;                            charge = int(sline[0])</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;                            mult = int(sline[1])</div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;                        SectionData.append(line)</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;                <span class="keywordflow">elif</span> reading_template:</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;                    <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;basis&#39;</span>:</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;                        SectionData.append(line.split(<span class="stringliteral">&#39;!&#39;</span>)[0])</div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;                    <span class="keywordflow">elif</span> section == <span class="stringliteral">&#39;rem&#39;</span>:</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;                        S = splitter.findall(line)</div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;                        <span class="keywordflow">if</span> S[0] == <span class="stringliteral">&#39;!&#39;</span>:</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;                            qcrem[<span class="stringliteral">&#39;&#39;</span>.join(S[0:3]).lower()] = <span class="stringliteral">&#39;&#39;</span>.join(S[4:])</div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;                        <span class="keywordflow">else</span>:</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;                            qcrem[S[0].lower()] = <span class="stringliteral">&#39;&#39;</span>.join(S[2:])</div><div class="line"><a name="l03524"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#aa9caaf6d7ccff3a9077da98b4c8096a9"> 3524</a></span>&#160;                    <span class="keywordflow">else</span>:</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;                        SectionData.append(line)</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;^@+$&#39;</span>, line) <span class="keywordflow">and</span> reading_template:</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;                template.append((<span class="stringliteral">&#39;@@@&#39;</span>, []))</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;Welcome to Q-Chem&#39;</span>, line) <span class="keywordflow">and</span> reading_template <span class="keywordflow">and</span> fff:</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;                template.append((<span class="stringliteral">&#39;@@@&#39;</span>, []))</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;        <span class="keywordflow">if</span> template_cut != 0:</div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;            template = template[:template_cut]</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;        Answer = {<span class="stringliteral">&#39;qctemplate&#39;</span>  : template,</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;                  <span class="stringliteral">&#39;qcrems&#39;</span>      : qcrems,</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;                  <span class="stringliteral">&#39;charge&#39;</span>      : charge,</div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;                  <span class="stringliteral">&#39;mult&#39;</span>        : mult,</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;                  }</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;        <span class="keywordflow">if</span> suffix:</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;            Answer[<span class="stringliteral">&#39;qcsuf&#39;</span>] = suffix</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;        <span class="keywordflow">if</span> len(xyzs) &gt; 0:</div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;            Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = xyzs</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;            Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = [np.array([])]</div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;        <span class="keywordflow">if</span> len(elem) &gt; 0:</div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;            Answer[<span class="stringliteral">&#39;elem&#39;</span>] = elem</div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;        <span class="keywordflow">if</span> len(ghost) &gt; 0:</div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;            Answer[<span class="stringliteral">&#39;qm_ghost&#39;</span>] = ghost</div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;</div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;</div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af52f2ee9f9376925eab6e3309536e011">read_pdb</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Loads a PDB and returns a dictionary containing its data. &quot;&quot;&quot;</span></div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;</div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;        F1=open(fnm,<span class="stringliteral">&#39;r&#39;)</span></div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;<span class="stringliteral">        ParsedPDB=readPDB(F1)</span></div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;<span class="stringliteral">        Box = </span><span class="keywordtype">None</span></div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        <span class="comment">#Separate into distinct lists for each model.</span></div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;        PDBLines=[[]]</div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;        <span class="comment"># LPW: Keep a record of atoms which are followed by a terminal group.</span></div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;        PDBTerms=[]</div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;        ReadTerms = <span class="keyword">True</span></div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;        <span class="keywordflow">for</span> x <span class="keywordflow">in</span> ParsedPDB[0]:</div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;            <span class="keywordflow">if</span> x.__class__ <span class="keywordflow">in</span> [END, ENDMDL]:</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;                PDBLines.append([])</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;                ReadTerms = <span class="keyword">False</span></div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;            <span class="keywordflow">if</span> x.__class__ <span class="keywordflow">in</span> [ATOM, HETATM]:</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;                PDBLines[-1].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(x)</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;                <span class="keywordflow">if</span> ReadTerms:</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;                    PDBTerms.append(0)</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;            <span class="keywordflow">if</span> x.__class__ <span class="keywordflow">in</span> [TER] <span class="keywordflow">and</span> ReadTerms:</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;                PDBTerms[-1] = 1</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;            <span class="keywordflow">if</span> x.__class__==CRYST1:</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;                Box = <a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(x.a, x.b, x.c, x.alpha, x.beta, x.gamma)</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;        X=PDBLines[0]</div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;</div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;        XYZ=np.array([[x.x,x.y,x.z] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X])/10.0<span class="comment">#Convert to nanometers</span></div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;        AltLoc=np.array([x.altLoc <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>) <span class="comment"># Alternate location</span></div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;        ICode=np.array([x.iCode <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>) <span class="comment"># Insertion code</span></div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;        ChainID=np.array([x.chainID <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;        AtomNames=np.array([x.name <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;        ResidueNames=np.array([x.resName <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;        ResidueID=np.array([x.resSeq <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;int&#39;</span>)</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;        <span class="comment"># LPW: Try not to number Residue IDs starting from 1...</span></div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a16ef842ad2eb3048d82d2303639e56e0">positive_resid</a>:</div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;            ResidueID=ResidueID-ResidueID[0]+1</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;        XYZList=[]</div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;        <span class="keywordflow">for</span> Model <span class="keywordflow">in</span> PDBLines:</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;            <span class="comment"># Skip over subsequent models with the wrong number of atoms.</span></div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;            NewXYZ = []</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;            <span class="keywordflow">for</span> x <span class="keywordflow">in</span> Model:</div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;                NewXYZ.append([x.x,x.y,x.z])</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;            <span class="keywordflow">if</span> len(XYZList) == 0:</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;                XYZList.append(NewXYZ)</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;            <span class="keywordflow">elif</span> len(XYZList) &gt;= 1 <span class="keywordflow">and</span> (np.array(NewXYZ).shape == np.array(XYZList[-1]).shape):</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;                XYZList.append(NewXYZ)</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;        <span class="keywordflow">if</span> len(XYZList[-1])==0:<span class="comment">#If PDB contains trailing END / ENDMDL, remove empty list</span></div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;            XYZList.pop()</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;</div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;        <span class="comment"># Build a list of chemical elements</span></div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;        elem = []</div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(AtomNames)):</div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;            <span class="comment"># QYD: try to use original element list</span></div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;            <span class="keywordflow">if</span> X[i].element:</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;                elem.append(X[i].element)</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;                thiselem = AtomNames[i]</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;                <span class="keywordflow">if</span> len(thiselem) &gt; 1:</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;                    thiselem = re.sub(<span class="stringliteral">&#39;^[0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem)</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;                    thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;                elem.append(thiselem)</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;</div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;        XYZList=list(np.array(XYZList).reshape((-1,len(ChainID),3)))</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;</div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;        bonds = []</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;        <span class="comment"># Read in CONECT records.</span></div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;        F2=open(fnm,<span class="stringliteral">&#39;r&#39;)</span></div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;<span class="stringliteral">        </span><span class="comment"># QYD: Rewrite to support atom indices with 5 digits</span></div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;        <span class="comment"># i.e. CONECT143321433314334 -&gt; 14332 connected to 14333 and 14334</span></div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> F2:</div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;            <span class="keywordflow">if</span> line[:6] == <span class="stringliteral">&quot;CONECT&quot;</span>:</div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;                conect_A = int(line[6:11]) - 1</div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;                conect_B_list = []</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;                line_rest = line[11:]</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;                <span class="keywordflow">while</span> line_rest.strip():</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;                    <span class="comment"># Take 5 characters a time until run out of characters</span></div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;                    conect_B_list.append(int(line_rest[:5]) - 1)</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;                    line_rest = line_rest[5:]</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;                <span class="keywordflow">for</span> conect_B <span class="keywordflow">in</span> conect_B_list:</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;                    bond = (min((conect_A, conect_B)), max((conect_A, conect_B)))</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;                    bonds.append(bond)</div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;        Answer={<span class="stringliteral">&quot;xyzs&quot;</span>:XYZList, <span class="stringliteral">&quot;chain&quot;</span>:list(ChainID), <span class="stringliteral">&quot;altloc&quot;</span>:list(AltLoc), <span class="stringliteral">&quot;icode&quot;</span>:list(ICode),</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;                <span class="stringliteral">&quot;atomname&quot;</span>:[str(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> AtomNames], <span class="stringliteral">&quot;resid&quot;</span>:list(ResidueID), <span class="stringliteral">&quot;resname&quot;</span>:list(ResidueNames),</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;                <span class="stringliteral">&quot;elem&quot;</span>:elem, <span class="stringliteral">&quot;comms&quot;</span>:[<span class="stringliteral">&#39;&#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(XYZList))], <span class="stringliteral">&quot;terminal&quot;</span> : PDBTerms}</div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;</div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;        <span class="keywordflow">if</span> len(bonds) &gt; 0:</div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">top_settings</a>[<span class="stringliteral">&quot;read_bonds&quot;</span>] = <span class="keyword">True</span></div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;            Answer[<span class="stringliteral">&quot;bonds&quot;</span>] = bonds</div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;</div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;        <span class="keywordflow">if</span> Box <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;            Answer[<span class="stringliteral">&quot;boxes&quot;</span>] = [Box <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(XYZList))]</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;</div><div class="line"><a name="l03649"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af52f2ee9f9376925eab6e3309536e011"> 3649</a></span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a12369eb306cb29148e610e9ee08d7e2c">read_qcesp</a>(self, fnm, **kwargs):</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;        espxyz = []</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;        espval = []</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;            sline = line.split()</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;            <span class="keywordflow">if</span> len(sline) == 4 <span class="keywordflow">and</span> <a class="code" href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">all</a>([<a class="code" href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">isfloat</a>(sline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(4)]):</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;                espxyz.append([float(sline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3)])</div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;                espval.append(float(sline[3]))</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;        Answer = {<span class="stringliteral">&#39;qm_espxyzs&#39;</span> : [np.array(espxyz) * bohr2ang],</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;                  <span class="stringliteral">&#39;qm_espvals&#39;</span>  : [np.array(espval)]</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;                  }</div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;</div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a243cce870c970db8cac7f102325e872b">read_qcout</a>(self, fnm, errok=None, **kwargs):</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Q-Chem output file reader, adapted for our parser.</span></div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;<span class="stringliteral">        Q-Chem output files are very flexible and there&#39;s no way I can account for all of them.  Here&#39;s what</span></div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;<span class="stringliteral">        I am able to account for:</span></div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;<span class="stringliteral">        A list of:</span></div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;<span class="stringliteral">        - Coordinates</span></div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;<span class="stringliteral">        - Energies</span></div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;<span class="stringliteral">        - Forces</span></div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;<span class="stringliteral">        Calling with errok will proceed with reading file even if the specified error messages are encountered.</span></div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;<span class="stringliteral">        Note that each step in a geometry optimization counts as a frame.</span></div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;<span class="stringliteral">        As with all Q-Chem output files, note that successive calculations can have different numbers of atoms.</span></div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;        <span class="keywordflow">if</span> errok <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;            errok = []</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;        Answer   = {}</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;        xyzs     = []</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;        xyz      = []</div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;        elem     = []</div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;        elemThis = []</div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;        mkchg    = []</div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;        mkspn    = []</div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;        mkchgThis= []</div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;        mkspnThis= []</div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;        frqs     = []</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;        modes    = []</div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;        XMode    = 0</div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;        MMode    = 0</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;        VMode    = 0</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;        conv     = []</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;        convThis = 0</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;        readChargeMult = 0</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;        energy_scf = []</div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;        float_match  = {<span class="stringliteral">&#39;energy_scfThis&#39;</span>   : (<span class="stringliteral">r&quot;^[1-9][0-9]* +[-+]?([0-9]*\.)?[0-9]+ +[-+]?([0-9]*\.)?[0-9]+([eE][-+]?[0-9]+)[A-Za-z0 ]*$&quot;</span>, 1),</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;                        <span class="stringliteral">&#39;energy_opt&#39;</span>       : (<span class="stringliteral">r&quot;^Final energy is +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>, -1),</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;                        <span class="stringliteral">&#39;charge&#39;</span>           : (<span class="stringliteral">&quot;Sum of atomic charges&quot;</span>, -1),</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;                        <span class="stringliteral">&#39;mult&#39;</span>             : (<span class="stringliteral">&quot;Sum of spin +charges&quot;</span>, -1),</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;                        <span class="stringliteral">&#39;energy_mp2&#39;</span>       : (<span class="stringliteral">r&quot;^(ri)*(-)*mp2 +total energy += +[-+]?([0-9]*\.)?[0-9]+ +au$&quot;</span>,-2),</div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;                        <span class="stringliteral">&#39;energy_ccsd&#39;</span>      : (<span class="stringliteral">r&quot;^CCSD Total Energy += +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>,-1),</div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;                        <span class="stringliteral">&#39;energy_ccsdt&#39;</span>     : (<span class="stringliteral">r&quot;^CCSD\(T\) Total Energy += +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>,-1),</div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;                        <span class="stringliteral">&#39;zpe&#39;</span>              : (<span class="stringliteral">r&quot;^(\s+)?Zero point vibrational energy:\s+[-+]?([0-9]*\.)?[0-9]+\s+kcal\/mol$&quot;</span>, -2),</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;                        <span class="stringliteral">&#39;entropy&#39;</span>          : (<span class="stringliteral">r&quot;^(\s+)?Total Entropy:\s+[-+]?([0-9]*\.)?[0-9]+\s+cal\/mol\.K$&quot;</span>, -2),</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;                        <span class="stringliteral">&#39;enthalpy&#39;</span>         : (<span class="stringliteral">r&quot;^(\s+)?Total Enthalpy:\s+[-+]?([0-9]*\.)?[0-9]+\s+kcal\/mol$&quot;</span>, -2)</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;                        }</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;        matrix_match = {<span class="stringliteral">&#39;analytical_grad&#39;</span>  :<span class="stringliteral">&#39;Full Analytical Gradient&#39;</span>,</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;                        <span class="stringliteral">&#39;gradient_scf&#39;</span>     :<span class="stringliteral">&#39;Gradient of SCF Energy&#39;</span>,</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;                        <span class="stringliteral">&#39;gradient_mp2&#39;</span>     :<span class="stringliteral">&#39;Gradient of MP2 Energy&#39;</span>,</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;                        <span class="stringliteral">&#39;gradient_dualbas&#39;</span> :<span class="stringliteral">&#39;Gradient of the Dual-Basis Energy&#39;</span>,</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;                        <span class="stringliteral">&#39;hessian_scf&#39;</span>      :<span class="stringliteral">&#39;Hessian of the SCF Energy&#39;</span>,</div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;                        <span class="stringliteral">&#39;mayer&#39;</span>            :<span class="stringliteral">&#39;Mayer SCF Bond Order&#39;</span></div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;                       }</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;        qcrem    = OrderedDict()</div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;</div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;        matblank   = {<span class="stringliteral">&#39;match&#39;</span> : <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;All&#39;</span> : [], <span class="stringliteral">&#39;This&#39;</span> : [], <span class="stringliteral">&#39;Strip&#39;</span> : [], <span class="stringliteral">&#39;Mode&#39;</span> : 0}</div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;        Mats      = {}</div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;        Floats    = {}</div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;        <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> matrix_match.items():</div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;            Mats[key] = copy.deepcopy(matblank)</div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;        <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> float_match.items():</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;            Floats[key] = []</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;        </div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;        FSM = <span class="keyword">False</span></div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;        </div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;        IRCDir = 0</div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;        RPLine = <span class="keyword">False</span></div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;        </div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;        FDiff = <span class="keyword">False</span></div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;        <span class="comment">#---- Intrinsic reaction coordinate data.</span></div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;        <span class="comment"># stat: Status, X : Coordinates, E : Energies, Q : Charges, Sz: Spin-Z</span></div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;        <span class="comment"># Explanation of Status:</span></div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;        <span class="comment"># -1 : IRC calculation does not exist in this direction.</span></div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;        <span class="comment">#  0 : IRC calculation finished successfully.</span></div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;        <span class="comment">#  1 : IRC calculation did not finish but we can start a geometry optimization from the final point.</span></div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;        <span class="comment">#  2 : IRC calculation failed in this direction (i.e. set to 2 once we encounter first_irc_step).</span></div><div class="line"><a name="l03746"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a12369eb306cb29148e610e9ee08d7e2c"> 3746</a></span>&#160;        <span class="comment"># Two dictionaries of coordinates, energies, Mulliken Charges and Spin Populations.</span></div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;        IRCData = [OrderedDict([(<span class="stringliteral">&#39;stat&#39;</span>, -1), (<span class="stringliteral">&#39;X&#39;</span>, []), (<span class="stringliteral">&#39;E&#39;</span>, []), (<span class="stringliteral">&#39;Q&#39;</span>, []), (<span class="stringliteral">&#39;Sz&#39;</span>, [])]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2)]</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;        Answer[<span class="stringliteral">&#39;qcerr&#39;</span>] = <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;        fatal = 0</div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;        pcmgradmode = <span class="keyword">False</span></div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;        pcmgrads = []</div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;        pcmgrad = []</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;            line = line.strip().expandtabs()</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;Welcome to Q-Chem&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;                Answer[<span class="stringliteral">&#39;qcerr&#39;</span>] = <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;total processes killed&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;                Answer[<span class="stringliteral">&#39;qcerr&#39;</span>] = <span class="stringliteral">&#39;killed&#39;</span></div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;            <span class="keywordflow">if</span> fatal <span class="keywordflow">and</span> len(line.split()) &gt; 0:</div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;                <span class="comment"># Print the error message that comes after the &quot;fatal error&quot; line.</span></div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;                <span class="keywordflow">if</span> line <span class="keywordflow">in</span> errok:</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;                    Answer[<span class="stringliteral">&#39;qcerr&#39;</span>] = line.strip()</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;                    fatal = 0</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;                    logger.error(<span class="stringliteral">&#39;Calculation encountered a fatal error! (%s)\n&#39;</span> % line)</div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;Q-Chem fatal error&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;                fatal = 1</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;            <span class="keywordflow">if</span> XMode &gt;= 1:</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                <span class="comment"># Perfectionist here; matches integer, element, and three floating points</span></div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;                <span class="keywordflow">if</span> re.match(<span class="stringliteral">r&quot;^[0-9]+ +[A-Z][A-Za-z]?( +[-+]?([0-9]*\.)?[0-9]+){3}$&quot;</span>, line):</div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;                    XMode = 2</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;                    sline = line.split()</div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;                    elemThis.append(sline[1])</div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;                    xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[2:]])</div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;                <span class="keywordflow">elif</span> XMode == 2: <span class="comment"># Break out of the loop if we encounter anything other than atomic data</span></div><div class="line"><a name="l03778"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a243cce870c970db8cac7f102325e872b"> 3778</a></span>&#160;                    <span class="keywordflow">if</span> <span class="keywordflow">not</span> elem:</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;                        elem = elemThis</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;                    <span class="keywordflow">elif</span> elem != elemThis:</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;                        logger.error(<span class="stringliteral">&#39;Q-Chem output parser will not work if successive calculations have different numbers of atoms!\n&#39;</span>)</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;                        <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;                    elemThis = []</div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;                    xyzs.append(np.array(xyz))</div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;                    xyz  = []</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;                    XMode = 0</div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;Standard Nuclear Orientation&quot;</span>.lower(), line.lower()):</div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;                XMode = 1</div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;            <span class="keywordflow">if</span> MMode &gt;= 1:</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;                <span class="comment"># Perfectionist here; matches integer, element, and two floating points</span></div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;                <span class="keywordflow">if</span> re.match(<span class="stringliteral">r&quot;^[0-9]+ +[A-Z][a-z]?( +[-+]?([0-9]*\.)?[0-9]+){2}$&quot;</span>, line):</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;                    MMode = 2</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;                    sline = line.split()</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;                    mkchgThis.append(float(sline[2]))</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;                    mkspnThis.append(float(sline[3]))</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;                <span class="keywordflow">elif</span> re.match(<span class="stringliteral">r&quot;^[0-9]+ +[A-Z][a-z]?( +[-+]?([0-9]*\.)?[0-9]+){1}$&quot;</span>, line):</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;                    MMode = 2</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;                    sline = line.split()</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;                    mkchgThis.append(float(sline[2]))</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;                    mkspnThis.append(0.0)</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;                <span class="keywordflow">elif</span> MMode == 2: <span class="comment"># Break out of the loop if we encounter anything other than Mulliken charges</span></div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;                    mkchg.append(mkchgThis[:])</div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;                    mkspn.append(mkspnThis[:])</div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;                    mkchgThis = []</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;                    mkspnThis = []</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;                    MMode = 0</div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;Ground-State Mulliken Net Atomic Charges&quot;</span>.lower(), line.lower()):</div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;                MMode = 1</div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;            <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> float_match.items():</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;                <span class="keywordflow">if</span> re.match(val[0].lower(), line.lower()):</div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;                    Floats[key].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(float(line.split()[val[1]]))</div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;            <span class="comment">#----- Begin Intrinsic reaction coordinate stuff</span></div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;            <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">&#39;IRC&#39;</span>) <span class="keywordflow">and</span> IRCData[IRCDir][<span class="stringliteral">&#39;stat&#39;</span>] == -1:</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;stat&#39;</span>] = 2</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;Reaction path following.&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;                RPLine = <span class="keyword">True</span></div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;X&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(xyzs[-1])</div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;            </div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;            <span class="keywordflow">elif</span> RPLine:</div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;                RPLine = <span class="keyword">False</span></div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;E&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(float(line.split()[3]))</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;Q&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(mkchg[-1])</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;Sz&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(mkspn[-1])</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;            </div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;GEOMETRY OPTIMIZATION&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;X&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(xyzs[-1])</div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;E&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(energy_scf[-1])</div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;Q&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(mkchg[-1])</div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;Sz&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(mkspn[-1])</div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;            <span class="comment"># Determine whether we are in the forward or the backward part of the IRC.</span></div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;IRC -- convergence criterion reached.&quot;</span> <span class="keywordflow">in</span> line <span class="keywordflow">or</span> <span class="stringliteral">&quot;OPTIMIZATION CONVERGED&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;stat&#39;</span>] = 0</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;                IRCDir = 1</div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;MAXIMUM OPTIMIZATION CYCLES REACHED&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;stat&#39;</span>] = 1</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;            <span class="comment"># Output file indicates whether we can start a geometry optimization from this point.</span></div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;geom opt from&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;                IRCData[IRCDir][<span class="stringliteral">&#39;stat&#39;</span>] = 1</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;                IRCDir = 1</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;            <span class="comment">#----- End IRC stuff</span></div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;            <span class="comment"># Look for SCF energy</span></div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;            <span class="comment"># Note that COSMO has two SCF energies per calculation so this parser won&#39;t work.</span></div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;            <span class="comment"># Need to think of a better way.</span></div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;            <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;.*Convergence criterion met$&quot;</span>.lower(), line.lower()):</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;                conv.append(1)</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;                energy_scf.append(Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>][-1])</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;                Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;.*Including correction$&quot;</span>.lower(), line.lower()):</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;                energy_scf[-1] = Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>][-1]</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;                Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;            <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;.*Convergence failure$&quot;</span>.lower(), line.lower()):</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;                conv.append(0)</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;                Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;                energy_scf.append(0.0)</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;            <span class="comment">#----- If doing freezing string calculation, do NOT treat as a geometry optimization.</span></div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;Starting FSM Calculation&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;                FSM = <span class="keyword">True</span></div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;needFdiff: TRUE&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;                FDiff = <span class="keyword">True</span></div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;            <span class="comment">#----- Gradient from PCM</span></div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&quot;total gradient after adding PCM contribution&quot;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;                pcmgradmode = <span class="keyword">True</span></div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;            <span class="keywordflow">if</span> pcmgradmode:</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;                <span class="comment"># Perfectionist here; matches integer, and three floating points</span></div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                <span class="keywordflow">if</span> re.match(<span class="stringliteral">r&quot;^[0-9]+ +( +[-+]?([0-9]*\.)?[0-9]+){3}$&quot;</span>, line):</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;                    pcmgrad.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]])</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;Gradient time&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;                    pcmgradmode = <span class="keyword">False</span></div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;                    pcmgrads.append(np.array(pcmgrad).T)</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;                    pcmgrad = []</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;            <span class="comment">#----- Vibrational stuff</span></div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;            VModeNxt = <span class="keywordtype">None</span></div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;VIBRATIONAL ANALYSIS&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;                VMode = 1</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;            <span class="keywordflow">if</span> VMode &gt; 0 <span class="keywordflow">and</span> line.strip().startswith(<span class="stringliteral">&#39;Mode:&#39;</span>):</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;                VMode = 2</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;            <span class="keywordflow">if</span> VMode == 2:</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;                s = line.split()</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;Frequency:&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;                    nfrq = len(s) - 1</div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;                    frqs += [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> s[1:]]</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;                <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^X +Y +Z&#39;</span>, line):</div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;                    VModeNxt = 3</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;                    readmodes = [[] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(nfrq)]</div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;Imaginary Frequencies&#39;</span> <span class="keywordflow">in</span> line:</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                    VMode = 0</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;            <span class="keywordflow">if</span> VMode == 3:</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;                s = line.split()</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;                <span class="keywordflow">if</span> len(s) != nfrq*3+1:</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;                    VMode = 2</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;                    modes += readmodes[:]</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;                <span class="keywordflow">elif</span> <span class="stringliteral">&#39;TransDip&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> s:</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;                    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(nfrq):</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;                        readmodes[i].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>([float(s[j]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(1+3*i,4+3*i)])</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;            <span class="keywordflow">if</span> VModeNxt <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>: VMode = VModeNxt</div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;            <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> matrix_match.items():</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;                <span class="keywordflow">if</span> Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] &gt;= 1:</div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;                    <span class="comment"># Match any number of integers on a line.  This signifies a column header to start the matrix</span></div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;                    <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;^[0-9]+( +[0-9]+)*$&quot;</span>,line):</div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;                        Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = <a class="code" href="namespacesrc_1_1molecule.html#a157c193873713c7029b653c1ca51eb7a">add_strip_to_mat</a>(Mats[key][<span class="stringliteral">&quot;This&quot;</span>],Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>])</div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;                        Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>] = []</div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;                        Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] = 2</div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;                    <span class="comment"># Match a single integer followed by any number of floats.  This is a strip of data to be added to the matrix</span></div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;                    <span class="keywordflow">elif</span> re.match(<span class="stringliteral">r&quot;^[0-9]+( +[-+]?([0-9]*\.)?[0-9]+)+$&quot;</span>,line):</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;                        Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]])</div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;                    <span class="comment"># In any other case, the matrix is terminated.</span></div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;                    <span class="keywordflow">elif</span> Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] &gt;= 2:</div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;                        Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = <a class="code" href="namespacesrc_1_1molecule.html#a157c193873713c7029b653c1ca51eb7a">add_strip_to_mat</a>(Mats[key][<span class="stringliteral">&quot;This&quot;</span>],Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>])</div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;                        Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>] = []</div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;                        Mats[key][<span class="stringliteral">&quot;All&quot;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(np.array(Mats[key][<span class="stringliteral">&quot;This&quot;</span>]))</div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;                        Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = []</div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;                        Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] = 0</div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;                <span class="keywordflow">elif</span> re.match(val.lower(), line.lower()):</div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;                    Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] = 1</div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;</div><div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;mult&#39;</span>]) == 0:</div><div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;            Floats[<span class="stringliteral">&#39;mult&#39;</span>] = [0]</div><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;</div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;        <span class="comment"># Copy out the coordinate lists; Q-Chem output cannot be trusted to get the chemical elements</span></div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;        Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = xyzs</div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;        Answer[<span class="stringliteral">&#39;elem&#39;</span>] = elem</div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;        <span class="comment"># Read the output file as an input file to get a Q-Chem template.</span></div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;        Aux = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa9caaf6d7ccff3a9077da98b4c8096a9">read_qcin</a>(fnm)</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [<span class="stringliteral">&#39;qctemplate&#39;</span>, <span class="stringliteral">&#39;qcrems&#39;</span>, <span class="stringliteral">&#39;elem&#39;</span>, <span class="stringliteral">&#39;qm_ghost&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>]:</div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;            <span class="keywordflow">if</span> i <span class="keywordflow">in</span> Aux: Answer[i] = Aux[i]</div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;        <span class="comment"># Copy out the charge and multiplicity</span></div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;charge&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;            Answer[<span class="stringliteral">&#39;charge&#39;</span>] = int(Floats[<span class="stringliteral">&#39;charge&#39;</span>][0])</div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;mult&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;            Answer[<span class="stringliteral">&#39;mult&#39;</span>]   = int(Floats[<span class="stringliteral">&#39;mult&#39;</span>][0]) + 1</div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;        <span class="comment"># Copy out the energies and forces</span></div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;        <span class="comment"># Q-Chem can print out gradients with several different headings.</span></div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;        <span class="comment"># We start with the most reliable heading and work our way down.</span></div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;        <span class="keywordflow">if</span> len(pcmgrads) &gt; 0:</div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = pcmgrads</div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;        <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;analytical_grad&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = Mats[<span class="stringliteral">&#39;analytical_grad&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]</div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;        <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;gradient_mp2&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_mp2&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;        <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;gradient_dualbas&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_dualbas&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]</div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;        <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;gradient_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;            Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;        <span class="comment"># Mayer bond order matrix from SCF_FINAL_PRINT=1</span></div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;        <span class="keywordflow">if</span> len(Mats[<span class="stringliteral">&#39;mayer&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;            Answer[<span class="stringliteral">&#39;qm_bondorder&#39;</span>] = Mats[<span class="stringliteral">&#39;mayer&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>][-1]</div><div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;        <span class="keywordflow">if</span> len(Mats[<span class="stringliteral">&#39;hessian_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;            Answer[<span class="stringliteral">&#39;qm_hessians&#39;</span>] = Mats[<span class="stringliteral">&#39;hessian_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]</div><div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;        <span class="comment">#else:</span></div><div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;        <span class="comment">#    raise RuntimeError(&#39;There are no forces in %s&#39; % fnm)</span></div><div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;        <span class="comment"># Also work our way down with the energies.</span></div><div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;energy_ccsdt&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;            Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_ccsdt&#39;</span>]</div><div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;        <span class="keywordflow">elif</span> len(Floats[<span class="stringliteral">&#39;energy_ccsd&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;            Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_ccsd&#39;</span>]</div><div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;        <span class="keywordflow">elif</span> len(Floats[<span class="stringliteral">&#39;energy_mp2&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;            Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_mp2&#39;</span>]</div><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;        <span class="keywordflow">elif</span> len(energy_scf) &gt; 0:</div><div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;            <span class="keywordflow">if</span> len(Answer[<span class="stringliteral">&#39;qcrems&#39;</span>]) &gt; 0 <span class="keywordflow">and</span> <span class="stringliteral">&#39;correlation&#39;</span> <span class="keywordflow">in</span> Answer[<span class="stringliteral">&#39;qcrems&#39;</span>][0] <span class="keywordflow">and</span> Answer[<span class="stringliteral">&#39;qcrems&#39;</span>][0][<span class="stringliteral">&#39;correlation&#39;</span>].lower() <span class="keywordflow">in</span> [<span class="stringliteral">&#39;mp2&#39;</span>, <span class="stringliteral">&#39;rimp2&#39;</span>, <span class="stringliteral">&#39;ccsd&#39;</span>, <span class="stringliteral">&#39;ccsd(t)&#39;</span>]:</div><div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;                logger.error(<span class="stringliteral">&quot;Q-Chem was called with a post-HF theory but we only got the SCF energy\n&quot;</span>)</div><div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;            Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = energy_scf</div><div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;        <span class="keywordflow">elif</span> <span class="stringliteral">&#39;SCF failed to converge&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> errok:</div><div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;            logger.error(<span class="stringliteral">&#39;There are no energies in %s\n&#39;</span> % fnm)</div><div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;        <span class="comment"># Process ZPE, entropy, and enthalpy from a freq calculation</span></div><div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;zpe&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;            Answer[<span class="stringliteral">&#39;qm_zpe&#39;</span>] = Floats[<span class="stringliteral">&#39;zpe&#39;</span>]</div><div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;entropy&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;            Answer[<span class="stringliteral">&#39;qm_entropy&#39;</span>] = Floats[<span class="stringliteral">&#39;entropy&#39;</span>]</div><div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;        <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;enthalpy&#39;</span>]) &gt; 0:</div><div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;            Answer[<span class="stringliteral">&#39;qm_enthalpy&#39;</span>] = Floats[<span class="stringliteral">&#39;enthalpy&#39;</span>]</div><div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;</div><div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;        </div><div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;        <span class="keywordflow">if</span> 0 <span class="keywordflow">in</span> conv <span class="keywordflow">and</span> <span class="stringliteral">&#39;SCF failed to converge&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> errok:</div><div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;            logger.error(<span class="stringliteral">&#39;SCF convergence failure encountered in parsing %s\n&#39;</span> % fnm)</div><div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;        <span class="keywordflow">elif</span> 0 <span class="keywordflow">not</span> <span class="keywordflow">in</span> conv:</div><div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;            <span class="comment"># The molecule should have only one charge and one multiplicity</span></div><div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;            <span class="keywordflow">if</span> len(set(Floats[<span class="stringliteral">&#39;charge&#39;</span>])) != 1 <span class="keywordflow">or</span> len(set(Floats[<span class="stringliteral">&#39;mult&#39;</span>])) != 1:</div><div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;                logger.error(<span class="stringliteral">&#39;Unexpected number of charges or multiplicities in parsing %s\n&#39;</span> % fnm)</div><div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;</div><div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;        <span class="comment"># If we have any QM energies (not the case if SCF convergence failure)</span></div><div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_energies&#39;</span> <span class="keywordflow">in</span> Answer:</div><div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;            <span class="comment"># Catch the case of failed geometry optimizations.</span></div><div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;            <span class="keywordflow">if</span> len(Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]) == len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>]) + 1:</div><div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;                Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = Answer[<span class="stringliteral">&#39;xyzs&#39;</span>][:-1]</div><div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;            <span class="comment"># Catch the case of freezing string method, it prints out two extra coordinates.</span></div><div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;            <span class="keywordflow">if</span> len(Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]) == len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>]) + 2:</div><div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2):</div><div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;                    Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(0.0)</div><div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;                    mkchg.append([0.0 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> mkchg[-1]])</div><div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;                    mkspn.append([0.0 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> mkchg[-1]])</div><div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;            <span class="comment"># Q-Chem 4.4 prints out three more coordinates.</span></div><div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;            <span class="keywordflow">if</span> FSM <span class="keywordflow">and</span> (len(Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]) == len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>]) + 3):</div><div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;                Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = Answer[<span class="stringliteral">&#39;xyz&#39;</span>][1:]</div><div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2):</div><div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;                    Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(0.0)</div><div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;                    mkchg.append([0.0 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> mkchg[-1]])</div><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;                    mkspn.append([0.0 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> mkchg[-1]])</div><div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;            <span class="keywordflow">if</span> FDiff <span class="keywordflow">and</span> (len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>]) == (len(Answer[<span class="stringliteral">&#39;xyzs&#39;</span>])+1)):</div><div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;                logger.info(<span class="stringliteral">&quot;Aligning energies because finite difference calculation prints one extra&quot;</span>)</div><div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;                Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>][:-1]</div><div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;            lens = [len(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> (Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>], Answer[<span class="stringliteral">&#39;xyzs&#39;</span>])]</div><div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;            <span class="keywordflow">if</span> len(set(lens)) != 1:</div><div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;                logger.error(<span class="stringliteral">&#39;The number of energies and coordinates in %s are not the same : %s\n&#39;</span> % (fnm, str(lens)))</div><div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;</div><div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;        <span class="comment"># The number of atoms should all be the same</span></div><div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;        <span class="keywordflow">if</span> len(set([len(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]])) &gt; 1:</div><div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;            logger.error(<span class="stringliteral">&#39;The numbers of atoms across frames in %s are not all the same\n&#39;</span> % fnm)</div><div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;</div><div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_grads&#39;</span> <span class="keywordflow">in</span> Answer:</div><div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;            <span class="keywordflow">for</span> i, frc <span class="keywordflow">in</span> enumerate(Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>]):</div><div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;                Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>][i] = frc.T</div><div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> np.where(np.array(conv) == 0)[0]:</div><div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;                Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>].insert(i, Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>][0]*0.0)</div><div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;            <span class="keywordflow">if</span> len(Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>]) != len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>]):</div><div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;                logger.warning(<span class="stringliteral">&quot;Number of energies and gradients is inconsistent (composite jobs?)  Deleting gradients.&quot;</span>)</div><div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;                del Answer[<span class="stringliteral">&#39;qm_grads&#39;</span>]</div><div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;        <span class="comment"># A strange peculiarity; Q-Chem sometimes prints out the final Mulliken charges a second time, after the geometry optimization.</span></div><div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;        <span class="keywordflow">if</span> mkchg:</div><div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;            Answer[<span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>] = list(np.array(mkchg))</div><div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> np.where(np.array(conv) == 0)[0]:</div><div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;                Answer[<span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>].insert(i, np.array([0.0 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mkchg[-1]]))</div><div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;            Answer[<span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>] = Answer[<span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>][:len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>])]</div><div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;        <span class="keywordflow">if</span> mkspn:</div><div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;            Answer[<span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>] = list(np.array(mkspn))</div><div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> np.where(np.array(conv) == 0)[0]:</div><div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;                Answer[<span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>].insert(i, np.array([0.0 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mkspn[-1]]))</div><div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;            Answer[<span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>] = Answer[<span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>][:len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>])]</div><div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;</div><div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;        Answer[<span class="stringliteral">&#39;Irc&#39;</span>] = IRCData</div><div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;        <span class="keywordflow">if</span> len(modes) &gt; 0:</div><div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;            unnorm = [np.array(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> modes]</div><div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;            Answer[<span class="stringliteral">&#39;freqs&#39;</span>] = np.array(frqs)</div><div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;            Answer[<span class="stringliteral">&#39;modes&#39;</span>] = [i/np.linalg.norm(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> unnorm]</div><div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;</div><div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;        <span class="keywordflow">return</span> Answer</div><div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;</div><div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;    <span class="comment">#|         Writing functions         |#</span></div><div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;    <span class="comment">#=====================================#</span></div><div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;</div><div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a21d78053aab2fda1fd5e2577a02ec696">write_qcin</a>(self, selection, **kwargs):</div><div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;qctemplate&#39;</span>,<span class="stringliteral">&#39;qcrems&#39;</span>,<span class="stringliteral">&#39;charge&#39;</span>,<span class="stringliteral">&#39;mult&#39;</span>)</div><div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;        out = []</div><div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;read&#39;</span> <span class="keywordflow">in</span> kwargs:</div><div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;            read = kwargs[<span class="stringliteral">&#39;read&#39;</span>]</div><div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;            read = <span class="keyword">False</span></div><div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;        <span class="keywordflow">for</span> SI, I <span class="keywordflow">in</span> enumerate(selection):</div><div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;            fsm = <span class="keyword">False</span></div><div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;            remidx = 0</div><div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;            molecule_printed = <span class="keyword">False</span></div><div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;            <span class="comment"># Each &#39;extchg&#39; has number_of_atoms * 4 elements corresponding to x, y, z, q.</span></div><div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_extchgs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;                extchg = self.qm_extchgs[I]</div><div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;                out.append(<span class="stringliteral">&#39;$external_charges&#39;</span>)</div><div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;                <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(extchg)):</div><div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;                    out.append(<span class="stringliteral">&quot;% 15.10f % 15.10f % 15.10f %15.10f&quot;</span> % (extchg[i,0],extchg[i,1],extchg[i,2],extchg[i,3]))</div><div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;                out.append(<span class="stringliteral">&#39;$end&#39;</span>)</div><div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;            <span class="keywordflow">for</span> SectName, SectData <span class="keywordflow">in</span> self.qctemplate:</div><div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;                <span class="keywordflow">if</span> <span class="stringliteral">&#39;jobtype&#39;</span> <span class="keywordflow">in</span> self.qcrems[remidx] <span class="keywordflow">and</span> self.qcrems[remidx][<span class="stringliteral">&#39;jobtype&#39;</span>].lower() == <span class="stringliteral">&#39;fsm&#39;</span>:</div><div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;                    fsm = <span class="keyword">True</span></div><div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;                    <span class="keywordflow">if</span> len(selection) != 2:</div><div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;                        logger.error(<span class="stringliteral">&#39;For freezing string method, please provide two structures only.\n&#39;</span>)</div><div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;                        <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;                <span class="keywordflow">if</span> SectName != <span class="stringliteral">&#39;@@@&#39;</span>:</div><div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;                    out.append(<span class="stringliteral">&#39;$%s&#39;</span> % SectName)</div><div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;                    <span class="keywordflow">for</span> line <span class="keywordflow">in</span> SectData:</div><div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;                        out.append(line)</div><div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;                    <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;molecule&#39;</span>:</div><div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;                        <span class="keywordflow">if</span> molecule_printed == <span class="keyword">False</span>:</div><div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;                            molecule_printed = <span class="keyword">True</span></div><div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;                            <span class="keywordflow">if</span> read:</div><div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;                                out.append(<span class="stringliteral">&quot;read&quot;</span>)</div><div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;                            <span class="keywordflow">elif</span> self.na &gt; 0:</div><div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;                                out.append(<span class="stringliteral">&quot;%i %i&quot;</span> % (self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a146f60bbab00e12c5754fd666233e86f">charge</a>, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#aa6fbbf278cf844c7bbdac896c71f5c64">mult</a>))</div><div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;                                an = 0</div><div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;                                <span class="keywordflow">for</span> e, x <span class="keywordflow">in</span> zip(self.elem, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]):</div><div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;                                    pre = <span class="stringliteral">&#39;@&#39;</span> <span class="keywordflow">if</span> (<span class="stringliteral">&#39;qm_ghost&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;qm_ghost&#39;</span>][an]) <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;                                    suf =  self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;qcsuf&#39;</span>][an] <span class="keywordflow">if</span> <span class="stringliteral">&#39;qcsuf&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;                                    out.append(pre + <a class="code" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">format_xyz_coord</a>(e, x) + suf)</div><div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;                                    an += 1</div><div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;                                <span class="keywordflow">if</span> fsm:</div><div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;                                    out.append(<span class="stringliteral">&quot;****&quot;</span>)</div><div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;                                    an = 0</div><div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;                                    <span class="keywordflow">for</span> e, x <span class="keywordflow">in</span> zip(self.elem, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[selection[SI+1]]):</div><div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;                                        pre = <span class="stringliteral">&#39;@&#39;</span> <span class="keywordflow">if</span> (<span class="stringliteral">&#39;qm_ghost&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;qm_ghost&#39;</span>][an]) <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;                                        suf =  self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>[<span class="stringliteral">&#39;qcsuf&#39;</span>][an] <span class="keywordflow">if</span> <span class="stringliteral">&#39;qcsuf&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;                                        out.append(pre + <a class="code" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">format_xyz_coord</a>(e, x) + suf)</div><div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;                                        an += 1</div><div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;                    <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;rem&#39;</span>:</div><div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;                        <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> self.qcrems[remidx].items():</div><div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;                            out.append(<span class="stringliteral">&quot;%-21s %-s&quot;</span> % (key, str(val)))</div><div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;                    <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;comments&#39;</span> <span class="keywordflow">and</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;                        out.append(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I])</div><div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;                    out.append(<span class="stringliteral">&#39;$end&#39;</span>)</div><div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;                    remidx += 1</div><div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;                    out.append(<span class="stringliteral">&#39;@@@&#39;</span>)</div><div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;                out.append(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;            <span class="comment">#if I &lt; (len(self) - 1):</span></div><div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;            <span class="keywordflow">if</span> fsm: <span class="keywordflow">break</span></div><div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;            <span class="keywordflow">if</span> I != selection[-1]:</div><div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;                out.append(<span class="stringliteral">&#39;@@@&#39;</span>)</div><div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;                out.append(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;</div><div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af42c16177cc7cbfce3c0b2be7b132480">write_xyz</a>(self, selection, **kwargs):</div><div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;        out = []</div><div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;            out.append(<span class="stringliteral">&quot;%-5i&quot;</span> % self.na)</div><div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;            out.append(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I])</div><div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;                out.append(<a class="code" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">format_xyz_coord</a>(self.elem[i],xyz[i]))</div><div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;</div><div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36b472b4d2504123fab8083068f8315a">get_reaxff_atom_types</a>(self):</div><div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;<span class="stringliteral">        Return a list of element names which maps the LAMMPS atom types</span></div><div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;<span class="stringliteral">        to the ReaxFF elements</span></div><div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;        elist = []</div><div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;            <span class="keywordflow">if</span> self.elem[i] <span class="keywordflow">not</span> <span class="keywordflow">in</span> elist:</div><div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;                elist.append(self.elem[i])</div><div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;        <span class="keywordflow">return</span> elist</div><div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;</div><div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a7b85106cd6cc8e1d3e7e1ccb4edff551">write_lammps_data</a>(self, selection, **kwargs):</div><div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;<span class="stringliteral">        Write the first frame of the selection to a LAMMPS data file</span></div><div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;<span class="stringliteral">        for the purpose of automatically initializing a LAMMPS simulation.</span></div><div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;<span class="stringliteral">        This function makes several assumptions until further notice:</span></div><div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;<span class="stringliteral">        (1) We are interested in a ReaxFF simulation</span></div><div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;<span class="stringliteral">        (2) Atom types will be generated from elements</span></div><div class="line"><a name="l04147"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a21d78053aab2fda1fd5e2577a02ec696"> 4147</a></span>&#160;<span class="stringliteral">        &quot;&quot;&quot;</span></div><div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;        I = selection[0]</div><div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;        out = []</div><div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;        comm = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I]</div><div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> comm.startswith(<span class="stringliteral">&quot;#&quot;</span>):</div><div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;            comm = <span class="stringliteral">&quot;# &quot;</span> + comm</div><div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;        atmap = OrderedDict()</div><div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;            <span class="keywordflow">if</span> self.elem[i] <span class="keywordflow">not</span> <span class="keywordflow">in</span> atmap:</div><div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;                atmap[self.elem[i]] = len(atmap.keys()) + 1</div><div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;</div><div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;        <span class="comment"># First line is a comment</span></div><div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;        out.append(comm)</div><div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;        <span class="comment"># Next, print the number of atoms and atom types</span></div><div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;        out.append(<span class="stringliteral">&quot;%i atoms&quot;</span> % self.na)</div><div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;        out.append(<span class="stringliteral">&quot;%i atom types&quot;</span> % len(atmap.keys()))</div><div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;        <span class="comment"># Next, print the simulation box</span></div><div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;        <span class="comment"># We throw an error if the atoms are outside the simulation box</span></div><div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;        <span class="comment"># If there is no simulation box, then we print upper and lower bounds</span></div><div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;        xlo = 0.0</div><div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;        ylo = 0.0</div><div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;        zlo = 0.0</div><div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;            xhi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].a</div><div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;            yhi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].b</div><div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;            zhi = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].c</div><div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;            xlo = np.floor(np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,0]))</div><div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;            ylo = np.floor(np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,1]))</div><div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;            zlo = np.floor(np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,2]))</div><div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;            xhi = np.ceil(np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,0]))+30</div><div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;            yhi = np.ceil(np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,1]))+30</div><div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;            zhi = np.ceil(np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,2]))+30</div><div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;        <span class="keywordflow">if</span> (np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,0]) &lt; xlo <span class="keywordflow">or</span></div><div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;            np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,1]) &lt; ylo <span class="keywordflow">or</span></div><div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;            np.min(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,2]) &lt; zlo <span class="keywordflow">or</span></div><div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;            np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,0]) &gt; xhi <span class="keywordflow">or</span></div><div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;            np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,1]) &gt; yhi <span class="keywordflow">or</span></div><div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;            np.max(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][:,2]) &gt; zhi):</div><div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;            logger.warning(<span class="stringliteral">&quot;Some atom positions are outside the simulation box, be careful&quot;</span>)</div><div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;        out.append(<span class="stringliteral">&quot;% .3f % .3f xlo xhi&quot;</span> % (xlo, xhi))</div><div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;        out.append(<span class="stringliteral">&quot;% .3f % .3f ylo yhi&quot;</span> % (ylo, yhi))</div><div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;        out.append(<span class="stringliteral">&quot;% .3f % .3f zlo zhi&quot;</span> % (zlo, zhi))</div><div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;        <span class="comment"># Next, get the masses</span></div><div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;        out.append(<span class="stringliteral">&quot;Masses&quot;</span>)</div><div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;        <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(atmap.keys()):</div><div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;            out.append(<span class="stringliteral">&quot;%i %.4f&quot;</span> % (i+1, PeriodicTable[a]))</div><div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;        <span class="comment"># Next, print the atom positions</span></div><div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;        out.append(<span class="stringliteral">&quot;Atoms&quot;</span>)</div><div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;        out.append(<span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;            <span class="comment"># First number is the index of the atom starting from 1.</span></div><div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;            <span class="comment"># Second number is a molecule tag that is unimportant.</span></div><div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;            <span class="comment"># Third number is the atom type.</span></div><div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;            <span class="comment"># Fourth number is the charge (set to zero).</span></div><div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;            <span class="comment"># Fifth through seventh numbers are the positions</span></div><div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;            out.append(<span class="stringliteral">&quot;%4i 1 %2i 0.0 % 15.10f % 15.10f % 15.10f&quot;</span> % (i+1, list(atmap.keys()).index(self.elem[i])+1, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][i, 0], self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][i, 1], self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I][i, 2]))</div><div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;</div><div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab74230360451f0feefcfceae3b292223">write_molproq</a>(self, selection, **kwargs):</div><div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>,<span class="stringliteral">&#39;partial_charge&#39;</span>)</div><div class="line"><a name="l04213"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af42c16177cc7cbfce3c0b2be7b132480"> 4213</a></span>&#160;        out = []</div><div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;            <span class="comment"># Comment comes first, then number of atoms.</span></div><div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;            out.append(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I])</div><div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;            out.append(<span class="stringliteral">&quot;%-5i&quot;</span> % self.na)</div><div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;                out.append(<span class="stringliteral">&quot;% 15.10f % 15.10f % 15.10f % 15.10f   0&quot;</span> % (xyz[i,0],xyz[i,1],xyz[i,2],self.partial_charge[i]))</div><div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;</div><div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a94a0b29f772bb5e6e03383fd854ad70a">write_mdcrd</a>(self, selection, **kwargs):</div><div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;        <span class="comment"># In mdcrd files, there is only one comment line</span></div><div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;        out = [<span class="stringliteral">&#39;mdcrd file generated using %s&#39;</span> % package]</div><div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04229"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a36b472b4d2504123fab8083068f8315a"> 4229</a></span>&#160;            out += [<span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&quot;%8.3f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> g]) <span class="keywordflow">for</span> g <span class="keywordflow">in</span> <a class="code" href="namespacesrc_1_1molecule.html#a3d07eb6fe9de1d679c82213a4d7e988d">grouper</a>(10, list(xyz.flatten()))]</div><div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;                out.append(<span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&quot;%8.3f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].c]]))</div><div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;</div><div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af975f93f5c43f518b84d0bd067c75604">write_inpcrd</a>(self, selection, sn=None, **kwargs):</div><div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;        <span class="keywordflow">if</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>) != 1 <span class="keywordflow">and</span> sn <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;            logger.error(<span class="stringliteral">&quot;inpcrd can only be written for a single-frame trajectory\n&quot;</span>)</div><div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;            <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;        <span class="keywordflow">if</span> sn <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a> = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn]]</div><div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a> = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[sn]]</div><div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;        <span class="comment"># In inp files, there is only one comment line</span></div><div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;        <span class="comment"># I believe 20A4 means 80 characters.</span></div><div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;        out = [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[0][:80], <span class="stringliteral">&#39;%5i&#39;</span> % self.na]</div><div class="line"><a name="l04245"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a7b85106cd6cc8e1d3e7e1ccb4edff551"> 4245</a></span>&#160;        xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[0]</div><div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;        strout = <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;        <span class="keywordflow">for</span> ix, x <span class="keywordflow">in</span> enumerate(xyz):</div><div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;            strout += <span class="stringliteral">&quot;%12.7f%12.7f%12.7f&quot;</span> % (x[0], x[1], x[2])</div><div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;            <span class="keywordflow">if</span> ix%2 == 1 <span class="keywordflow">or</span> ix == (len(xyz) - 1):</div><div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;                out.append(strout)</div><div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;                strout = <span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;        <span class="comment"># From reading the AMBER file specification I am not sure if this is correct.</span></div><div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;            out.append(<span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&quot;%12.7f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].a, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].b, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].c]]))</div><div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;</div><div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5c04a001643a8165de635697f2d418f3">write_arc</a>(self, selection, **kwargs):</div><div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;        self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;        out = []</div><div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;tinkersuf&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;Beware, this .arc file contains no atom type or topology info\n&quot;</span>)</div><div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;            out.append(<span class="stringliteral">&quot;%6i  %s&quot;</span> % (self.na, self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I]))</div><div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;                b = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I]</div><div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;                out.append(<span class="stringliteral">&quot; %11.6f %11.6f %11.6f %11.6f %11.6f %11.6f&quot;</span> % (b.a, b.b, b.c, b.alpha, b.beta, b.gamma))</div><div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;                out.append(<span class="stringliteral">&quot;%6i  %s%s&quot;</span> % (i+1,<a class="code" href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">format_xyz_coord</a>(self.elem[i],xyz[i],tinker=<span class="keyword">True</span>),self.tinkersuf[i] <span class="keywordflow">if</span> <span class="stringliteral">&#39;tinkersuf&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span>))</div><div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;</div><div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#accdd08d1cdef8a51da59e1fc2268c7d8">write_gro</a>(self, selection, **kwargs):</div><div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;        out = []</div><div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;        <span class="keywordflow">if</span> sys.stdin.isatty():</div><div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a68eee3cd2b86790c0cb2954c8310bd29">require_resname</a>()</div><div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af74bcae2931e36e08ff33037b1b0fa37">require_resid</a>()</div><div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab72729cb3e6b2ed086669142c1409ed4">require_boxes</a>()</div><div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>,<span class="stringliteral">&#39;resname&#39;</span>,<span class="stringliteral">&#39;resid&#39;</span>,<span class="stringliteral">&#39;boxes&#39;</span>)</div><div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;</div><div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;            count = 0</div><div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;            resid = -1</div><div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;            atomname = []</div><div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[i] != resid:</div><div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;                    count = 0</div><div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;                count += 1</div><div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;                resid = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[i]</div><div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;                atomname.append(<span class="stringliteral">&quot;%s%i&quot;</span> % (self.elem[i], count))</div><div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;            atomname = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a></div><div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;</div><div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;            xyzwrite = xyz.copy()</div><div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;            xyzwrite /= 10.0 <span class="comment"># GROMACS uses nanometers</span></div><div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;            out.append(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">comms</a>[I])</div><div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;            out.append(<span class="stringliteral">&quot;%5i&quot;</span> % self.na)</div><div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;            <span class="keywordflow">for</span> an, line <span class="keywordflow">in</span> enumerate(xyzwrite):</div><div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;                out.append(<a class="code" href="namespacesrc_1_1molecule.html#a081f51f922805fee2d219661d7d31743">format_gro_coord</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[an],self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[an],atomname[an],an+1,xyzwrite[an]))</div><div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;            out.append(<a class="code" href="namespacesrc_1_1molecule.html#a373f82faf5d8f3ce84095ed74ab77425">format_gro_box</a>(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I]))</div><div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;</div><div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a722ba2597f067fc042169926c0b37274">write_dcd</a>(self, selection, **kwargs):</div><div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;        <span class="keywordflow">if</span> _dcdlib.vmdplugin_init() != 0:</div><div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;            logger.error(<span class="stringliteral">&quot;Unable to init DCD plugin\n&quot;</span>)</div><div class="line"><a name="l04309"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#ab74230360451f0feefcfceae3b292223"> 4309</a></span>&#160;            <span class="keywordflow">raise</span> IOError</div><div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;        natoms    = c_int(self.na)</div><div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;        fname     = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a96266112f8af20de9810e2fee0d5861c">fout</a>.<a class="code" href="namespacesrc_1_1nifty.html#a377e501a4a558c58bb2a70bae058e3e6">encode</a>(<span class="stringliteral">&#39;ascii&#39;</span>)</div><div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;        dcd       = _dcdlib.open_dcd_write(create_string_buffer(fname), <span class="stringliteral">&quot;dcd&quot;</span>, natoms)</div><div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;        ts        = <a class="code" href="classsrc_1_1molecule_1_1MolfileTimestep.html">MolfileTimestep</a>()</div><div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;        _xyz      = c_float * (natoms.value * 3)</div><div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;            ts.coords = _xyz(*list(xyz.flatten()))</div><div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;            ts.A      = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].a <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 1.0)</div><div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;            ts.B      = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].b <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 1.0)</div><div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;            ts.C      = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].c <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 1.0)</div><div class="line"><a name="l04321"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a94a0b29f772bb5e6e03383fd854ad70a"> 4321</a></span>&#160;            ts.alpha  = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].alpha  <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 90.0)</div><div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;            ts.beta   = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].beta   <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 90.0)</div><div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;            ts.gamma  = c_float(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[I].gamma  <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">else</span> 90.0)</div><div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;            result    = _dcdlib.write_timestep(dcd, byref(ts))</div><div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;            <span class="keywordflow">if</span> result != 0:</div><div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;                logger.error(<span class="stringliteral">&quot;Error encountered when writing DCD\n&quot;</span>)</div><div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;                <span class="keywordflow">raise</span> IOError</div><div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;        </div><div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;        _dcdlib.close_file_write(dcd)</div><div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;        dcd = <span class="keywordtype">None</span></div><div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;</div><div class="line"><a name="l04332"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#af975f93f5c43f518b84d0bd067c75604"> 4332</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#adea929913736e69b7af631dc0014a1e7">write_pdb</a>(self, selection, **kwargs):</div><div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;        standardResidues = [<span class="stringliteral">&#39;ALA&#39;</span>, <span class="stringliteral">&#39;ASN&#39;</span>, <span class="stringliteral">&#39;CYS&#39;</span>, <span class="stringliteral">&#39;GLU&#39;</span>, <span class="stringliteral">&#39;HIS&#39;</span>, <span class="stringliteral">&#39;LEU&#39;</span>, <span class="stringliteral">&#39;MET&#39;</span>, <span class="stringliteral">&#39;PRO&#39;</span>, <span class="stringliteral">&#39;THR&#39;</span>, <span class="stringliteral">&#39;TYR&#39;</span>, <span class="comment"># Standard amino acids</span></div><div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;                            <span class="stringliteral">&#39;ARG&#39;</span>, <span class="stringliteral">&#39;ASP&#39;</span>, <span class="stringliteral">&#39;GLN&#39;</span>, <span class="stringliteral">&#39;GLY&#39;</span>, <span class="stringliteral">&#39;ILE&#39;</span>, <span class="stringliteral">&#39;LYS&#39;</span>, <span class="stringliteral">&#39;PHE&#39;</span>, <span class="stringliteral">&#39;SER&#39;</span>, <span class="stringliteral">&#39;TRP&#39;</span>, <span class="stringliteral">&#39;VAL&#39;</span>, <span class="comment"># Standard amino acids</span></div><div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;                            <span class="stringliteral">&#39;HID&#39;</span>, <span class="stringliteral">&#39;HIE&#39;</span>, <span class="stringliteral">&#39;HIP&#39;</span>, <span class="stringliteral">&#39;ASH&#39;</span>, <span class="stringliteral">&#39;GLH&#39;</span>, <span class="stringliteral">&#39;TYD&#39;</span>, <span class="stringliteral">&#39;CYM&#39;</span>, <span class="stringliteral">&#39;CYX&#39;</span>, <span class="stringliteral">&#39;LYN&#39;</span>, <span class="comment"># Some alternate protonation states</span></div><div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;                            <span class="stringliteral">&#39;PTR&#39;</span>, <span class="stringliteral">&#39;SEP&#39;</span>, <span class="stringliteral">&#39;TPO&#39;</span>, <span class="stringliteral">&#39;Y1P&#39;</span>, <span class="stringliteral">&#39;S1P&#39;</span>, <span class="stringliteral">&#39;T1P&#39;</span>, <span class="comment"># Phosphorylated amino acids</span></div><div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;                            <span class="stringliteral">&#39;HOH&#39;</span>, <span class="stringliteral">&#39;SOL&#39;</span>, <span class="stringliteral">&#39;WAT&#39;</span>, <span class="comment"># Common residue names for water</span></div><div class="line"><a name="l04338"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b"> 4338</a></span>&#160;                            <span class="stringliteral">&#39;A&#39;</span>, <span class="stringliteral">&#39;G&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, <span class="stringliteral">&#39;U&#39;, &#39;</span>I&#39;, &#39;DA&#39;, &#39;DG&#39;, &#39;DC&#39;, &#39;DT&#39;, &#39;DI&#39;]</div><div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;        <span class="comment"># When converting from pdb to xyz in interactive prompt,</span></div><div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;        <span class="comment"># ask user for some PDB-specific info.</span></div><div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;        <span class="keywordflow">if</span> sys.stdin.isatty():</div><div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)</div><div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a68eee3cd2b86790c0cb2954c8310bd29">require_resname</a>()</div><div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af74bcae2931e36e08ff33037b1b0fa37">require_resid</a>()</div><div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>,<span class="stringliteral">&#39;resname&#39;</span>,<span class="stringliteral">&#39;resid&#39;</span>)</div><div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;        write_conect = kwargs.pop(<span class="stringliteral">&#39;write_conect&#39;</span>, 1)</div><div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;        <span class="comment"># Create automatic atom names if not present</span></div><div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;        <span class="comment"># in data structure: these are just placeholders.</span></div><div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;            count = 0</div><div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;            resid = -1</div><div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;            atomnames = []</div><div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04355"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a5c04a001643a8165de635697f2d418f3"> 4355</a></span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[i] != resid:</div><div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;                    count = 0</div><div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;                count += 1</div><div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;                resid = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>[i]</div><div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;                atomnames.append(<span class="stringliteral">&quot;%s%i&quot;</span> % (self.elem[i], count))</div><div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a> = atomnames</div><div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;        <span class="comment"># Standardize formatting of atom names.</span></div><div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;        atomNames = []</div><div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;        <span class="keywordflow">for</span> i, atomname <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>):</div><div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;            <span class="keywordflow">if</span> len(atomname) &lt; 4 <span class="keywordflow">and</span> atomname[:1].isalpha() <span class="keywordflow">and</span> len(self.elem[i]) &lt; 2:</div><div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;                atomName = <span class="stringliteral">&#39; &#39;</span>+atomname</div><div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;            <span class="keywordflow">elif</span> len(atomname) &gt; 4:</div><div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;                atomName = atomname[:4]</div><div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;                atomName = atomname</div><div class="line"><a name="l04370"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#accdd08d1cdef8a51da59e1fc2268c7d8"> 4370</a></span>&#160;            atomNames.append(atomName)</div><div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;        <span class="comment"># Chain names. Default to &#39;A&#39; for everything</span></div><div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;chain&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;            chainNames = [<span class="stringliteral">&#39;A&#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]</div><div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;            chainNames = [i[0] <span class="keywordflow">if</span> len(i)&gt;0 <span class="keywordflow">else</span> <span class="stringliteral">&#39; &#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.chain]</div><div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;        <span class="comment"># Standardize formatting of residue names.</span></div><div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;        resNames = []</div><div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;        <span class="keywordflow">for</span> resname <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>:</div><div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;            <span class="keywordflow">if</span> len(resname) &gt; 3:</div><div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;                resName = resname[:3]</div><div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;                resName = resname</div><div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;            resNames.append(resName)</div><div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;        <span class="comment"># Standardize formatting of residue IDs.</span></div><div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;        resIds = []</div><div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;        <span class="keywordflow">for</span> resid <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a>:</div><div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;            resIds.append(<span class="stringliteral">&quot;%4d&quot;</span> % (resid%10000))</div><div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;        <span class="comment"># Standardize record names.</span></div><div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;        records = []</div><div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;        <span class="keywordflow">for</span> resname <span class="keywordflow">in</span> resNames:</div><div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;            <span class="keywordflow">if</span> resname <span class="keywordflow">in</span> [<span class="stringliteral">&#39;HOH&#39;</span>, <span class="stringliteral">&#39;SOL&#39;</span>, <span class="stringliteral">&#39;WAT&#39;</span>]:</div><div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;                records.append(<span class="stringliteral">&quot;HETATM&quot;</span>)</div><div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;            <span class="keywordflow">elif</span> resname <span class="keywordflow">in</span> standardResidues:</div><div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;                records.append(<span class="stringliteral">&quot;ATOM  &quot;</span>)</div><div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;                records.append(<span class="stringliteral">&quot;HETATM&quot;</span>)</div><div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;</div><div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;        out = []</div><div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;        <span class="comment"># Create the PDB header.</span></div><div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;        out.append(<span class="stringliteral">&quot;REMARK   1 CREATED WITH %s %s&quot;</span> % (package.upper(), str(date.today())))</div><div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;            a = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].a</div><div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;            b = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].b</div><div class="line"><a name="l04404"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#a722ba2597f067fc042169926c0b37274"> 4404</a></span>&#160;            c = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].c</div><div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;            alpha = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].alpha</div><div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;            beta = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].beta</div><div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;            gamma = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>[0].gamma</div><div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;            out.append(<span class="stringliteral">&quot;CRYST1%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f P 1           1 &quot;</span> % (a, b, c, alpha, beta, gamma))</div><div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;        <span class="comment"># Write the structures as models.</span></div><div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;        atomIndices = {}</div><div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;        <span class="keywordflow">for</span> sn <span class="keywordflow">in</span> range(len(self)):</div><div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;            modelIndex = sn</div><div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;            <span class="keywordflow">if</span> len(self) &gt; 1:</div><div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;                out.append(<span class="stringliteral">&quot;MODEL     %4d&quot;</span> % modelIndex)</div><div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;            atomIndex = 1</div><div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;            <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):</div><div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;                recordName = records[i]</div><div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;                atomName = atomNames[i]</div><div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;                resName = resNames[i]</div><div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;                chainName = chainNames[i]</div><div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;                resId = resIds[i]</div><div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;                coords = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[sn][i]</div><div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;                symbol = self.elem[i]</div><div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;                <span class="keywordflow">if</span> hasattr(self, <span class="stringliteral">&#39;partial_charge&#39;</span>):</div><div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;                    bfactor = self.partial_charge[i]</div><div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;                    bfactor = 0.0</div><div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;                atomIndices[i] = atomIndex</div><div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;                line = <span class="stringliteral">&quot;%s%5d %-4s %3s %s%4s    %s%s%s %5.2f  0.00          %2s  &quot;</span> % (</div><div class="line"><a name="l04430"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#adea929913736e69b7af631dc0014a1e7"> 4430</a></span>&#160;                    recordName, atomIndex%100000, atomName, resName, chainName, resId, _format_83(coords[0]),</div><div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;                    _format_83(coords[1]), _format_83(coords[2]), bfactor, symbol)</div><div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;                <span class="keyword">assert</span> len(line) == 80, <span class="stringliteral">&#39;Fixed width overflow detected&#39;</span></div><div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;                out.append(line)</div><div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;                atomIndex += 1</div><div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;                <span class="keywordflow">if</span> i &lt; (self.na-1) <span class="keywordflow">and</span> chainName != chainNames[i+1]:</div><div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;                    out.append(<span class="stringliteral">&quot;TER   %5d      %3s %s%4s&quot;</span> % (atomIndex, resName, chainName, resId))</div><div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;                    atomIndex += 1</div><div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;            out.append(<span class="stringliteral">&quot;TER   %5d      %3s %s%4s&quot;</span> % (atomIndex, resName, chainName, resId))</div><div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;            <span class="keywordflow">if</span> len(self) &gt; 1:</div><div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;                out.append(<span class="stringliteral">&quot;ENDMDL&quot;</span>)</div><div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;        conectBonds = []</div><div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;            <span class="keywordflow">for</span> i, j <span class="keywordflow">in</span> self.bonds:</div><div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;                <span class="keywordflow">if</span> i &gt; j: <span class="keywordflow">continue</span></div><div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;                <span class="keywordflow">if</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[i] <span class="keywordflow">not</span> <span class="keywordflow">in</span> standardResidues <span class="keywordflow">or</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[j] <span class="keywordflow">not</span> <span class="keywordflow">in</span> standardResidues:</div><div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;                    conectBonds.append((i, j))</div><div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;                <span class="keywordflow">elif</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[i] == <span class="stringliteral">&#39;SG&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[j] == <span class="stringliteral">&#39;SG&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[i] == <span class="stringliteral">&#39;CYS&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[j] == <span class="stringliteral">&#39;CYS&#39;</span>:</div><div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;                    conectBonds.append((i, j))</div><div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;                <span class="keywordflow">elif</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[i] == <span class="stringliteral">&#39;SG&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">atomname</a>[j] == <span class="stringliteral">&#39;SG&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[i] == <span class="stringliteral">&#39;CYX&#39;</span> <span class="keywordflow">and</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a>[j] == <span class="stringliteral">&#39;CYX&#39;</span>:</div><div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;                    conectBonds.append((i, j))</div><div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;</div><div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;        atomBonds = {}</div><div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;        <span class="keywordflow">for</span> atom1, atom2 <span class="keywordflow">in</span> conectBonds:</div><div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;            index1 = atomIndices[atom1]</div><div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;            index2 = atomIndices[atom2]</div><div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;            <span class="keywordflow">if</span> index1 <span class="keywordflow">not</span> <span class="keywordflow">in</span> atomBonds:</div><div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;                atomBonds[index1] = []</div><div class="line"><a name="l04458"></a><span class="lineno"><a class="line" href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628"> 4458</a></span>&#160;            <span class="keywordflow">if</span> index2 <span class="keywordflow">not</span> <span class="keywordflow">in</span> atomBonds:</div><div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;                atomBonds[index2] = []</div><div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;            atomBonds[index1].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(index2)</div><div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;            atomBonds[index2].<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">append</a>(index1)</div><div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;</div><div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;        <span class="keywordflow">for</span> index1 <span class="keywordflow">in</span> sorted(atomBonds):</div><div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;            bonded = atomBonds[index1]</div><div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;            <span class="keywordflow">while</span> len(bonded) &gt; 4:</div><div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;                out.append(<span class="stringliteral">&quot;CONECT%5d%5d%5d%5d&quot;</span> % (index1, bonded[0], bonded[1], bonded[2]))</div><div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;                del bonded[:4]</div><div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;            line = <span class="stringliteral">&quot;CONECT%5d&quot;</span> % index1</div><div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;            <span class="keywordflow">for</span> index2 <span class="keywordflow">in</span> bonded:</div><div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;                line = <span class="stringliteral">&quot;%s%5d&quot;</span> % (line, index2)</div><div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;            out.append(line)</div><div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;</div><div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ac33547444f6fc81cae37ce37db9743ef">write_qdata</a>(self, selection, **kwargs):</div><div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;        <span class="stringliteral">&quot;&quot;&quot; Text quantum data format. &quot;&quot;&quot;</span></div><div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;        <span class="comment">#self.require(&#39;xyzs&#39;,&#39;qm_energies&#39;,&#39;qm_grads&#39;)</span></div><div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;        out = []</div><div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;        <span class="keywordflow">for</span> I <span class="keywordflow">in</span> selection:</div><div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;            xyz = self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">xyzs</a>[I]</div><div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;            out.append(<span class="stringliteral">&quot;JOB %i&quot;</span> % I)</div><div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;            out.append(<span class="stringliteral">&quot;COORDS&quot;</span>+<a class="code" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">pvec</a>(xyz))</div><div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_energies&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;                out.append(<span class="stringliteral">&quot;ENERGY % .12e&quot;</span> % self.qm_energies[I])</div><div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;mm_energies&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;                out.append(<span class="stringliteral">&quot;EMD0   % .12e&quot;</span> % self.mm_energies[I])</div><div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_grads&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;                out.append(<span class="stringliteral">&quot;GRADIENT&quot;</span>+<a class="code" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">pvec</a>(self.qm_grads[I]))</div><div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_espxyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">and</span> <span class="stringliteral">&#39;qm_espvals&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;                out.append(<span class="stringliteral">&quot;ESPXYZ&quot;</span>+<a class="code" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">pvec</a>(self.qm_espxyzs[I]))</div><div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;                out.append(<span class="stringliteral">&quot;ESPVAL&quot;</span>+<a class="code" href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">pvec</a>(self.qm_espvals[I]))</div><div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;            <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_interaction&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;                out.append(<span class="stringliteral">&quot;INTERACTION % .12e&quot;</span> % self.qm_interaction[I])</div><div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;            out.append(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;        <span class="keywordflow">return</span> out</div><div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;</div><div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#af74bcae2931e36e08ff33037b1b0fa37">require_resid</a>(self):</div><div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;resid&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;            na_res = int(<a class="code" href="namespacesrc_1_1molecule.html#a24a2611c587c2e6cf9597e87bdeba703">input</a>(<span class="stringliteral">&quot;Enter how many atoms are in a residue, or zero as a single residue -&gt; &quot;</span>))</div><div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;            <span class="keywordflow">if</span> na_res == 0:</div><div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a> = [1 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]</div><div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">resid</a> = [1 + int(i/na_res) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]</div><div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;</div><div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a68eee3cd2b86790c0cb2954c8310bd29">require_resname</a>(self):</div><div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;resname&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a>:</div><div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;            resname = <a class="code" href="namespacesrc_1_1molecule.html#a24a2611c587c2e6cf9597e87bdeba703">input</a>(<span class="stringliteral">&quot;Enter a residue name (3-letter like &#39;SOL&#39;) -&gt; &quot;</span>)</div><div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;            self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">resname</a> = [resname <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]</div><div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;</div><div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;    <span class="keyword">def </span><a class="code" href="classsrc_1_1molecule_1_1Molecule.html#ab72729cb3e6b2ed086669142c1409ed4">require_boxes</a>(self):</div><div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;        <span class="keyword">def </span>buildbox(line):</div><div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;            s = [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()]</div><div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;            <span class="keywordflow">if</span> len(s) == 1:</div><div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;                a = s[0]</div><div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;                b = s[0]</div><div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;                c = s[0]</div><div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;                alpha = 90.0</div><div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;                beta = 90.0</div><div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;                gamma = 90.0</div><div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)</div><div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;            <span class="keywordflow">elif</span> len(s) == 3:</div><div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;                a = s[0]</div><div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;                b = s[1]</div><div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;                c = s[2]</div><div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;                alpha = 90.0</div><div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;                beta = 90.0</div><div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;                gamma = 90.0</div><div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)</div><div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;            <span class="keywordflow">elif</span> len(s) == 6:</div><div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;                a = s[0]</div><div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;                b = s[1]</div><div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;                c = s[2]</div><div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;                alpha = s[3]</div><div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;                beta = s[4]</div><div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;                gamma = s[5]</div><div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)</div><div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;            <span class="keywordflow">elif</span> len(s) == 9:</div><div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;                v1 = np.array([s[0], s[3], s[4]])</div><div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;                v2 = np.array([s[5], s[1], s[6]])</div><div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;                v3 = np.array([s[7], s[8], s[2]])</div><div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="namespacesrc_1_1molecule.html#a49fbd57aae59219cb5fb85c22362b1f3">BuildLatticeFromVectors</a>(v1, v2, v3)</div><div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;                logger.error(<span class="stringliteral">&quot;Not sure what to do since you gave me %i numbers\n&quot;</span> % len(s))</div><div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;                <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;</div><div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;        <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">Data</a> <span class="keywordflow">or</span> len(self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a>) != self.ns:</div><div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;Please specify the periodic box using:\n&quot;</span>)</div><div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;1 float (cubic lattice length in Angstrom)\n&quot;</span>)</div><div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;3 floats (orthogonal lattice lengths in Angstrom)\n&quot;</span>)</div><div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;6 floats (triclinic lattice lengths and angles in degrees)\n&quot;</span>)</div><div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;9 floats (triclinic lattice vectors v1(x) v2(y) v3(z) v1(y) v1(z) v2(x) v2(z) v3(x) v3(y) in Angstrom)\n&quot;</span>)</div><div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;            sys.stderr.write(<span class="stringliteral">&quot;Or: Name of a file containing one of these lines for each frame in the trajectory\n&quot;</span>)</div><div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;            boxstr = <a class="code" href="namespacesrc_1_1molecule.html#a24a2611c587c2e6cf9597e87bdeba703">input</a>(<span class="stringliteral">&quot;Box Vector Input: -&gt; &quot;</span>)</div><div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;            <span class="keywordflow">if</span> os.path.exists(boxstr):</div><div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;                boxfile = open(boxstr).readlines()</div><div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;                <span class="keywordflow">if</span> len(boxfile) != len(self):</div><div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;                    logger.error(<span class="stringliteral">&#39;Tried to read in the box file, but it has a different length from the number of frames.\n&#39;</span>)</div><div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;                    <span class="keywordflow">raise</span> RuntimeError</div><div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;                <span class="keywordflow">else</span>:</div><div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;                    self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a> = [buildbox(line) <span class="keywordflow">for</span> line <span class="keywordflow">in</span> boxfile]</div><div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;                mybox = buildbox(boxstr)</div><div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;                self.<a class="code" href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">boxes</a> = [mybox <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]</div><div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;</div><div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;<span class="keyword">def </span><a class="code" href="namespacesrc_1_1molecule.html#a596a9d60dc2ba03cd91633d0689620d6">main</a>():</div><div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;    logger.info(<span class="stringliteral">&quot;Basic usage as an executable: molecule.py input.format1 output.format2&quot;</span>)</div><div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;    logger.info(<span class="stringliteral">&quot;where format stands for xyz, pdb, gro, etc.&quot;</span>)</div><div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;    Mao = <a class="code" href="classsrc_1_1molecule_1_1Molecule.html">Molecule</a>(sys.argv[1])</div><div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;    Mao.write(sys.argv[2])</div><div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;</div><div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;<span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div><div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;    <a class="code" href="namespacesrc_1_1molecule.html#a596a9d60dc2ba03cd91633d0689620d6">main</a>()</div><div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a087212040303a4f62a3462106428cc38"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a087212040303a4f62a3462106428cc38">src.molecule.Molecule.__add__</a></div><div class="ttdeci">def __add__(self, other)</div><div class="ttdoc">Add method for Molecule objects. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01496">molecule.py:1496</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_abfef1f072cfa93bc31e36985a976b65f"><div class="ttname"><a href="namespacesrc_1_1molecule.html#abfef1f072cfa93bc31e36985a976b65f">src.molecule.Box</a></div><div class="ttdeci">Box</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00413">molecule.py:413</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a596a9d60dc2ba03cd91633d0689620d6"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a596a9d60dc2ba03cd91633d0689620d6">src.molecule.main</a></div><div class="ttdeci">def main()</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04663">molecule.py:4663</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_abb42e2d8a17fac1eb2a8912e1ea3a9a7"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#abb42e2d8a17fac1eb2a8912e1ea3a9a7">src.molecule.Molecule.find_rings</a></div><div class="ttdeci">def find_rings(self, max_size=6)</div><div class="ttdoc">Return a list of rings in the molecule. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02621">molecule.py:2621</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a972ec8931555662db70e0f6acaa009ca"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a972ec8931555662db70e0f6acaa009ca">src.molecule.Molecule.radius_of_gyration</a></div><div class="ttdeci">def radius_of_gyration(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01727">molecule.py:1727</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ab2a58903fe3c7522158165619b92fab2"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ab2a58903fe3c7522158165619b92fab2">src.molecule.Molecule.aliphatic_hydrogens</a></div><div class="ttdeci">def aliphatic_hydrogens(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02791">molecule.py:2791</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1MolfileTimestep_html"><div class="ttname"><a href="classsrc_1_1molecule_1_1MolfileTimestep.html">src.molecule.MolfileTimestep</a></div><div class="ttdoc">Wrapper for the timestep C structure used in molfile plugins. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00680">molecule.py:680</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ab72729cb3e6b2ed086669142c1409ed4"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ab72729cb3e6b2ed086669142c1409ed4">src.molecule.Molecule.require_boxes</a></div><div class="ttdeci">def require_boxes(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04608">molecule.py:4608</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a05079753fc6897507fa02eb4ef57fc77"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a05079753fc6897507fa02eb4ef57fc77">src.molecule.Molecule.__iter__</a></div><div class="ttdeci">def __iter__(self)</div><div class="ttdoc">List-like behavior for looping over trajectories. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01485">molecule.py:1485</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_aa91151bec25f2f39ce30c2a71bb7478f"><div class="ttname"><a href="namespacesrc_1_1molecule.html#aa91151bec25f2f39ce30c2a71bb7478f">src.molecule.format_xyzgen_coord</a></div><div class="ttdeci">def format_xyzgen_coord(element, xyzgen)</div><div class="ttdoc">Print a line consisting of (element, p, q, r, s, t, ...) where (p, q, r) are arbitrary atom-wise data...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00589">molecule.py:589</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_aeeda6442bbd025dc5d98d8bcf14600b5"><div class="ttname"><a href="namespacesrc_1_1molecule.html#aeeda6442bbd025dc5d98d8bcf14600b5">src.molecule.get_rotate_translate</a></div><div class="ttdeci">def get_rotate_translate(matrix1, matrix2)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00788">molecule.py:788</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a1d771e111c1cc4c8a0783b58081e282d"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a1d771e111c1cc4c8a0783b58081e282d">src.molecule.Molecule.read_mol2</a></div><div class="ttdeci">def read_mol2(self, fnm, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03161">molecule.py:3161</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a4638e3bec89d2fa20ba340988456a1ac"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a4638e3bec89d2fa20ba340988456a1ac">src.molecule.elem_from_atomname</a></div><div class="ttdeci">def elem_from_atomname(atomname)</div><div class="ttdoc">Given an atom name, attempt to get the element in most cases. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00298">molecule.py:298</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a23a3a5c340084abc00fb577d2b3c85c2"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a23a3a5c340084abc00fb577d2b3c85c2">src.molecule.Molecule.__len__</a></div><div class="ttdeci">def __len__(self)</div><div class="ttdoc">Return the number of frames in the trajectory. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01331">molecule.py:1331</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1RawStreamHandler_html_a5f47165f46eee9c11ddea1826faaa55c"><div class="ttname"><a href="classsrc_1_1molecule_1_1RawStreamHandler.html#a5f47165f46eee9c11ddea1826faaa55c">src.molecule.RawStreamHandler.__init__</a></div><div class="ttdeci">def __init__(self, stream=sys.stdout)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00203">molecule.py:203</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a926fcd7399f5becbd07f69cff154dca7"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a926fcd7399f5becbd07f69cff154dca7">src.molecule.extract_int</a></div><div class="ttdeci">def extract_int(arr, avgthre, limthre, label=&quot;value&quot;, verbose=True)</div><div class="ttdoc">Get the representative integer value from an array. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00860">molecule.py:860</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1RawStreamHandler_html"><div class="ttname"><a href="classsrc_1_1molecule_1_1RawStreamHandler.html">src.molecule.RawStreamHandler</a></div><div class="ttdoc">Exactly like output.StreamHandler except it does no extra formatting before sending logging messages ...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00202">molecule.py:202</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1RawStreamHandler_html_a7994595f5f16fe262528c67505ad4a0e"><div class="ttname"><a href="classsrc_1_1molecule_1_1RawStreamHandler.html#a7994595f5f16fe262528c67505ad4a0e">src.molecule.RawStreamHandler.emit</a></div><div class="ttdeci">def emit(self, record)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00206">molecule.py:206</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a037d06bd9038517f2784bce4e0ad6d86"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a037d06bd9038517f2784bce4e0ad6d86">src.molecule.BuildLatticeFromLengthsAngles</a></div><div class="ttdeci">def BuildLatticeFromLengthsAngles(a, b, c, alpha, beta, gamma)</div><div class="ttdoc">This function takes in three lattice lengths and three lattice angles, and tries to return a complete...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00437">molecule.py:437</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a004a64d4b979002026c23d15a79e8dfc"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a004a64d4b979002026c23d15a79e8dfc">src.molecule.Molecule.split</a></div><div class="ttdeci">def split(self, fnm=None, ftype=None, method=&quot;chunks&quot;, num=None)</div><div class="ttdoc">Split the molecule object into a number of separate files (chunks), either by specifying the number o...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02903">molecule.py:2903</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a3a4d580584a25a74ec835bf6b09ded81"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a3a4d580584a25a74ec835bf6b09ded81">src.molecule.Molecule.center</a></div><div class="ttdeci">def center(self, center_mass=False)</div><div class="ttdoc">Move geometric center to the origin. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02023">molecule.py:2023</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ad47b76d0fe660f2cfafceb67f358a5c2"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ad47b76d0fe660f2cfafceb67f358a5c2">src.molecule.Molecule.edit_qcrems</a></div><div class="ttdeci">def edit_qcrems(self, in_dict, subcalc=None)</div><div class="ttdoc">Edit Q-Chem rem variables with a dictionary. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01798">molecule.py:1798</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a3710f2055a57158a9b5fbab2c5943683"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a3710f2055a57158a9b5fbab2c5943683">src.molecule.Molecule.read_charmm</a></div><div class="ttdeci">def read_charmm(self, fnm, kwargs)</div><div class="ttdoc">Read a CHARMM .cor (or .crd) file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03455">molecule.py:3455</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a0c2c1e8f6951f338e8ce2220a5d12045"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a0c2c1e8f6951f338e8ce2220a5d12045">src.molecule.Molecule.Write_Tab</a></div><div class="ttdeci">Write_Tab</div><div class="ttdoc">The table of file writers. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01251">molecule.py:1251</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af1fbd83fc5bba35b5df496413410f84d"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af1fbd83fc5bba35b5df496413410f84d">src.molecule.Molecule.pathwise_rmsd</a></div><div class="ttdeci">def pathwise_rmsd(self, align=True)</div><div class="ttdoc">Find RMSD between frames along path. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02821">molecule.py:2821</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a5faf08001b21d2b7dae569cb9aecba15"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a5faf08001b21d2b7dae569cb9aecba15">src.molecule.pvec</a></div><div class="ttdeci">def pvec(vec)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00656">molecule.py:656</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a243cce870c970db8cac7f102325e872b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a243cce870c970db8cac7f102325e872b">src.molecule.Molecule.read_qcout</a></div><div class="ttdeci">def read_qcout(self, fnm, errok=None, kwargs)</div><div class="ttdoc">Q-Chem output file reader, adapted for our parser. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03778">molecule.py:3778</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a4c1539dbe8854e261e7dbdb4a6fa0a98"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a4c1539dbe8854e261e7dbdb4a6fa0a98">src.molecule.Molecule.measure_dihedrals</a></div><div class="ttdeci">def measure_dihedrals(self, i, j, k, l)</div><div class="ttdoc">Return a series of dihedral angles, given four atom indices numbered from zero. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02575">molecule.py:2575</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a30e057898525695364528d3b02c5762b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a30e057898525695364528d3b02c5762b">src.molecule.Molecule.__getitem__</a></div><div class="ttdeci">def __getitem__(self, key)</div><div class="ttdoc">The Molecule class has list-like behavior, so we can get slices of it. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01453">molecule.py:1453</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac07431c9d938d6f0e24e71beef9119c5"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac07431c9d938d6f0e24e71beef9119c5">src.molecule.Molecule.find_dihedrals</a></div><div class="ttdeci">def find_dihedrals(self)</div><div class="ttdoc">Return a list of 4-tuples corresponding to all of the dihedral angles in the system. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02529">molecule.py:2529</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a32c3d0fa2efc4d240274218803e1f42b"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a32c3d0fa2efc4d240274218803e1f42b">src.molecule.ComputeOverlap</a></div><div class="ttdeci">def ComputeOverlap(theta, elem, xyz1, xyz2)</div><div class="ttdoc">Computes an &amp;#39;overlap&amp;#39; between two molecules based on some fictitious density. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00736">molecule.py:736</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af2cf7dad143a2cca4cfa651c82185c3d"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af2cf7dad143a2cca4cfa651c82185c3d">src.molecule.Molecule.load_popxyz</a></div><div class="ttdeci">def load_popxyz(self, fnm)</div><div class="ttdoc">Given a charge-spin xyz file, load the charges (x-coordinate) and spins (y-coordinate) into internal ...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01977">molecule.py:1977</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_af5506b829909137d2b0b586eb1349c85"><div class="ttname"><a href="namespacesrc_1_1molecule.html#af5506b829909137d2b0b586eb1349c85">src.molecule.AlignToDensity</a></div><div class="ttdeci">def AlignToDensity(elem, xyz1, xyz2, binary=False)</div><div class="ttdoc">Computes a &quot;overlap density&quot; from two frames. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00753">molecule.py:753</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ae084bae0a4a0204c4d92fff5cbdbeee5"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ae084bae0a4a0204c4d92fff5cbdbeee5">src.molecule.Molecule.built_bonds</a></div><div class="ttdeci">built_bonds</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01281">molecule.py:1281</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_abdc7b61bb516d9f57aff156ec09b19bf"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#abdc7b61bb516d9f57aff156ec09b19bf">src.molecule.Molecule.qm_mulliken_spins</a></div><div class="ttdeci">qm_mulliken_spins</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01980">molecule.py:1980</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a373f82faf5d8f3ce84095ed74ab77425"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a373f82faf5d8f3ce84095ed74ab77425">src.molecule.format_gro_box</a></div><div class="ttdeci">def format_gro_box(box)</div><div class="ttdoc">Print a line corresponding to the box vector in accordance with .gro file format. ...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00598">molecule.py:598</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a6b6551ae13458225d8fc8d117112e23f"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a6b6551ae13458225d8fc8d117112e23f">src.molecule.Molecule.rigid_water</a></div><div class="ttdeci">def rigid_water(self)</div><div class="ttdoc">If one atom is oxygen and the next two are hydrogen, make the water molecule rigid. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01739">molecule.py:1739</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a10b21e9ed15d4d1d3242a2696a939e61"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a10b21e9ed15d4d1d3242a2696a939e61">src.molecule.Molecule.replace_peratom</a></div><div class="ttdeci">def replace_peratom(self, key, orig, want)</div><div class="ttdoc">Replace all of the data for a certain attribute in the system from orig to want. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01845">molecule.py:1845</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a9701dad854112650bd6b7601cab8b40b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a9701dad854112650bd6b7601cab8b40b">src.molecule.Molecule.xyzs</a></div><div class="ttdeci">xyzs</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04338">molecule.py:4338</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a49fbd57aae59219cb5fb85c22362b1f3"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a49fbd57aae59219cb5fb85c22362b1f3">src.molecule.BuildLatticeFromVectors</a></div><div class="ttdeci">def BuildLatticeFromVectors(v1, v2, v3)</div><div class="ttdoc">This function takes in three lattice vectors and tries to return a complete box specification. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00452">molecule.py:452</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a011f4f4e9170d8f3c86adf61453142ce"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a011f4f4e9170d8f3c86adf61453142ce">src.molecule.Molecule.rotate_check_clash</a></div><div class="ttdeci">def rotate_check_clash(self, frame, rotate_index, thresh_hyd=1.4, thresh_hvy=1.8, printLevel=1)</div><div class="ttdoc">Return a new Molecule object containing the selected frame plus a number of frames where the selected...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02445">molecule.py:2445</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a36b472b4d2504123fab8083068f8315a"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a36b472b4d2504123fab8083068f8315a">src.molecule.Molecule.get_reaxff_atom_types</a></div><div class="ttdeci">def get_reaxff_atom_types(self)</div><div class="ttdoc">Return a list of element names which maps the LAMMPS atom types to the ReaxFF elements. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04229">molecule.py:4229</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ad9a055066973a760e4898581224736b0"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ad9a055066973a760e4898581224736b0">src.molecule.Molecule.measure_angles</a></div><div class="ttdeci">def measure_angles(self, i, j, k)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02560">molecule.py:2560</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html">src.molecule.Molecule</a></div><div class="ttdoc">Lee-Ping&amp;#39;s general file format conversion class. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01182">molecule.py:1182</a></div></div>
<div class="ttc" id="classsrc_1_1Mol2_1_1mol2__set_html"><div class="ttname"><a href="classsrc_1_1Mol2_1_1mol2__set.html">src.Mol2.mol2_set</a></div><div class="ttdef"><b>Definition:</b> <a href="Mol2_8py_source.html#l00571">Mol2.py:571</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a36a4504f013d86188435e01231235386"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a36a4504f013d86188435e01231235386">src.molecule.Molecule.read_xyz</a></div><div class="ttdeci">def read_xyz(self, fnm, kwargs)</div><div class="ttdoc">.xyz files can be TINKER formatted which is why we have the try/except here. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02952">molecule.py:2952</a></div></div>
<div class="ttc" id="namespaceForceBalance_html_ade5c4134470535272ce69775da10bcc3"><div class="ttname"><a href="namespaceForceBalance.html#ade5c4134470535272ce69775da10bcc3">ForceBalance.all</a></div><div class="ttdeci">all</div><div class="ttdef"><b>Definition:</b> <a href="ForceBalance_8py_source.html#l00018">ForceBalance.py:18</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a201a811c87574b4e229880540e4e6ef9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a201a811c87574b4e229880540e4e6ef9">src.molecule.Molecule.find_clashes</a></div><div class="ttdeci">def find_clashes(self, thre=0.0, pbc=True, groups=None)</div><div class="ttdoc">Obtain a list of atoms that &amp;#39;clash&amp;#39; (i.e. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02379">molecule.py:2379</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a25e54248bd35147e2c2aa210d06a58a5"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a25e54248bd35147e2c2aa210d06a58a5">src.molecule.Molecule.read_inpcrd</a></div><div class="ttdeci">def read_inpcrd(self, fnm, kwargs)</div><div class="ttdoc">Parse an AMBER .inpcrd or .rst file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03064">molecule.py:3064</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af74bcae2931e36e08ff33037b1b0fa37"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af74bcae2931e36e08ff33037b1b0fa37">src.molecule.Molecule.require_resid</a></div><div class="ttdeci">def require_resid(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04595">molecule.py:4595</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a0b808b0181dfa0aed5879c61f683ec1a"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a0b808b0181dfa0aed5879c61f683ec1a">src.molecule.EulerMatrix</a></div><div class="ttdeci">def EulerMatrix(T1, T2, T3)</div><div class="ttdoc">Constructs an Euler matrix from three Euler angles. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00708">molecule.py:708</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a8d9cdc5fd67e79c8b1edac8159d2e370"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a8d9cdc5fd67e79c8b1edac8159d2e370">src.molecule.cartesian_product2</a></div><div class="ttdeci">def cartesian_product2(arrays)</div><div class="ttdoc">Form a Cartesian product of two NumPy arrays. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00824">molecule.py:824</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a73f8860755f337e3fafb91d074a7d459"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a73f8860755f337e3fafb91d074a7d459">src.molecule.Molecule.__setattr__</a></div><div class="ttdeci">def __setattr__(self, key, value)</div><div class="ttdoc">Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionar...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01386">molecule.py:1386</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af7b405613971e5d76720b1a655e05981"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af7b405613971e5d76720b1a655e05981">src.molecule.Molecule.atom_select</a></div><div class="ttdeci">def atom_select(self, atomslice, build_topology=True)</div><div class="ttdoc">Return a copy of the object with certain atoms selected. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01868">molecule.py:1868</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ab59ba8cf9a0b9e525428723c813d15c8"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ab59ba8cf9a0b9e525428723c813d15c8">src.molecule.Molecule.qm_mulliken_charges</a></div><div class="ttdeci">qm_mulliken_charges</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01979">molecule.py:1979</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a651f6c6d23932f5a2151784c992e94a8"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a651f6c6d23932f5a2151784c992e94a8">src.molecule.isint</a></div><div class="ttdeci">def isint(word)</div><div class="ttdoc">ONLY matches integers! If you have a decimal point? None shall pass! </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00401">molecule.py:401</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a0270df3966f56e55abb73ab7de5a3e77"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a0270df3966f56e55abb73ab7de5a3e77">src.molecule.Molecule.Data</a></div><div class="ttdeci">Data</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01293">molecule.py:1293</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac40e3fd2c1f79e316be59016e7dfd253"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac40e3fd2c1f79e316be59016e7dfd253">src.molecule.Molecule.__deepcopy__</a></div><div class="ttdeci">def __deepcopy__(self, memo)</div><div class="ttdoc">Custom deepcopy method because Python 3.6 appears to have changed its behavior. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01398">molecule.py:1398</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a8f70cfe4842e1f08578785ef9a95babc"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a8f70cfe4842e1f08578785ef9a95babc">src.molecule.AtomContact</a></div><div class="ttdeci">def AtomContact(xyz, pairs, box=None, displace=False)</div><div class="ttdoc">Compute distances between pairs of atoms. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01045">molecule.py:1045</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af42c16177cc7cbfce3c0b2be7b132480"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af42c16177cc7cbfce3c0b2be7b132480">src.molecule.Molecule.write_xyz</a></div><div class="ttdeci">def write_xyz(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04213">molecule.py:4213</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aa66fa5839f821805bdd08ed17a206987"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aa66fa5839f821805bdd08ed17a206987">src.molecule.Molecule.topology</a></div><div class="ttdeci">topology</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02233">molecule.py:2233</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a91b5115334f638c29d7a1cc46aedca5d"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a91b5115334f638c29d7a1cc46aedca5d">src.molecule.Molecule.molecules</a></div><div class="ttdeci">molecules</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02235">molecule.py:2235</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_afbb728fb44c4465e4f53b26a64439165"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#afbb728fb44c4465e4f53b26a64439165">src.molecule.Molecule.__getattr__</a></div><div class="ttdeci">def __getattr__(self, key)</div><div class="ttdoc">Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionar...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01347">molecule.py:1347</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a96266112f8af20de9810e2fee0d5861c"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a96266112f8af20de9810e2fee0d5861c">src.molecule.Molecule.fout</a></div><div class="ttdeci">fout</div><div class="ttdoc">I needed to add in this line because the DCD writer requires the file name, but the other methods don...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01692">molecule.py:1692</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a742c96f62c86d00ac97bb5004f8ebd92"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a742c96f62c86d00ac97bb5004f8ebd92">src.molecule.Molecule.read_com</a></div><div class="ttdeci">def read_com(self, fnm, kwargs)</div><div class="ttdoc">Parse a Gaussian .com file and return a SINGLE-ELEMENT list of xyz coordinates (no multiple file supp...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03255">molecule.py:3255</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a6b9b3403d57a07cf94d7a47a73e67da8"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a6b9b3403d57a07cf94d7a47a73e67da8">src.molecule.MolEqual</a></div><div class="ttdeci">def MolEqual(mol1, mol2)</div><div class="ttdoc">Determine whether two Molecule objects have the same fragments by looking at elements and connectivit...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00534">molecule.py:534</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af52f2ee9f9376925eab6e3309536e011"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af52f2ee9f9376925eab6e3309536e011">src.molecule.Molecule.read_pdb</a></div><div class="ttdeci">def read_pdb(self, fnm, kwargs)</div><div class="ttdoc">Loads a PDB and returns a dictionary containing its data. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03649">molecule.py:3649</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a784faffc34b87c6f72db0f4915e1a355"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a784faffc34b87c6f72db0f4915e1a355">src.molecule.unmangle</a></div><div class="ttdeci">def unmangle(M1, M2)</div><div class="ttdoc">Create a mapping that takes M1&amp;#39;s atom indices to M2&amp;#39;s atom indices based on position. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00380">molecule.py:380</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a7aeff86c1d2b8f73bea9191b33f665c3"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a7aeff86c1d2b8f73bea9191b33f665c3">src.molecule.Molecule.read_comm_charge_mult</a></div><div class="ttdeci">def read_comm_charge_mult(self, verbose=False)</div><div class="ttdoc">Set charge and multiplicity from reading the comment line, formatted in a specific way...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02925">molecule.py:2925</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a029c994fba2c8388259bd062def28fde"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a029c994fba2c8388259bd062def28fde">src.molecule.Molecule.ref_rmsd</a></div><div class="ttdeci">def ref_rmsd(self, i, align=True)</div><div class="ttdoc">Find RMSD to a reference frame. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02839">molecule.py:2839</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1ActuallyArcError_html"><div class="ttname"><a href="classsrc_1_1molecule_1_1ActuallyArcError.html">src.molecule.ActuallyArcError</a></div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00036">molecule.py:36</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a5928a44288a03b8c3ff61204feaa054b"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a5928a44288a03b8c3ff61204feaa054b">src.molecule.nodematch</a></div><div class="ttdeci">def nodematch(node1, node2)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00395">molecule.py:395</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a0f007f8498ecc025f1e066d47fabfd24"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a0f007f8498ecc025f1e066d47fabfd24">src.molecule.is_gro_box</a></div><div class="ttdeci">def is_gro_box(line)</div><div class="ttdoc">Determines whether a line contains a GROMACS box vector or not. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00638">molecule.py:638</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a4afda180689c9bfde319a025f96d4c0b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a4afda180689c9bfde319a025f96d4c0b">src.molecule.Molecule.openmm_boxes</a></div><div class="ttdeci">def openmm_boxes(self)</div><div class="ttdoc">Returns the periodic box vectors in the Molecule object in a list of OpenMM-compatible boxes...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02880">molecule.py:2880</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac2da956804fed7a98341c94582838f26"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac2da956804fed7a98341c94582838f26">src.molecule.Molecule.all_pairwise_rmsd</a></div><div class="ttdeci">def all_pairwise_rmsd(self)</div><div class="ttdoc">Find pairwise RMSD (super slow, not like the one in MSMBuilder.) </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02803">molecule.py:2803</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a24a2611c587c2e6cf9597e87bdeba703"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a24a2611c587c2e6cf9597e87bdeba703">src.molecule.input</a></div><div class="ttdeci">input</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00031">molecule.py:31</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a346c5b384082c9779f83ea7853a460c8"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a346c5b384082c9779f83ea7853a460c8">src.molecule.Molecule.resname</a></div><div class="ttdeci">resname</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04606">molecule.py:4606</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a53a3e04b9a57f9217a193d92c2062890"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a53a3e04b9a57f9217a193d92c2062890">src.molecule.either</a></div><div class="ttdeci">def either(A, B, key)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00699">molecule.py:699</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a4ce0cfbb42e84ec2fe5d8097d0ff5fda"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a4ce0cfbb42e84ec2fe5d8097d0ff5fda">src.molecule.Molecule.read_gro</a></div><div class="ttdeci">def read_gro(self, fnm, kwargs)</div><div class="ttdoc">Read a GROMACS .gro file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03373">molecule.py:3373</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a68eee3cd2b86790c0cb2954c8310bd29"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a68eee3cd2b86790c0cb2954c8310bd29">src.molecule.Molecule.require_resname</a></div><div class="ttdeci">def require_resname(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04603">molecule.py:4603</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a406a751e54f7e50da529c5d45f7f7de8"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a406a751e54f7e50da529c5d45f7f7de8">src.molecule.both</a></div><div class="ttdeci">def both(A, B, key)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00685">molecule.py:685</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_afd7595ccf68f4fc41c728a5071d0a0b9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#afd7595ccf68f4fc41c728a5071d0a0b9">src.molecule.Molecule.top_settings</a></div><div class="ttdeci">top_settings</div><div class="ttdoc">Topology settings. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01283">molecule.py:1283</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_abd4e9ae70858f3f3d522ae6149236697"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#abd4e9ae70858f3f3d522ae6149236697">src.molecule.Molecule.center_of_mass</a></div><div class="ttdeci">def center_of_mass(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01723">molecule.py:1723</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a909fc56c7a55c16eca1c668819cf6a1a"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a909fc56c7a55c16eca1c668819cf6a1a">src.molecule.format_xyz_coord</a></div><div class="ttdeci">def format_xyz_coord(element, xyz, tinker=False)</div><div class="ttdoc">Print a line consisting of (element, x, y, z) in accordance with .xyz file format. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00546">molecule.py:546</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac89b40e6c15282d3c685e80672a01cbf"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac89b40e6c15282d3c685e80672a01cbf">src.molecule.Molecule.find_angles</a></div><div class="ttdeci">def find_angles(self)</div><div class="ttdoc">Return a list of 3-tuples corresponding to all of the angles in the system. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02502">molecule.py:2502</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a16ef842ad2eb3048d82d2303639e56e0"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a16ef842ad2eb3048d82d2303639e56e0">src.molecule.Molecule.positive_resid</a></div><div class="ttdeci">positive_resid</div><div class="ttdoc">Creates entries like &amp;#39;gromacs&amp;#39; : &amp;#39;gromacs&amp;#39; and &amp;#39;xyz&amp;#39; : &amp;#39;xyz&amp;#39; in the Funnel. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01280">molecule.py:1280</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_af3d73b03a8dc403bb7372b8f83f88245"><div class="ttname"><a href="namespacesrc_1_1molecule.html#af3d73b03a8dc403bb7372b8f83f88245">src.molecule.TopEqual</a></div><div class="ttdeci">def TopEqual(mol1, mol2)</div><div class="ttdoc">For the nanoreactor project: Determine whether two Molecule objects have the same topologies...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00521">molecule.py:521</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ad74d00f84b4b0b66b18de8a3f6b41c88"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ad74d00f84b4b0b66b18de8a3f6b41c88">src.molecule.Molecule.align</a></div><div class="ttdeci">def align(self, smooth=False, center=True, center_mass=False, atom_select=None)</div><div class="ttdoc">Align molecules. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01994">molecule.py:1994</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aa6fbbf278cf844c7bbdac896c71f5c64"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aa6fbbf278cf844c7bbdac896c71f5c64">src.molecule.Molecule.mult</a></div><div class="ttdeci">mult</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02928">molecule.py:2928</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_afae2c34b572e137801c8077f4267b247"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#afae2c34b572e137801c8077f4267b247">src.molecule.Molecule.build_topology</a></div><div class="ttdeci">def build_topology(self, force_bonds=True, kwargs)</div><div class="ttdoc">Create self.topology and self.molecules; these are graph representations of the individual molecules ...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02208">molecule.py:2208</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a958636d732433ffc356a1f7a1e70d7d7"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a958636d732433ffc356a1f7a1e70d7d7">src.molecule.Molecule.replace_peratom_conditional</a></div><div class="ttdeci">def replace_peratom_conditional(self, key1, cond, key2, orig, want)</div><div class="ttdoc">Replace all of the data for a attribute key2 from orig to want, contingent on key1 being equal to con...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01857">molecule.py:1857</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a4a1e6648a99afd550e7b24db3a2b249b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a4a1e6648a99afd550e7b24db3a2b249b">src.molecule.Molecule.__iadd__</a></div><div class="ttdeci">def __iadd__(self, other)</div><div class="ttdoc">Add method for Molecule objects. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01543">molecule.py:1543</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a29b2035c5e476fb22707d6c17eaf5e3e"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a29b2035c5e476fb22707d6c17eaf5e3e">src.molecule.Molecule.distance_displacement</a></div><div class="ttdeci">def distance_displacement(self)</div><div class="ttdoc">Obtain distance matrix and displacement vectors between all pairs of atoms. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02254">molecule.py:2254</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a9f764980b8a0df810aa7264036617975"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a9f764980b8a0df810aa7264036617975">src.molecule.Molecule.reorder_indices</a></div><div class="ttdeci">def reorder_indices(self, other)</div><div class="ttdoc">Return the indices that would reorder atoms according to some other Molecule object. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01648">molecule.py:1648</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac9ca356c6a6ea6d5b470d819ab473f84"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac9ca356c6a6ea6d5b470d819ab473f84">src.molecule.Molecule.distance_matrix</a></div><div class="ttdeci">def distance_matrix(self, pbc=True)</div><div class="ttdoc">Obtain distance matrix between all pairs of atoms. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02242">molecule.py:2242</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a1969b621b7e6e65722ec245b74518cfe"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a1969b621b7e6e65722ec245b74518cfe">src.molecule.Molecule.append</a></div><div class="ttdeci">def append(self, other)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01652">molecule.py:1652</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a940e04377db02e5114741a4bf8a6f084"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a940e04377db02e5114741a4bf8a6f084">src.molecule.CubicLattice</a></div><div class="ttdeci">def CubicLattice(a)</div><div class="ttdoc">This function takes in three lattice lengths and three lattice angles, and tries to return a complete...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00417">molecule.py:417</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a56e223f4d0b5bf391e7d038b36d335d8"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a56e223f4d0b5bf391e7d038b36d335d8">src.molecule.Molecule.Funnel</a></div><div class="ttdeci">Funnel</div><div class="ttdoc">A funnel dictionary that takes redundant file types and maps them down to a few. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01264">molecule.py:1264</a></div></div>
<div class="ttc" id="namespacesrc_1_1nifty_html_a377e501a4a558c58bb2a70bae058e3e6"><div class="ttname"><a href="namespacesrc_1_1nifty.html#a377e501a4a558c58bb2a70bae058e3e6">src.nifty.encode</a></div><div class="ttdeci">def encode(l)</div><div class="ttdef"><b>Definition:</b> <a href="nifty_8py_source.html#l00230">nifty.py:230</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a097327ba25a338d642f7ab11dadb55cc"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a097327ba25a338d642f7ab11dadb55cc">src.molecule.even_list</a></div><div class="ttdeci">def even_list(totlen, splitsize)</div><div class="ttdoc">Creates a list of number sequences divided as evenly as possible. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00667">molecule.py:667</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a5aac5225e3c6c540659410f7a783cd99"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a5aac5225e3c6c540659410f7a783cd99">src.molecule.Molecule.order_by_connectivity</a></div><div class="ttdeci">def order_by_connectivity(self, m, i, currList, max_min_path)</div><div class="ttdoc">Recursive function that orders atoms based on connectivity. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02758">molecule.py:2758</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_afd4c36987dbdc45da729fe1668485628"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#afd4c36987dbdc45da729fe1668485628">src.molecule.Molecule.atomname</a></div><div class="ttdeci">atomname</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04458">molecule.py:4458</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a36609ce51ce26648178b39f22343f085"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a36609ce51ce26648178b39f22343f085">src.molecule.Molecule.comms</a></div><div class="ttdeci">comms</div><div class="ttdoc">Read in stuff if we passed in a file name, otherwise return an empty instance. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01311">molecule.py:1311</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ae8aa53ace87ec66daf8264b2add069c3"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ae8aa53ace87ec66daf8264b2add069c3">src.molecule.Molecule.rotate_bond</a></div><div class="ttdeci">def rotate_bond(self, frame, aj, ak, increment=15)</div><div class="ttdoc">Return a new Molecule object containing the selected frame plus a number of frames where the selected...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02286">molecule.py:2286</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a55418dce14e7b54da5ccfa96b0c564d4"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a55418dce14e7b54da5ccfa96b0c564d4">src.molecule.Molecule.build_bonds</a></div><div class="ttdeci">def build_bonds(self)</div><div class="ttdoc">Build the bond connectivity graph. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02034">molecule.py:2034</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a76b7defcd5b5e5db182fdf2f9f82f4ce"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a76b7defcd5b5e5db182fdf2f9f82f4ce">src.molecule.extract_pop</a></div><div class="ttdeci">def extract_pop(M, verbose=True)</div><div class="ttdoc">Extract our best estimate of charge and spin-z from the comments section of a Molecule object created...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00906">molecule.py:906</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a21d78053aab2fda1fd5e2577a02ec696"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a21d78053aab2fda1fd5e2577a02ec696">src.molecule.Molecule.write_qcin</a></div><div class="ttdeci">def write_qcin(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04147">molecule.py:4147</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a809f63082b7a39e0f787fc455dd18516"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a809f63082b7a39e0f787fc455dd18516">src.molecule.Molecule.Read_Tab</a></div><div class="ttdeci">Read_Tab</div><div class="ttdoc">The table of file readers. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01235">molecule.py:1235</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a258bc7b495910f9ff3bb552413207ecd"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a258bc7b495910f9ff3bb552413207ecd">src.molecule.Molecule.read_dcd</a></div><div class="ttdeci">def read_dcd(self, fnm, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03215">molecule.py:3215</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a31014aa4ca1b8259557bedd6d13a51aa"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a31014aa4ca1b8259557bedd6d13a51aa">src.molecule.Molecule.__delitem__</a></div><div class="ttdeci">def __delitem__(self, key)</div><div class="ttdoc">Similarly, in order to delete a frame, we simply perform item deletion on framewise variables...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01476">molecule.py:1476</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_af975f93f5c43f518b84d0bd067c75604"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#af975f93f5c43f518b84d0bd067c75604">src.molecule.Molecule.write_inpcrd</a></div><div class="ttdeci">def write_inpcrd(self, selection, sn=None, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04332">molecule.py:4332</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a5e74901959a8b939fc5a6c851e64d4ae"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a5e74901959a8b939fc5a6c851e64d4ae">src.molecule.Molecule.require</a></div><div class="ttdeci">def require(self, args)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01656">molecule.py:1656</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ab74230360451f0feefcfceae3b292223"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ab74230360451f0feefcfceae3b292223">src.molecule.Molecule.write_molproq</a></div><div class="ttdeci">def write_molproq(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04309">molecule.py:4309</a></div></div>
<div class="ttc" id="namespacesimtk_1_1unit_html"><div class="ttname"><a href="namespacesimtk_1_1unit.html">unit</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a722ba2597f067fc042169926c0b37274"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a722ba2597f067fc042169926c0b37274">src.molecule.Molecule.write_dcd</a></div><div class="ttdeci">def write_dcd(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04404">molecule.py:4404</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a73446a192061fe52b26899005e3bbc31"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a73446a192061fe52b26899005e3bbc31">src.molecule.Molecule.align_by_moments</a></div><div class="ttdeci">def align_by_moments(self)</div><div class="ttdoc">Align molecules using the moment of inertia. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01952">molecule.py:1952</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aa9caaf6d7ccff3a9077da98b4c8096a9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aa9caaf6d7ccff3a9077da98b4c8096a9">src.molecule.Molecule.read_qcin</a></div><div class="ttdeci">def read_qcin(self, fnm, kwargs)</div><div class="ttdoc">Read a Q-Chem input file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03524">molecule.py:3524</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a557af72409188133ef446ee8dbed2338"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a557af72409188133ef446ee8dbed2338">src.molecule.Molecule.write</a></div><div class="ttdeci">def write(self, fnm=None, ftype=None, append=False, selection=None, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01678">molecule.py:1678</a></div></div>
<div class="ttc" id="namespacesimtk_1_1openmm_html"><div class="ttname"><a href="namespacesimtk_1_1openmm.html">openmm</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a12369eb306cb29148e610e9ee08d7e2c"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a12369eb306cb29148e610e9ee08d7e2c">src.molecule.Molecule.read_qcesp</a></div><div class="ttdeci">def read_qcesp(self, fnm, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03746">molecule.py:3746</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_afa69c71616ba48c2641d3e2b5914b6d9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#afa69c71616ba48c2641d3e2b5914b6d9">src.molecule.Molecule.add_virtual_site</a></div><div class="ttdeci">def add_virtual_site(self, idx, kwargs)</div><div class="ttdoc">Add a virtual site to the system. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01826">molecule.py:1826</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a28c672c2de7b942b427a22f3b433b04e"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a28c672c2de7b942b427a22f3b433b04e">src.molecule.arc</a></div><div class="ttdeci">def arc(Mol, begin=None, end=None, RMSD=True, align=True)</div><div class="ttdoc">Get the arc-length for a trajectory segment. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00956">molecule.py:956</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_af77e6cac48816736aa9a5cfa2f74071b"><div class="ttname"><a href="namespacesrc_1_1molecule.html#af77e6cac48816736aa9a5cfa2f74071b">src.molecule.EqualSpacing</a></div><div class="ttdeci">def EqualSpacing(Mol, frames=0, dx=0, RMSD=True, align=True)</div><div class="ttdoc">Equalize the spacing of frames in a trajectory with linear interpolation. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00995">molecule.py:995</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a93e42cc0135d2a68354e384d6bc9185b"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a93e42cc0135d2a68354e384d6bc9185b">src.molecule.Molecule.load_frames</a></div><div class="ttdeci">def load_frames(self, fnm, ftype=None, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01769">molecule.py:1769</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a94a0b29f772bb5e6e03383fd854ad70a"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a94a0b29f772bb5e6e03383fd854ad70a">src.molecule.Molecule.write_mdcrd</a></div><div class="ttdeci">def write_mdcrd(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04321">molecule.py:4321</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a146f60bbab00e12c5754fd666233e86f"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a146f60bbab00e12c5754fd666233e86f">src.molecule.Molecule.charge</a></div><div class="ttdeci">charge</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02927">molecule.py:2927</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a157c193873713c7029b653c1ca51eb7a"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a157c193873713c7029b653c1ca51eb7a">src.molecule.add_strip_to_mat</a></div><div class="ttdeci">def add_strip_to_mat(mat, strip)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00647">molecule.py:647</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a2a818455c2439cd42f7489d3f811eb72"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a2a818455c2439cd42f7489d3f811eb72">src.molecule.Molecule.measure_distances</a></div><div class="ttdeci">def measure_distances(self, i, j)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02551">molecule.py:2551</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a692df3c446a2c9517ab4a3d2a9e7b373"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a692df3c446a2c9517ab4a3d2a9e7b373">src.molecule.Molecule.get_populations</a></div><div class="ttdeci">def get_populations(self)</div><div class="ttdoc">Return a cloned molecule object but with X-coordinates set to Mulliken charges and Y-coordinates set ...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01966">molecule.py:1966</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aeab236a12cffd66ce282c1a7d03af7f9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aeab236a12cffd66ce282c1a7d03af7f9">src.molecule.Molecule.without</a></div><div class="ttdeci">def without(self, args)</div><div class="ttdoc">Return a copy of the Molecule object but with certain fields deleted if they exist. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02915">molecule.py:2915</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_ac2056d27322c6ee6dff0bef3755f2ed3"><div class="ttname"><a href="namespacesrc_1_1molecule.html#ac2056d27322c6ee6dff0bef3755f2ed3">src.molecule.isfloat</a></div><div class="ttdeci">def isfloat(word)</div><div class="ttdoc">Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00406">molecule.py:406</a></div></div>
<div class="ttc" id="namespacesimtk_1_1openmm_1_1app_html"><div class="ttname"><a href="namespacesimtk_1_1openmm_1_1app.html">app</a></div></div>
<div class="ttc" id="namespacesrc_1_1optimizer_html_abd36f93a9b1e0d51b4d693687b9a8f33"><div class="ttname"><a href="namespacesrc_1_1optimizer.html#abd36f93a9b1e0d51b4d693687b9a8f33">src.optimizer.Counter</a></div><div class="ttdeci">def Counter()</div><div class="ttdef"><b>Definition:</b> <a href="optimizer_8py_source.html#l00035">optimizer.py:35</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a7e4057a5d9f4bb4a62cef21680f91327"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a7e4057a5d9f4bb4a62cef21680f91327">src.molecule.Molecule.read_arc</a></div><div class="ttdeci">def read_arc(self, fnm, kwargs)</div><div class="ttdoc">Read a TINKER .arc file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03300">molecule.py:3300</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a06bd27c59ccdbde31fbefbdec2daf1ad"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a06bd27c59ccdbde31fbefbdec2daf1ad">src.molecule.AlignToMoments</a></div><div class="ttdeci">def AlignToMoments(elem, xyz1, xyz2=None)</div><div class="ttdoc">Pre-aligns molecules to &amp;#39;moment of inertia&amp;#39;. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00765">molecule.py:765</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a6c78338a640dbf1fd95c38f980203643"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a6c78338a640dbf1fd95c38f980203643">src.molecule.Molecule.read_qdata</a></div><div class="ttdeci">def read_qdata(self, fnm, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03125">molecule.py:3125</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ac33547444f6fc81cae37ce37db9743ef"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ac33547444f6fc81cae37ce37db9743ef">src.molecule.Molecule.write_qdata</a></div><div class="ttdeci">def write_qdata(self, selection, kwargs)</div><div class="ttdoc">Text quantum data format. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04574">molecule.py:4574</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_adea929913736e69b7af631dc0014a1e7"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#adea929913736e69b7af631dc0014a1e7">src.molecule.Molecule.write_pdb</a></div><div class="ttdeci">def write_pdb(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04430">molecule.py:4430</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_ab863d592cf9369137d6298eb005556c9"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#ab863d592cf9369137d6298eb005556c9">src.molecule.Molecule.add_quantum</a></div><div class="ttdeci">def add_quantum(self, other)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01813">molecule.py:1813</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_accdd08d1cdef8a51da59e1fc2268c7d8"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#accdd08d1cdef8a51da59e1fc2268c7d8">src.molecule.Molecule.write_gro</a></div><div class="ttdeci">def write_gro(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04370">molecule.py:4370</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a466ab9dea14be9117488c6198b0f77cd"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a466ab9dea14be9117488c6198b0f77cd">src.molecule.Molecule.openmm_positions</a></div><div class="ttdeci">def openmm_positions(self)</div><div class="ttdoc">Returns the Cartesian coordinates in the Molecule object in a list of OpenMM-compatible positions...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02863">molecule.py:2863</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_ae26e509ce54bf76724a18ba91107df72"><div class="ttname"><a href="namespacesrc_1_1molecule.html#ae26e509ce54bf76724a18ba91107df72">src.molecule.getElement</a></div><div class="ttdeci">def getElement(mass)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00293">molecule.py:293</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a2cf7fe49895eedd6c60b7394f1435529"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a2cf7fe49895eedd6c60b7394f1435529">src.molecule.is_gro_coord</a></div><div class="ttdeci">def is_gro_coord(line)</div><div class="ttdoc">Determines whether a line contains GROMACS data or not. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00610">molecule.py:610</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a18b08895867e37ef3cb86a3d4456c775"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a18b08895867e37ef3cb86a3d4456c775">src.molecule.axis_angle</a></div><div class="ttdeci">def axis_angle(axis, angle)</div><div class="ttdoc">Given a rotation axis and angle, return the corresponding 3x3 rotation matrix, which will rotate a (N...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01133">molecule.py:1133</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a996cd83807d88f3fb81aef6278e10051"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a996cd83807d88f3fb81aef6278e10051">src.molecule.Molecule.boxes</a></div><div class="ttdeci">boxes</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04658">molecule.py:4658</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a1b0681641dfbba1c2d182151b5e60f5d"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a1b0681641dfbba1c2d182151b5e60f5d">src.molecule.Molecule.read_qcschema</a></div><div class="ttdeci">def read_qcschema(self, schema, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02933">molecule.py:2933</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a081f51f922805fee2d219661d7d31743"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a081f51f922805fee2d219661d7d31743">src.molecule.format_gro_coord</a></div><div class="ttdeci">def format_gro_coord(resid, resname, aname, seqno, xyz)</div><div class="ttdoc">Print a line in accordance with .gro file format, with six decimal points of precision. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00577">molecule.py:577</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a7b85106cd6cc8e1d3e7e1ccb4edff551"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a7b85106cd6cc8e1d3e7e1ccb4edff551">src.molecule.Molecule.write_lammps_data</a></div><div class="ttdeci">def write_lammps_data(self, selection, kwargs)</div><div class="ttdoc">Write the first frame of the selection to a LAMMPS data file for the purpose of automatically initial...</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04245">molecule.py:4245</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a3d07eb6fe9de1d679c82213a4d7e988d"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a3d07eb6fe9de1d679c82213a4d7e988d">src.molecule.grouper</a></div><div class="ttdeci">def grouper(n, iterable)</div><div class="ttdoc">Groups a big long iterable into groups of ten or what have you. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00661">molecule.py:661</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a17d81a43f4f28d4db24d6548dc7018dd"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a17d81a43f4f28d4db24d6548dc7018dd">src.molecule.is_charmm_coord</a></div><div class="ttdeci">def is_charmm_coord(line)</div><div class="ttdoc">Determines whether a line contains CHARMM data or not. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00625">molecule.py:625</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a06d6ebbb45f759c58b30f6c7c084c3e5"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a06d6ebbb45f759c58b30f6c7c084c3e5">src.molecule.Molecule.atom_stack</a></div><div class="ttdeci">def atom_stack(self, other)</div><div class="ttdoc">Return a copy of the object with another molecule object appended. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01905">molecule.py:1905</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a42c302c3f922e6f89862f2e5d39514a6"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a42c302c3f922e6f89862f2e5d39514a6">src.molecule.Molecule.align_center</a></div><div class="ttdeci">def align_center(self)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02854">molecule.py:2854</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a9de48d83dc7f53e25b86a4a6076e3185"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a9de48d83dc7f53e25b86a4a6076e3185">src.molecule.diff</a></div><div class="ttdeci">def diff(A, B, key)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l00688">molecule.py:688</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aa7a40df32ff22ef52b902ac6a24dcb50"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aa7a40df32ff22ef52b902ac6a24dcb50">src.molecule.Molecule.read_mdcrd</a></div><div class="ttdeci">def read_mdcrd(self, fnm, kwargs)</div><div class="ttdoc">Parse an AMBER .mdcrd file. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l03031">molecule.py:3031</a></div></div>
<div class="ttc" id="namespacesrc_1_1molecule_html_a593b80c51a439f35789c16ad5fbcbfec"><div class="ttname"><a href="namespacesrc_1_1molecule.html#a593b80c51a439f35789c16ad5fbcbfec">src.molecule.form_rot</a></div><div class="ttdeci">def form_rot(q)</div><div class="ttdoc">Given a quaternion p, form a rotation matrix from it. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01093">molecule.py:1093</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a840f24f26e96c001cd36b254c402e481"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a840f24f26e96c001cd36b254c402e481">src.molecule.Molecule.resid</a></div><div class="ttdeci">resid</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04599">molecule.py:4599</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a5c04a001643a8165de635697f2d418f3"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a5c04a001643a8165de635697f2d418f3">src.molecule.Molecule.write_arc</a></div><div class="ttdeci">def write_arc(self, selection, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l04355">molecule.py:4355</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a4b84ec657b8c89c34674bb205f7eb1b2"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a4b84ec657b8c89c34674bb205f7eb1b2">src.molecule.Molecule.read_xyz0</a></div><div class="ttdeci">def read_xyz0(self, fnm, kwargs)</div><div class="ttdoc">Parse a .xyz file which contains several xyz coordinates, and return their elements. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l02967">molecule.py:2967</a></div></div>
<div class="ttc" id="namespacesrc_1_1chemistry_html_ab523d2adfa843021628d784c390fb46f"><div class="ttname"><a href="namespacesrc_1_1chemistry.html#ab523d2adfa843021628d784c390fb46f">src.chemistry.L</a></div><div class="ttdeci">float L</div><div class="ttdef"><b>Definition:</b> <a href="chemistry_8py_source.html#l00152">chemistry.py:152</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_a16dcb06bf37392ef659cc156e0b61688"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#a16dcb06bf37392ef659cc156e0b61688">src.molecule.Molecule.reorder_according_to</a></div><div class="ttdeci">def reorder_according_to(self, other)</div><div class="ttdoc">Reorder atoms according to some other Molecule object. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01621">molecule.py:1621</a></div></div>
<div class="ttc" id="classsrc_1_1molecule_1_1Molecule_html_aaf70e66c397fd1e77644339ec81dfa9e"><div class="ttname"><a href="classsrc_1_1molecule_1_1Molecule.html#aaf70e66c397fd1e77644339ec81dfa9e">src.molecule.Molecule.repair</a></div><div class="ttdeci">def repair(self, key, klast)</div><div class="ttdoc">Attempt to repair trivial issues that would otherwise break the object. </div><div class="ttdef"><b>Definition:</b> <a href="molecule_8py_source.html#l01586">molecule.py:1586</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Jul 9 2020 11:40:31 for ForceBalance API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
